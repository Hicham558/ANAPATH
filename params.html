<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Param√®tres - ANAPATH</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    
    .nav-animated { animation: slideIn 0.6s ease-out; }
    .card-animated { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
    .card-animated:nth-child(1) { animation-delay: 0.1s; }
    .card-animated:nth-child(2) { animation-delay: 0.2s; }
    .card-animated:nth-child(3) { animation-delay: 0.3s; }
    .card-animated:nth-child(4) { animation-delay: 0.4s; }
    .card-animated:nth-child(5) { animation-delay: 0.5s; }
    .card-animated:nth-child(6) { animation-delay: 0.6s; }
    
    .icon-button { width: 80px; height: 80px; display: flex; justify-content: center; align-items: center; border-radius: 50%; transition: all 0.3s ease; animation: pulse 2s infinite ease-in-out; }
    @media (min-width: 768px) { .icon-button { width: 96px; height: 96px; } }
    .icon-button:hover { transform: scale(1.1) translateY(-4px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); }
    .kpi-card { transition: all 0.4s ease; }
    .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1); }
    
    @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.9) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    #certModal > div, #qrModal > div, #restoreModal > div { animation: modalFadeIn 0.3s ease-out; }
    #certModal ol li { transition: all 0.2s ease; }
    #certModal ol li:hover { transform: translateX(5px); background-color: rgba(79, 70, 229, 0.05); padding-left: 8px; border-radius: 8px; }
    #qrCodeContainer { display: flex; justify-content: center; align-items: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    #dropZone { border: 2px dashed #cbd5e0; transition: all 0.3s ease; }
    #dropZone.drag-over { border-color: #4f46e5; background-color: #eef2ff; }
  </style>
</head>
<body class="bg-gray-100">

  <nav class="bg-indigo-600 text-white p-4 fixed w-full top-0 z-10 shadow-md nav-animated">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex flex-col">
        <h1 class="text-2xl font-bold flex items-center">
          <i class="fas fa-microscope mr-2 text-blue-300 animate-pulse"></i> ANAPATH Param√®tres
        </h1>
        <span id="userDisplay" class="text-xs mt-1 hidden text-indigo-100"></span>
      </div>
      <div class="flex gap-2 items-center">
        <a href="index.html" class="hover:text-indigo-200 transition flex items-center">
          <i class="fas fa-home mr-1"></i>
        </a>
        <button id="logoutButton" onclick="logout()" class="bg-red-500 px-3 py-2 rounded-md hover:bg-red-600 transition">
          <i class="fas fa-sign-out-alt mr-1"></i>D√©connexion
        </button>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-16 mt-16">
    <!-- Configuration API -->
    <div class="kpi-card bg-white shadow-xl rounded-2xl p-6 mb-6 card-animated">
      <h3 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">
        <i class="fas fa-server mr-2 text-indigo-600"></i> Configuration API
      </h3>
      <div class="space-y-4">
        
        <div class="grid grid-cols-2 md:flex md:justify-center gap-3 md:gap-4 mb-6">
          <button onclick="generateQrCodeFromLocalIP()" class="bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 transition-all duration-300 flex items-center justify-center shadow-md hover:shadow-lg" title="G√©n√©rer QR code avec IP locale">
            <i class="fas fa-qrcode mr-2 text-lg md:text-xl"></i>
            <span class="font-medium text-sm md:text-base">QR IP Locale</span>
          </button>
          
          <button onclick="openApiUrlInBrowser()" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 flex items-center justify-center shadow-md hover:shadow-lg" title="Ouvrir l'URL dans le navigateur">
            <i class="fas fa-external-link-alt mr-2 text-lg md:text-xl"></i>
            <span class="font-medium text-sm md:text-base">Ouvrir URL</span>
          </button>
          
          <button onclick="scanQrCode()" class="bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition-all duration-300 flex items-center justify-center shadow-md hover:shadow-lg" title="Scanner un QR code">
            <i class="fas fa-camera mr-2 text-lg md:text-xl"></i>
            <span class="font-medium text-sm md:text-base">Scanner QR</span>
          </button>
          
          <button onclick="testConnection()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-all duration-300 flex items-center justify-center shadow-md hover:shadow-lg" title="Tester la connexion">
            <i class="fas fa-plug mr-2 text-lg md:text-xl"></i>
            <span class="font-medium text-sm md:text-base">Tester</span>
          </button>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">URL de l'API</label>
          <input id="apiBaseUrl" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="https://anapath.onrender.com">
        </div>
        
        <div class="flex flex-wrap justify-center gap-4 md:gap-6 mt-6">
          <div class="flex flex-col items-center">
            <button onclick="setLocalMode()" class="icon-button bg-gradient-to-r from-gray-600 to-gray-700 text-white hover:from-gray-700 hover:to-gray-800">
              <i class="fas fa-mobile text-3xl md:text-4xl"></i>
            </button>
            <span class="mt-2 text-xs md:text-sm font-medium text-gray-700">Mode Local</span>
          </div>
          
          <div class="flex flex-col items-center">
            <button onclick="setCloudMode()" class="icon-button bg-gradient-to-r from-blue-600 to-blue-700 text-white hover:from-blue-700 hover:to-blue-800">
              <i class="fas fa-cloud text-3xl md:text-4xl"></i>
            </button>
            <span class="mt-2 text-xs md:text-sm font-medium text-gray-700">Supabase Cloud</span>
          </div>
          
          <div class="flex flex-col items-center">
            <button onclick="setServerMode()" class="icon-button bg-gradient-to-r from-purple-600 to-purple-700 text-white hover:from-purple-700 hover:to-purple-800">
              <i class="fas fa-server text-3xl md:text-4xl"></i>
            </button>
            <span class="mt-2 text-xs md:text-sm font-medium text-gray-700">Serveur Local</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ NOUVELLE SECTION: Sauvegarde et Restauration -->
    <div class="kpi-card bg-white shadow-xl rounded-2xl p-6 mb-6 card-animated">
      <h3 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">
        <i class="fas fa-database mr-2 text-green-600"></i> Sauvegarde et Restauration
      </h3>
      
      <div class="space-y-4">
        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg">
          <div class="flex items-start">
            <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-3"></i>
            <div>
              <p class="text-sm font-medium text-yellow-800">Important</p>
              <p class="text-xs text-yellow-700 mt-1">
                <strong>Sauvegardez vos donn√©es avant de changer d'URL API.</strong><br>
                Lors du passage Cloud ‚Üí Local, vous pourrez restaurer votre sauvegarde pour r√©cup√©rer vos donn√©es.
              </p>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button onclick="createBackup()" class="bg-green-600 text-white px-6 py-4 rounded-lg hover:bg-green-700 transition-all duration-300 flex items-center justify-center shadow-md hover:shadow-lg">
            <i class="fas fa-download mr-3 text-xl"></i>
            <div class="text-left">
              <div class="font-bold">Sauvegarder</div>
              <div class="text-xs opacity-90">T√©l√©charger mes donn√©es</div>
            </div>
          </button>

          <button onclick="openRestoreModal()" class="bg-blue-600 text-white px-6 py-4 rounded-lg hover:bg-blue-700 transition-all duration-300 flex items-center justify-center shadow-md hover:shadow-lg">
            <i class="fas fa-upload mr-3 text-xl"></i>
            <div class="text-left">
              <div class="font-bold">Restaurer</div>
              <div class="text-xs opacity-90">Importer une sauvegarde</div>
            </div>
          </button>
        </div>

        <div id="backupStatus" class="hidden mt-4">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center">
              <i class="fas fa-spinner fa-spin text-blue-600 mr-3"></i>
              <span class="text-sm text-blue-800" id="backupStatusText">Op√©ration en cours...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Informations Laboratoire -->
    <div class="kpi-card bg-white shadow-xl rounded-2xl p-6 mb-6 card-animated">
      <h3 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">
        <i class="fas fa-hospital mr-2 text-indigo-600"></i> Informations Laboratoire
      </h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Nom du Laboratoire</label>
          <input id="labName" type="text" value="ANAPATH ELYOUSR" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">M√©decin Responsable</label>
          <input id="labDoctor" type="text" value="Dr. BENFOULA Amel √©pouse ERROUANE" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Adresse</label>
          <input id="labAddress" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">T√©l√©phone</label>
            <input id="labPhone" type="tel" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
            <input id="labEmail" type="email" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Logo du Laboratoire</label>
          <input id="labLogo" type="file" accept="image/*" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg">
          <img id="logoPreview" class="mt-3 max-w-[200px] rounded-lg shadow-md hidden" alt="Logo">
        </div>
      </div>
    </div>

    <!-- Pr√©f√©rences d'Impression -->
    <div class="kpi-card bg-white shadow-xl rounded-2xl p-6 mb-6 card-animated">
      <h3 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">
        <i class="fas fa-print mr-2 text-indigo-600"></i> Pr√©f√©rences d'Impression
      </h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Format Papier</label>
          <select id="printFormat" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
            <option value="A4">A4</option>
            <option value="Letter">Letter</option>
          </select>
        </div>
        <div class="flex items-center">
          <input id="printLogo" type="checkbox" checked class="w-5 h-5 text-indigo-600 border-gray-300 rounded">
          <label for="printLogo" class="ml-3 text-sm font-medium text-gray-700">Inclure le logo</label>
        </div>
        <div class="flex items-center">
          <input id="printWatermark" type="checkbox" class="w-5 h-5 text-indigo-600 border-gray-300 rounded">
          <label for="printWatermark" class="ml-3 text-sm font-medium text-gray-700">Filigrane "CONFIDENTIEL"</label>
        </div>
      </div>
    </div>

    <!-- Classifications -->
    <div class="kpi-card bg-white shadow-xl rounded-2xl p-6 mb-6 card-animated">
      <h3 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">
        <i class="fas fa-list-ul mr-2 text-indigo-600"></i> Classifications Pr√©-d√©finies
      </h3>
      <div class="space-y-3">
        <div class="p-3 bg-gray-50 rounded-lg">
          <h4 class="font-medium mb-2">Classification BETHESDA 2017</h4>
          <div class="text-sm text-gray-600">
            <p>‚Ä¢ Cat√©gorie I - Non diagnostique</p>
            <p>‚Ä¢ Cat√©gorie II - B√©nin</p>
            <p>‚Ä¢ Cat√©gorie III - Atypie de signification ind√©termin√©e</p>
            <p>‚Ä¢ Cat√©gorie IV - N√©oplasme folliculaire</p>
            <p>‚Ä¢ Cat√©gorie V - Suspect de malignit√©</p>
            <p>‚Ä¢ Cat√©gorie VI - Malin</p>
          </div>
        </div>
      </div>
    </div>

    <div class="flex justify-end gap-3">
      <button onclick="resetSettings()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600">
        <i class="fas fa-undo mr-2"></i>R√©initialiser
      </button>
      <button onclick="saveSettings()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700">
        <i class="fas fa-save mr-2"></i>Enregistrer
      </button>
    </div>
  </main>

  <!-- Toast notification -->
  <div id="toast" class="fixed bottom-4 right-4 hidden z-50">
    <div class="flex items-center px-6 py-3 rounded-md shadow-lg">
      <i id="toastIcon" class="mr-2"></i>
      <span id="toastMessage"></span>
    </div>
  </div>

  <!-- Modal QR Code -->
  <div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-lg mx-4 shadow-2xl">
      <div class="text-center">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-gray-800">QR Code de Connexion</h3>
          <button onclick="closeQrModal()" class="text-gray-500 hover:text-gray-700 transition">
            <i class="fas fa-times text-2xl"></i>
          </button>
        </div>
        
        <div id="qrCodeContainer" class="mb-6"></div>
        
        <div class="bg-indigo-50 p-4 rounded-lg mb-4">
          <p class="text-sm font-medium text-indigo-900 mb-2">URL du serveur :</p>
          <p id="qrUrlDisplay" class="text-lg font-mono text-indigo-700 break-all"></p>
        </div>
        
        <div class="text-left text-sm text-gray-600 bg-gray-50 p-4 rounded-lg space-y-2">
          <p class="font-semibold text-gray-800 mb-3">üì± Pour vous connecter depuis votre mobile :</p>
          <ol class="space-y-2 ml-4">
            <li class="flex items-start">
              <span class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 flex-shrink-0 text-xs font-bold">1</span>
              <span>Ouvrez l'application ANAPATH sur votre mobile</span>
            </li>
            <li class="flex items-start">
              <span class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 flex-shrink-0 text-xs font-bold">2</span>
              <span>Scannez ce QR code avec la cam√©ra de votre t√©l√©phone</span>
            </li>
            <li class="flex items-start">
              <span class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 flex-shrink-0 text-xs font-bold">3</span>
              <span>Acceptez le certificat si demand√© (cliquez sur "Avanc√©" puis "Continuer")</span>
            </li>
          </ol>
        </div>
        
        <div class="flex gap-3 mt-6">
          <button onclick="downloadQrCode()" class="flex-1 bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition shadow-md hover:shadow-lg">
            <i class="fas fa-download mr-2"></i>T√©l√©charger
          </button>
          <button onclick="closeQrModal()" class="flex-1 bg-gray-500 text-white px-4 py-3 rounded-lg hover:bg-gray-600 transition shadow-md hover:shadow-lg">
            <i class="fas fa-times mr-2"></i>Fermer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour accepter le certificat -->
  <div id="certModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl">
      <div class="text-center">
        <i class="fas fa-shield-alt text-6xl text-yellow-500 mb-4 animate-pulse"></i>
        <h3 class="text-2xl font-bold mb-4 text-gray-800">Accepter le certificat</h3>
        <p class="text-gray-600 mb-4">Pour connecter votre mobile au serveur local :</p>
        <ol class="text-left text-sm text-gray-700 space-y-3 mb-6 bg-gray-50 p-4 rounded-lg">
          <li class="flex items-start">
            <span class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 flex-shrink-0 font-bold">1</span>
            <span>Cliquez sur <strong>"Ouvrir"</strong> ci-dessous</span>
          </li>
          <li class="flex items-start">
            <span class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 flex-shrink-0 font-bold">2</span>
            <span>Dans la nouvelle page, cliquez sur <strong class="text-indigo-600">"Avanc√©"</strong> ou <strong class="text-indigo-600">"Advanced"</strong></span>
          </li>
          <li class="flex items-start">
            <span class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 flex-shrink-0 font-bold">3</span>
            <span>Puis sur <strong class="text-indigo-600">"Continuer vers le site"</strong> ou <strong class="text-indigo-600">"Proceed to..."</strong></span>
          </li>
          <li class="flex items-start">
            <span class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 flex-shrink-0 font-bold">‚úì</span>
            <span>Fermez l'onglet et utilisez l'application normalement</span>
          </li>
        </ol>
        <div class="flex gap-3">
          <button onclick="closeModal()" class="flex-1 bg-gray-500 text-white px-4 py-3 rounded-lg hover:bg-gray-600 transition-all duration-300 shadow-md hover:shadow-lg">
            <i class="fas fa-times mr-2"></i>Annuler
          </button>
          <button onclick="confirmOpenUrl()" class="flex-1 bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition-all duration-300 shadow-md hover:shadow-lg">
            <i class="fas fa-external-link-alt mr-2"></i>Ouvrir
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Modal Restauration -->
  <div id="restoreModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-xl w-full mx-4 shadow-2xl">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800">
          <i class="fas fa-upload mr-2 text-blue-600"></i>
          Restaurer une sauvegarde
        </h3>
        <button onclick="closeRestoreModal()" class="text-gray-500 hover:text-gray-700 transition">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>

      <div class="space-y-4">
        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
          <div class="flex items-start">
            <i class="fas fa-exclamation-triangle text-red-600 mt-1 mr-3"></i>
            <div>
              <p class="text-sm font-medium text-red-800">‚ö†Ô∏è Attention</p>
              <p class="text-xs text-red-700 mt-1">
                Cette action va <strong>remplacer toutes vos donn√©es actuelles</strong> par celles de la sauvegarde.
                Cette op√©ration est <strong>irr√©versible</strong>.
              </p>
            </div>
          </div>
        </div>

        <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-indigo-500 transition">
          <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-4"></i>
          <p class="text-gray-600 mb-2">Glissez votre fichier .sql ici</p>
          <p class="text-sm text-gray-500 mb-4">ou</p>
          <button onclick="document.getElementById('sqlFileInput').click()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">
            <i class="fas fa-folder-open mr-2"></i>Parcourir
          </button>
          <input type="file" id="sqlFileInput" accept=".sql" class="hidden">
        </div>

        <div id="selectedFileInfo" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <i class="fas fa-file-code text-green-600 text-2xl mr-3"></i>
              <div>
                <p class="font-semibold text-green-800" id="selectedFileName"></p>
                <p class="text-sm text-green-600" id="selectedFileSize"></p>
              </div>
            </div>
            <button onclick="clearSelectedFile()" class="text-red-600 hover:text-red-800">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="mt-6 flex gap-3">
        <button onclick="closeRestoreModal()" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition">
          <i class="fas fa-times mr-2"></i>Annuler
        </button>
        <button onclick="executeRestore()" id="restoreBtn" disabled class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed">
          <i class="fas fa-upload mr-2"></i>Restaurer
        </button>
      </div>
    </div>
  </div>

 <script>
    const DEFAULT_API = 'https://anapath.onrender.com';
    let pendingUrl = null;
    let stream = null;
    let currentQrCode = null;
    let selectedSqlFile = null;
    let dropZoneInitialized = false;

    // ================================================
    // FONCTIONS BACKUP/RESTORE
    // ================================================
    
    async function createBackup() {
      const apiUrl = document.getElementById('apiBaseUrl').value || DEFAULT_API;
      const userId = localStorage.getItem('userId');
      
      if (!userId) {
        showToast('Utilisateur non connect√©', true);
        return;
      }

      const statusDiv = document.getElementById('backupStatus');
      const statusText = document.getElementById('backupStatusText');
      statusDiv.classList.remove('hidden');
      statusText.textContent = 'Cr√©ation de la sauvegarde en cours...';

      try {
        const response = await fetch(`${apiUrl}/api/database/backup`, {
          method: 'POST',
          headers: {
            'X-User-ID': userId,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.erreur || `Erreur ${response.status}`);
        }

        const data = await response.json();

        const sqlContent = atob(data.sql_base64);
        const blob = new Blob([sqlContent], { type: 'application/sql' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = data.filename;
        a.click();
        URL.revokeObjectURL(url);

        statusText.textContent = `‚úÖ Sauvegarde cr√©√©e: ${data.filename} (${(data.size / 1024).toFixed(1)} KB)`;
        showToast(`Sauvegarde t√©l√©charg√©e: ${data.filename}`);

        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 3000);

      } catch (error) {
        console.error('Erreur backup:', error);
        statusText.textContent = '‚ùå Erreur lors de la cr√©ation';
        showToast(`Erreur: ${error.message}`, true);
        
        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 3000);
      }
    }

    function openRestoreModal() {
      document.getElementById('restoreModal').classList.remove('hidden');
      
      if (!dropZoneInitialized) {
        setupDropZone();
        dropZoneInitialized = true;
      }
    }

    function closeRestoreModal() {
      document.getElementById('restoreModal').classList.add('hidden');
      clearSelectedFile();
    }

  function setupDropZone() {
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('sqlFileInput');

  if (!dropZone || !fileInput) {
    console.error('√âl√©ments dropZone ou fileInput non trouv√©s');
    return;
  }

  dropZone.ondragover = (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.add('drag-over');
  };

  dropZone.ondragleave = (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.remove('drag-over');
  };

  dropZone.ondrop = (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    console.log('Fichiers d√©pos√©s:', files);
    
    if (files.length > 0) {
      handleFileSelect(files[0]);
    }
  };

  fileInput.onchange = (e) => {
    console.log('Fichier s√©lectionn√© via input:', e.target.files);
    if (e.target.files.length > 0) {
      handleFileSelect(e.target.files[0]);
    }
  };

  dropZoneInitialized = true;
  console.log('Drop zone initialis√©e');
}
  function handleFileSelect(file) {
  console.log('Fichier s√©lectionn√©:', file.name, 'taille:', file.size);
  
  // V√©rification du type de fichier
  if (!file.name.toLowerCase().endsWith('.sql')) {
    showToast('‚ùå Veuillez s√©lectionner un fichier .sql', true);
    return;
  }
  
  // V√©rification de la taille
  if (file.size > 10 * 1024 * 1024) {
    showToast('‚ùå Fichier trop volumineux (max 10MB)', true);
    return;
  }
  
  if (file.size === 0) {
    showToast('‚ùå Fichier vide', true);
    return;
  }
  
  selectedSqlFile = file;
  
  // Mettre √† jour l'interface
  document.getElementById('selectedFileName').textContent = file.name;
  document.getElementById('selectedFileSize').textContent = `${(file.size / 1024).toFixed(1)} KB`;
  document.getElementById('selectedFileInfo').classList.remove('hidden');
  document.getElementById('restoreBtn').disabled = false;
  
  console.log('Fichier enregistr√© dans selectedSqlFile:', selectedSqlFile);
}

// Fonction clearSelectedFile corrig√©e
function clearSelectedFile() {
  console.log('clearSelectedFile appel√©e');
  
  selectedSqlFile = null;
  document.getElementById('selectedFileInfo').classList.add('hidden');
  document.getElementById('restoreBtn').disabled = true;
  document.getElementById('sqlFileInput').value = '';
  
  // R√©initialiser aussi la zone de drop
  const dropZone = document.getElementById('dropZone');
  if (dropZone) {
    dropZone.classList.remove('drag-over');
  }
  
  console.log('Fichier r√©initialis√©, selectedSqlFile:', selectedSqlFile);
}


    async function executeRestore() {
  // V√©rification approfondie avant de proc√©der
  console.log('executeRestore appel√©e, selectedSqlFile:', selectedSqlFile);
  
  if (!selectedSqlFile || selectedSqlFile === null || selectedSqlFile === undefined) {
    showToast('‚ùå Aucun fichier s√©lectionn√©', true);
    
    // R√©initialiser l'interface pour √©viter toute confusion
    clearSelectedFile();
    document.getElementById('restoreBtn').disabled = true;
    
    return;
  }

  // V√©rifier que c'est bien un fichier .sql
  if (!selectedSqlFile.name.toLowerCase().endsWith('.sql')) {
    showToast('‚ùå Le fichier doit √™tre un fichier .sql', true);
    clearSelectedFile();
    return;
  }

  // V√©rifier la taille du fichier (limite √† 10MB pour √©viter les probl√®mes)
  if (selectedSqlFile.size > 10 * 1024 * 1024) {
    showToast('‚ùå Fichier trop volumineux (max 10MB)', true);
    clearSelectedFile();
    return;
  }

  // Confirmation finale
  if (!confirm('‚ö†Ô∏è CONFIRMATION REQUISE\n\n√ätes-vous absolument certain de vouloir restaurer cette sauvegarde ?\n\nToutes vos donn√©es actuelles seront D√âFINITIVEMENT REMPLAC√âES.\n\nCette action est IRR√âVERSIBLE.')) {
    return;
  }

  const apiUrl = document.getElementById('apiBaseUrl').value || DEFAULT_API;
  const userId = localStorage.getItem('userId');

  if (!userId) {
    showToast('‚ùå Utilisateur non connect√©', true);
    return;
  }

  const statusDiv = document.getElementById('backupStatus');
  const statusText = document.getElementById('backupStatusText');
  statusDiv.classList.remove('hidden');
  statusText.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Restauration en cours...';

  closeRestoreModal();

  try {
    // Lire le contenu du fichier
    console.log('Lecture du fichier:', selectedSqlFile.name, 'taille:', selectedSqlFile.size);
    
    const sqlContent = await readFileAsText(selectedSqlFile);
    console.log('Contenu SQL lu, longueur:', sqlContent.length, 'premiers caract√®res:', sqlContent.substring(0, 100));
    
    if (!sqlContent || sqlContent.trim().length === 0) {
      throw new Error('Le fichier est vide');
    }

    // V√©rifier que c'est bien un fichier SQL (contient des mots-cl√©s SQL)
    if (!isValidSqlContent(sqlContent)) {
      throw new Error('Le fichier ne semble pas √™tre un fichier SQL valide');
    }

    // Encoder en base64
    const sqlBase64 = btoa(unescape(encodeURIComponent(sqlContent)));
    
    console.log('Envoi de la requ√™te √†:', `${apiUrl}/api/database/restore`);
    
    // Envoyer la requ√™te au serveur
    const response = await fetch(`${apiUrl}/api/database/restore`, {
      method: 'POST',
      headers: {
        'X-User-ID': userId,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        sql_content: sqlBase64,
        filename: selectedSqlFile.name
      })
    });

    console.log('R√©ponse re√ßue, statut:', response.status);

    if (!response.ok) {
      let errorMessage = `Erreur ${response.status}`;
      try {
        const errorData = await response.json();
        errorMessage = errorData.erreur || errorData.message || errorMessage;
      } catch (e) {
        // Si la r√©ponse n'est pas du JSON, lire le texte
        const text = await response.text();
        if (text) errorMessage = text.substring(0, 100);
      }
      throw new Error(errorMessage);
    }

    const data = await response.json();
    
    statusText.innerHTML = '<i class="fas fa-check-circle mr-2 text-green-600"></i> ‚úÖ Base de donn√©es restaur√©e avec succ√®s';
    showToast('‚úÖ Restauration r√©ussie !');

    // R√©initialiser apr√®s succ√®s
    clearSelectedFile();
    
    setTimeout(() => {
      statusDiv.classList.add('hidden');
      if (confirm('‚úÖ Restauration termin√©e avec succ√®s !\n\nVoulez-vous recharger la page pour voir les modifications ?')) {
        window.location.reload();
      }
    }, 3000);

  } catch (error) {
    console.error('Erreur restauration:', error);
    
    // Message d'erreur plus clair
    let errorMessage = error.message;
    if (errorMessage.includes('Failed to fetch')) {
      errorMessage = 'Impossible de se connecter au serveur. V√©rifiez l\'URL API.';
    } else if (errorMessage.includes('Network Error')) {
      errorMessage = 'Erreur r√©seau. V√©rifiez votre connexion internet.';
    }
    
    statusText.innerHTML = `<i class="fas fa-exclamation-triangle mr-2 text-red-600"></i> ‚ùå Erreur: ${errorMessage}`;
    showToast(`‚ùå Erreur: ${errorMessage}`, true);
    
    setTimeout(() => {
      statusDiv.classList.add('hidden');
    }, 5000);
  }
}
// Fonction pour lire un fichier comme texte
function readFileAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (event) => {
      resolve(event.target.result);
    };
    
    reader.onerror = (event) => {
      reject(new Error('Erreur lors de la lecture du fichier'));
    };
    
    reader.readAsText(file);
  });
}

// Fonction pour valider le contenu SQL
function isValidSqlContent(content) {
  const sqlKeywords = [
    'CREATE TABLE', 'INSERT INTO', 'DROP TABLE', 'ALTER TABLE',
    'SELECT', 'UPDATE', 'DELETE', 'VALUES',
    'PRIMARY KEY', 'FOREIGN KEY', 'REFERENCES'
  ];
  
  const contentUpper = content.toUpperCase();
  
  // V√©rifier si au moins un mot-cl√© SQL est pr√©sent
  for (const keyword of sqlKeywords) {
    if (contentUpper.includes(keyword)) {
      return true;
    }
  }
  
  return false;
}

    // ================================================
    // FONCTIONS QR CODE & CONFIGURATION
    // ================================================
    
    async function getLocalIPAddress() {
      return new Promise((resolve, reject) => {
        const pc = new RTCPeerConnection({
          iceServers: []
        });
        
        pc.createDataChannel('');
        pc.createOffer().then(offer => pc.setLocalDescription(offer));
        
        pc.onicecandidate = (ice) => {
          if (!ice || !ice.candidate || !ice.candidate.candidate) {
            return;
          }
          
          const ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/;
          const match = ipRegex.exec(ice.candidate.candidate);
          
          if (match) {
            const ip = match[1];
            if (!ip.startsWith('127.')) {
              pc.close();
              resolve(ip);
            }
          }
        };
        
        setTimeout(() => {
          pc.close();
          reject(new Error('Impossible de d√©tecter l\'IP locale'));
        }, 3000);
      });
    }

    async function generateQrCodeFromLocalIP() {
      showToast('üîç D√©tection de l\'IP locale...', false);
      
      try {
        const localIP = await getLocalIPAddress();
        const port = prompt('Port du serveur local ?', '5000');
        
        if (!port) {
          showToast('Port requis pour g√©n√©rer le QR code', true);
          return;
        }
        
        const localUrl = `https://${localIP}:${port}`;
        
        document.getElementById('apiBaseUrl').value = localUrl;
        saveSettings();
        
        generateQrCodeWithUrl(localUrl);
        
        showToast(`‚úÖ IP d√©tect√©e: ${localIP}`, false);
        
      } catch (error) {
        console.error('Erreur d√©tection IP:', error);
        showToast('‚ùå Impossible de d√©tecter l\'IP locale. Utilisez le mode manuel.', true);
        
        const manualIP = prompt('Entrez l\'IP locale manuellement (ex: 192.168.1.135)');
        if (manualIP) {
          const port = prompt('Port du serveur ?', '5000');
          if (port) {
            const localUrl = `https://${manualIP}:${port}`;
            document.getElementById('apiBaseUrl').value = localUrl;
            saveSettings();
            generateQrCodeWithUrl(localUrl);
          }
        }
      }
    }

    function generateQrCodeWithUrl(url) {
      const container = document.getElementById('qrCodeContainer');
      container.innerHTML = '';
      
      document.getElementById('qrModal').classList.remove('hidden');
      document.getElementById('qrUrlDisplay').textContent = url;
      
      try {
        currentQrCode = new QRCode(container, {
          text: url,
          width: 256,
          height: 256,
          colorDark: "#4F46E5",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
        
        showToast('QR Code g√©n√©r√© avec succ√®s');
        console.log('QR Code g√©n√©r√© pour:', url);
        
      } catch (error) {
        showToast('Erreur lors de la g√©n√©ration du QR code', true);
        console.error('Erreur QR code:', error);
        closeQrModal();
      }
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toastIcon');
      const msg = document.getElementById('toastMessage');
      
      const container = toast.querySelector('div');
      container.className = `flex items-center px-6 py-3 rounded-md shadow-lg ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
      icon.className = `fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2`;
      msg.textContent = message;
      
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function downloadQrCode() {
      const container = document.getElementById('qrCodeContainer');
      const canvas = container.querySelector('canvas');
      
      if (canvas) {
        const url = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = 'anapath-qrcode.png';
        link.href = url;
        link.click();
        showToast('QR Code t√©l√©charg√©');
      } else {
        showToast('Erreur: QR Code non trouv√©', true);
      }
    }

    function closeQrModal() {
      document.getElementById('qrModal').classList.add('hidden');
      const container = document.getElementById('qrCodeContainer');
      container.innerHTML = '';
      currentQrCode = null;
    }

    function openApiUrlInBrowser() {
      const apiBaseUrlInput = document.getElementById('apiBaseUrl');
      const apiUrl = apiBaseUrlInput.value.trim();
      
      if (!apiUrl) {
        showToast('Veuillez saisir une URL valide', true);
        return;
      }
      
      try {
        const url = new URL(apiUrl);
        
        if (url.protocol === 'https:' && 
            (url.hostname.startsWith('192.168.') || 
             url.hostname.startsWith('10.') || 
             url.hostname.startsWith('172.') ||
             url.hostname === 'localhost' ||
             url.port === '5000')) {
          pendingUrl = url.toString();
          document.getElementById('certModal').classList.remove('hidden');
        } else {
          window.open(url.toString(), '_blank', 'noopener,noreferrer');
          showToast(`Ouverture de ${apiUrl}`);
        }
        
        console.log('URL pr√©par√©e:', apiUrl);
        
      } catch (error) {
        showToast('URL invalide. Format attendu: https://192.168.1.135:5000', true);
        console.error('URL invalide:', apiUrl, error);
      }
    }

    function closeModal() {
      document.getElementById('certModal').classList.add('hidden');
      pendingUrl = null;
    }

    function confirmOpenUrl() {
      if (pendingUrl) {
        window.open(pendingUrl, '_blank', 'noopener,noreferrer');
        showToast('‚úÖ Suivez les 4 √©tapes dans le nouvel onglet');
        
        setTimeout(() => {
          showToast('üí° Apr√®s avoir accept√© le certificat, fermez l\'onglet', false);
        }, 3000);
        
        closeModal();
      }
    }

    async function scanQrCode() {
      if (!('BarcodeDetector' in window)) {
        showToast('Le scan de QR code n\'est pas pris en charge par ce navigateur', true);
        return;
      }
      
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        
        const cameraModal = document.createElement('div');
        cameraModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
        cameraModal.innerHTML = `
          <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold">Scanner un QR code</h3>
              <button onclick="stopCamera()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
              </button>
            </div>
            <div class="relative">
              <video id="cameraView" class="w-full h-64 object-cover rounded-lg bg-black"></video>
              <div class="absolute inset-0 border-2 border-green-500 rounded-lg pointer-events-none"></div>
            </div>
            <p class="text-center text-sm text-gray-600 mt-4">Pointez la cam√©ra vers un QR code contenant une URL</p>
          </div>
        `;
        
        document.body.appendChild(cameraModal);
        
        const video = document.getElementById('cameraView');
        video.srcObject = stream;
        video.play();
        
        const barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
        
        const scanInterval = setInterval(async () => {
          try {
            const barcodes = await barcodeDetector.detect(video);
            if (barcodes.length > 0) {
              const qrCodeValue = barcodes[0].rawValue;
              
              try {
                const url = new URL(qrCodeValue);
                document.getElementById('apiBaseUrl').value = qrCodeValue;
                saveSettings();
                showToast(`QR code scann√©: ${qrCodeValue}`);
                
                clearInterval(scanInterval);
                stopCamera();
                cameraModal.remove();
                
                if (confirm(`URL d√©tect√©e: ${qrCodeValue}\nVoulez-vous ouvrir cette URL dans un nouvel onglet ?`)) {
                  pendingUrl = qrCodeValue;
                  document.getElementById('certModal').classList.remove('hidden');
                }
              } catch (e) {
                showToast('Le QR code ne contient pas une URL valide', true);
              }
            }
          } catch (error) {
            console.error('Erreur de scan:', error);
          }
        }, 1000);
        
        setTimeout(() => {
          if (stream) {
            clearInterval(scanInterval);
            stopCamera();
            cameraModal.remove();
            showToast('Temps de scan √©coul√©', true);
          }
        }, 30000);
        
      } catch (error) {
        showToast(`Erreur d'acc√®s √† la cam√©ra: ${error.message}`, true);
        console.error('Erreur cam√©ra:', error);
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }

    document.addEventListener('click', function(event) {
      const certModal = document.getElementById('certModal');
      const qrModal = document.getElementById('qrModal');
      const restoreModal = document.getElementById('restoreModal');
      
      if (event.target === certModal) {
        closeModal();
      }
      if (event.target === qrModal) {
        closeQrModal();
      }
      if (event.target === restoreModal) {
        closeRestoreModal();
      }
    });

    function setLocalMode() {
      document.getElementById('apiBaseUrl').value = '/api';
      localStorage.setItem('apiBaseUrl', '/api');
      showToast('Mode local activ√©');
    }

    function setCloudMode() {
      document.getElementById('apiBaseUrl').value = DEFAULT_API;
      localStorage.setItem('apiBaseUrl', DEFAULT_API);
      showToast('Mode cloud activ√©');
    }

    function setServerMode() {
      const serverUrl = prompt('URL serveur local (ex: https://192.168.1.10:5000)');
      if (serverUrl) {
        document.getElementById('apiBaseUrl').value = serverUrl;
        localStorage.setItem('apiBaseUrl', serverUrl);
        showToast('Serveur local configur√©');
        
        if (confirm('Voulez-vous g√©n√©rer un QR code pour cette URL ?')) {
          generateQrCodeWithUrl(serverUrl);
        }
      }
    }

    async function testConnection() {
      const url = document.getElementById('apiBaseUrl').value;
      try {
        const response = await fetch(`${url}/`, { method: 'GET' });
        if (response.ok) {
          showToast('‚úÖ Connexion r√©ussie');
        } else {
          showToast('‚ùå Erreur de connexion', true);
        }
      } catch (error) {
        showToast('‚ùå Impossible de se connecter', true);
      }
    }

    function saveSettings() {
      const settings = {
        apiBaseUrl: document.getElementById('apiBaseUrl').value,
        labName: document.getElementById('labName').value,
        labDoctor: document.getElementById('labDoctor').value,
        labAddress: document.getElementById('labAddress').value,
        labPhone: document.getElementById('labPhone').value,
        labEmail: document.getElementById('labEmail').value,
        printFormat: document.getElementById('printFormat').value,
        printLogo: document.getElementById('printLogo').checked,
        printWatermark: document.getElementById('printWatermark').checked
      };
      
      localStorage.setItem('anapathSettings', JSON.stringify(settings));
      localStorage.setItem('apiBaseUrl', settings.apiBaseUrl);
      showToast('Param√®tres sauvegard√©s');
    }

    function loadSettings() {
      const settings = JSON.parse(localStorage.getItem('anapathSettings') || '{}');
      
      document.getElementById('apiBaseUrl').value = settings.apiBaseUrl || DEFAULT_API;
      document.getElementById('labName').value = settings.labName || 'ANAPATH ELYOUSR';
      document.getElementById('labDoctor').value = settings.labDoctor || 'Dr. BENFOULA Amel √©pouse ERROUANE';
      document.getElementById('labAddress').value = settings.labAddress || '';
      document.getElementById('labPhone').value = settings.labPhone || '';
      document.getElementById('labEmail').value = settings.labEmail || '';
      document.getElementById('printFormat').value = settings.printFormat || 'A4';
      document.getElementById('printLogo').checked = settings.printLogo !== false;
      document.getElementById('printWatermark').checked = settings.printWatermark || false;
    }

    function resetSettings() {
      if (confirm('R√©initialiser tous les param√®tres ?')) {
        localStorage.removeItem('anapathSettings');
        loadSettings();
        showToast('Param√®tres r√©initialis√©s');
      }
    }

    function logout() {
      localStorage.removeItem('userId');
      localStorage.removeItem('userEmail');
      window.location.href = 'index.html';
    }

    document.getElementById('labLogo')?.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = () => {
          const preview = document.getElementById('logoPreview');
          preview.src = reader.result;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('change', () => {
        setTimeout(saveSettings, 300);
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      const userId = localStorage.getItem('userId');
      const userEmail = localStorage.getItem('userEmail');
      
      if (!userId || !userEmail) {
        window.location.href = 'index.html';
        return;
      }
      
      document.getElementById('userDisplay').textContent = userEmail;
      document.getElementById('userDisplay').classList.remove('hidden');
      loadSettings();
    });
  </script>
</body>
</html>
