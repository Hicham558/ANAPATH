<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©ceptions - ANAPATH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   
   <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .kpi-card { transition: all 0.3s ease; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
        }
        
      /* Styles responsive pour les onglets */
@media (max-width: 768px) {
    nav button {
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 60px;
    }
    
    nav button i {
        font-size: 1.2rem;
    }
    
    nav button span {
        font-size: 0.7rem;
        font-weight: 600;
    }
    
    /* Bordure active plus visible sur mobile */
    .tab-active {
        border-bottom-width: 3px;
        background-color: rgba(79, 70, 229, 0.05);
    }
}

@media (min-width: 769px) {
    nav {
        display: flex !important;
        flex-wrap: nowrap;
    }
    
    nav button {
        white-space: nowrap;
    }
}
        
        .payment-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .payment-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .status-comptant { border-left-color: #10b981; }
        .status-a_terme { border-left-color: #f59e0b; }
        .status-paiement_partiel { border-left-color: #3b82f6; }
        
        .badge-espece { background-color: #d1fae5; color: #065f46; }
        .badge-a_terme { background-color: #fef3c7; color: #92400e; }
        .badge-partiel { background-color: #dbeafe; color: #1e40af; }
        
        .solde-positif { color: #10b981; }
        .solde-negatif { color: #ef4444; }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        
        .table-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .drawer-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1);
        }
        
        .drawer-content.open {
            max-height: 2000px;
        }
        
        .filter-active {
            background-color: #4f46e5;
            color: white;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.warning { background: #f59e0b; }
        .toast.show { display: flex; align-items: center; }
        .toast.hide { display: none; }
        /* Ajouter dans la section <style> */
option.text-red-600 {
    color: #dc2626 !important;
    font-weight: 600;
}

option.text-green-600 {
    color: #059669 !important;
    font-weight: 600;
}

option.text-gray-600 {
    color: #4b5563 !important;
}

/* Pour l'affichage du solde dans le combobox */
select option {
    padding: 8px;
    border-bottom: 1px solid #f1f5f9;
}

select option:hover {
    background-color: #f8fafc;
}
/* Styles pour les num√©ros de re√ßu */
.badge-recu {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 9999px;
    font-size: 11px;
    font-weight: 600;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
}

.badge-recu i {
    margin-right: 4px;
}

/* Badge par type d'examen */
.badge-histologie {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

.badge-biopsie {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.badge-cytologie {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.badge-fcv {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.badge-immuno {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

/* Colonne Re√ßu */
td .flex.flex-col {
    gap: 4px;
}

/* Animation au survol du num√©ro de re√ßu */
.badge-recu:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    transition: all 0.2s ease;
}   
 /* Style pour l'affichage du prix */
#prixExamenContainer {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Style pour les options avec prix */
#typePaiement option {
    padding: 12px;
    border-bottom: 1px solid #f1f5f9;
}

#typePaiement option:hover {
    background-color: #f8fafc;
}

/* Badge de prix dans les options */
.option-prix {
    float: right;
    background: #3b82f6;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}       
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-credit-card text-2xl text-blue-300"></i>
                <h1 class="text-2xl font-bold">R√©ceptions</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="currentUser" class="text-sm bg-white/20 px-3 py-1 rounded-full"></span>
                <a href="index.html" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition flex items-center space-x-2">
                    <i class="fas fa-home"></i>
                    <span>Accueil</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- En-t√™te et KPI -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Tableau de Bord R√©ceptions</h2>
            <p class="text-gray-600">G√©rez les paiements, les dettes et consultez les statistiques financi√®res</p>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 animate-fade-in">
         <div class="kpi-card bg-gradient-to-br from-green-500 to-emerald-600 text-white p-6 rounded-xl shadow-md">
    <div class="flex items-center justify-between">
        <div>
            <p class="text-sm opacity-90">Encaisse du Jour</p>
            <p id="totalEncaisse" class="text-3xl font-bold">0 DA</p>
        </div>
        <i class="fas fa-money-bill-wave text-4xl opacity-30"></i>
    </div>
    <div class="mt-4 pt-3 border-t border-white/20">
        <p class="text-xs opacity-80"><span id="encaisseAujourdhui">Total cumul√©: 0 DA</span></p>
    </div>
</div>

            <div class="kpi-card bg-gradient-to-br from-orange-500 to-red-600 text-white p-6 rounded-xl shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Dettes Actives</p>
                        <p id="totalDettes" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-file-invoice-dollar text-4xl opacity-30"></i>
                </div>
                <div class="mt-4 pt-3 border-t border-white/20">
                    <p class="text-xs opacity-80">Montant total: <span id="montantDettes">0 DA</span></p>
                </div>
            </div>

            <div class="kpi-card bg-gradient-to-br from-blue-500 to-cyan-600 text-white p-6 rounded-xl shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Paiements</p>
                        <p id="totalPaiements" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-credit-card text-4xl opacity-30"></i>
                </div>
                <div class="mt-4 pt-3 border-t border-white/20">
                    <p class="text-xs opacity-80">Ce mois: <span id="paiementsMois">0</span></p>
                </div>
            </div>

            <div class="kpi-card bg-gradient-to-br from-purple-500 to-pink-600 text-white p-6 rounded-xl shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Patients Detteurs</p>
                        <p id="patientsDetteurs" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-user-clock text-4xl opacity-30"></i>
                </div>
                <div class="mt-4 pt-3 border-t border-white/20">
                    <p class="text-xs opacity-80">√Ä suivre</p>
                </div>
            </div>
        </div>

        <!-- Onglets - Responsive avec 2 lignes sur mobile -->
<div class="mb-8">
    <div class="border-b border-gray-200">
        <!-- Grille responsive: 2 lignes sur mobile, 1 ligne sur desktop -->
        <nav class="grid grid-cols-3 md:flex md:flex-wrap gap-2 md:gap-4">
            <!-- Premi√®re ligne mobile (3 onglets) -->
            <button onclick="showTab('nouveau')" id="tab-nouveau" 
                    class="py-3 px-2 md:px-4 border-b-2 font-medium text-sm md:text-base tab-active text-center">
                <i class="fas fa-plus-circle md:mr-2 block md:inline mb-1 md:mb-0"></i>
                <span class="block md:inline text-xs md:text-base">Nouveau</span>
            </button>
            
            <button onclick="showTab('liste')" id="tab-liste" 
                    class="py-3 px-2 md:px-4 border-b-2 font-medium text-sm md:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300 text-center">
                <i class="fas fa-list md:mr-2 block md:inline mb-1 md:mb-0"></i>
                <span class="block md:inline text-xs md:text-base">Liste</span>
            </button>
            
            <button onclick="showTab('dettes')" id="tab-dettes" 
                    class="py-3 px-2 md:px-4 border-b-2 font-medium text-sm md:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300 text-center">
                <i class="fas fa-exclamation-triangle md:mr-2 block md:inline mb-1 md:mb-0"></i>
                <span class="block md:inline text-xs md:text-base">Dettes</span>
            </button>
            
            <!-- Deuxi√®me ligne mobile (2 onglets) - Centr√© avec col-span -->
            <button onclick="showTab('statistiques')" id="tab-statistiques" 
                    class="py-3 px-2 md:px-4 border-b-2 font-medium text-sm md:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300 text-center col-span-1 md:col-span-auto">
                <i class="fas fa-chart-bar md:mr-2 block md:inline mb-1 md:mb-0"></i>
                <span class="block md:inline text-xs md:text-base">Stats</span>
            </button>
            
            <button onclick="showTab('rapports')" id="tab-rapports" 
                    class="py-3 px-2 md:px-4 border-b-2 font-medium text-sm md:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300 text-center col-span-2 md:col-span-auto">
                <i class="fas fa-file-alt md:mr-2 block md:inline mb-1 md:mb-0"></i>
                <span class="block md:inline text-xs md:text-base">Rapports</span>
            </button>
        </nav>
    </div>
</div>

        <!-- Contenu des onglets -->
        <div id="content-nouveau" class="tab-content animate-fade-in">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-cash-register mr-2 text-indigo-600"></i>Enregistrer un Paiement
                </h3>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Formulaire de paiement -->
                    <div class="space-y-6">
                        <!-- S√©lection du patient -->
                        <div>
    <label class="block text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-user-injured mr-2 text-blue-600"></i>S√©lectionner un Patient*
    </label>
    <div class="flex gap-2">
        <select id="patientSelect" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required onchange="updatePatientInfo()">
            <option value="">Chargement des patients...</option>
        </select>
        <button type="button" onclick="openQuickPatientModal()" class="bg-green-100 hover:bg-green-200 text-green-800 px-4 py-3 rounded-lg transition flex items-center gap-2 text-sm font-medium whitespace-nowrap shadow-sm" title="Ajouter un nouveau patient">
            <i class="fas fa-user-plus"></i>
        </button>
        <button type="button" onclick="chargerPatientsDansSelect()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-lg transition" title="Actualiser">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
    <div id="patientInfo" class="mt-3 p-4 bg-blue-50 rounded-lg hidden">
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div><span class="font-medium">√Çge:</span> <span id="infoAge">-</span></div>
                                    <div><span class="font-medium">Sexe:</span> <span id="infoSexe">-</span></div>
                                    <div><span class="font-medium">T√©l√©phone:</span> <span id="infoTel">-</span></div>
                                    <div><span class="font-medium">Solde actuel:</span> <span id="infoSolde" class="font-bold">0 DA</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Type de paiement -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-money-check-alt mr-2 text-green-600"></i>Type de Paiement*
                            </label>
                            <div class="grid grid-cols-3 gap-4">
                                <label class="cursor-pointer">
                                    <input type="radio" name="modePaiement" value="espece" checked class="sr-only peer" onchange="toggleMontantTotal()">
                                    <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-green-500 peer-checked:bg-green-50 transition-all">
                                        <i class="fas fa-money-bill-wave text-2xl text-green-600 mb-2"></i>
                                        <p class="font-medium">Comptant</p>
                                        <p class="text-xs text-gray-500 mt-1">Paiement imm√©diat</p>
                                    </div>
                                </label>
                                
                                <label class="cursor-pointer">
                                    <input type="radio" name="modePaiement" value="a_terme" class="sr-only peer" onchange="toggleMontantTotal()">
                                    <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-orange-500 peer-checked:bg-orange-50 transition-all">
                                        <i class="fas fa-calendar-alt text-2xl text-orange-600 mb-2"></i>
                                        <p class="font-medium">√Ä Terme</p>
                                        <p class="text-xs text-gray-500 mt-1">Paiement diff√©r√©</p>
                                    </div>
                                </label>
                                
                                <label class="cursor-pointer">
                                    <input type="radio" name="modePaiement" value="paiement_partiel" class="sr-only peer" onchange="toggleMontantTotal()">
                                    <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 transition-all">
                                        <i class="fas fa-hand-holding-usd text-2xl text-blue-600 mb-2"></i>
                                        <p class="font-medium">Partiel</p>
                                        <p class="text-xs text-gray-500 mt-1">R√®glement dette</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Montants -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div id="montantTotalGroup" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Montant Total (DA)*
                                </label>
                                <input type="number" id="montantTotal" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" min="0" step="0.01" placeholder="0.00" oninput="updateRecap()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Montant Pay√© (DA)*
                                </label>
                                <input type="number" id="montantPaye" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" min="0" step="0.01" placeholder="0.00" required oninput="updateRecap()">
                            </div>
                        </div>

                        <!-- D√©tails suppl√©mentaires -->
                        <div class="space-y-4">
                       <div>
    <label class="block text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-stethoscope mr-2 text-purple-600"></i>Type d'Examen*
    </label>
    <select id="typeExamen" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required onchange="chargerSousFamilles()">
        <option value="">S√©lectionnez un type d'examen</option>
        <option value="histologie">Histologie</option>
        <option value="biopsie">Biopsie</option>
        <option value="cytologie">Cytologie</option>
        <option value="fcv">FCV</option>
        <option value="immuno-histochimie">Immuno-Histochimie</option>
        <option value="autre">Autre</option>
    </select>
</div>

<!-- Nouveau : Sous-familles charg√©es depuis l'API -->
<div id="sousFamilleContainer" class="hidden">
    <label class="block text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-tags mr-2 text-green-600"></i>Sous-famille d'examen
        <span class="text-xs text-gray-500 ml-2">(S√©lectionnez pour voir le prix)</span>
    </label>
    <select id="sousFamilleSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" onchange="afficherPrixSousFamille()">
        <option value="">Chargement des sous-familles...</option>
    </select>
</div>

<!-- Affichage du prix de la sous-famille -->
<div id="prixExamenContainer" class="hidden mt-4">
    <div class="p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-200">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-green-700 font-medium">üí∞ Prix de la sous-famille</p>
                <p id="prixExamenValeur" class="text-2xl font-bold text-green-900 mt-1">0 DA</p>
                <p id="descriptionSousFamille" class="text-xs text-green-600 mt-1"></p>
                <p class="text-xs text-green-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Ce prix sera utilis√© comme r√©f√©rence pour le montant total
                </p>
            </div>
            <div class="text-center">
                <i class="fas fa-money-bill-wave text-3xl text-green-500"></i>
                <button type="button" onclick="utiliserPrixSousFamille()" 
                        class="mt-3 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition flex items-center">
                    <i class="fas fa-check mr-1"></i> Utiliser
                </button>
            </div>
        </div>
    </div>
</div>
<div>
    <label class="block text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-file-invoice mr-2 text-gray-600"></i>Num√©ro de Re√ßu
        <span class="text-xs text-gray-500">(G√©n√©r√© automatiquement si vide)</span>
    </label>
    <input type="text" id="numeroCR" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Laissez vide pour g√©n√©ration auto">
    <p class="text-xs text-gray-500 mt-1">
        Format: XXXTYYMM (Ex: 001H26A pour Histologie Janvier 2026)
    </p>
</div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-comment-alt mr-2 text-gray-600"></i>Notes
                                </label>
                                <textarea id="notes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Informations suppl√©mentaires..."></textarea>
                            </div>
                        </div>

                        <!-- Bouton d'enregistrement -->
                        <button onclick="enregistrerPaiement()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold py-4 px-6 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg">
                            <i class="fas fa-save mr-2"></i>Enregistrer le Paiement
                        </button>
                    </div>

                    <!-- R√©capitulatif -->
                    <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                        <h4 class="text-lg font-semibold mb-6 text-gray-800">
                            <i class="fas fa-receipt mr-2 text-indigo-600"></i>R√©capitulatif
                        </h4>
                        
                        <div id="recapContent" class="space-y-4">
                            <div class="text-center py-12 text-gray-400">
                                <i class="fas fa-file-invoice-dollar text-4xl mb-4"></i>
                                <p>Les d√©tails du paiement appara√Ætront ici</p>
                            </div>
                        </div>
                        
                        <!-- R√©sum√© dynamique -->
                        <div id="recapDetails" class="mt-8 pt-6 border-t border-gray-200 hidden">
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Montant total:</span>
                                    <span id="recapTotal" class="font-semibold">0 DA</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Montant pay√©:</span>
                                    <span id="recapPaye" class="font-semibold text-green-600">0 DA</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Reste √† payer:</span>
                                    <span id="recapReste" class="font-semibold text-orange-600">0 DA</span>
                                </div>
                                <div class="flex justify-between pt-3 border-t">
                                    <span class="text-gray-700 font-medium">Nouveau solde:</span>
                                    <span id="recapNouveauSolde" class="font-bold text-lg">0 DA</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Liste des Paiements -->
        <div id="content-liste" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 md:mb-0">
                        <i class="fas fa-history mr-2 text-indigo-600"></i>Historique des Paiements
                    </h3>
                    <div class="flex flex-wrap gap-2">
    <button onclick="toggleFiltres()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition flex items-center">
        <i class="fas fa-filter mr-2"></i>Filtres
    </button>
    <button onclick="scannerQRCode()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex items-center">
        <i class="fas fa-qrcode mr-2"></i>Scanner QR
    </button>
    <button onclick="exporterExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition flex items-center">
        <i class="fas fa-file-excel mr-2"></i>Excel
    </button>
    <button onclick="imprimerListe()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center">
        <i class="fas fa-print mr-2"></i>Imprimer
    </button>
</div>
                </div>

                <!-- Panneau de filtres -->
                <div id="filtresPanel" class="drawer-content mb-6">
                    <div class="p-4 bg-gray-50 rounded-lg border">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Patient</label>
                                <select id="filterPatient" class="w-full px-3 py-2 border rounded-md">
                                    <option value="">Tous les patients</option>
                                </select>
                            </div>
                             <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Type d'examen</label>
        <select id="filterTypeExamen" class="w-full px-3 py-2 border rounded-md">
            <option value="">Tous les types</option>
            <option value="H">Histologie</option>
            <option value="B">Biopsie</option>
            <option value="C">Cytologie</option>
            <option value="F">FCV</option>
            <option value="I">Immuno-Histochimie</option>
        </select>
    </div>
    
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Date d√©but</label>
        <input type="date" id="filterDateDebut" class="w-full px-3 py-2 border rounded-md">
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Date fin</label>
        <input type="date" id="filterDateFin" class="w-full px-3 py-2 border rounded-md">
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Mode paiement</label>
        <select id="filterModePaiement" class="w-full px-3 py-2 border rounded-md">
            <option value="">Tous</option>
            <option value="espece">Comptant</option>
            <option value="a_terme">√Ä terme</option>
            <option value="paiement_partiel">Partiel</option>
        </select>
    </div>
</div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button onclick="appliquerFiltres()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">
                                Appliquer
                            </button>
                            <button onclick="reinitialiserFiltres()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition">
                                R√©initialiser
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mode</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Re√ßu</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="listePaiements" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Chargement des paiements...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div id="pagination" class="mt-4 flex justify-between items-center hidden">
                    <div class="text-sm text-gray-700">
                        Affichage de <span id="paginationStart">0</span> √† <span id="paginationEnd">0</span> sur <span id="paginationTotal">0</span> paiements
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="changePage(-1)" class="px-3 py-1 border rounded-md hover:bg-gray-50">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="currentPage" class="px-3 py-1">1</span>
                        <button onclick="changePage(1)" class="px-3 py-1 border rounded-md hover:bg-gray-50">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Dettes Actives -->
        <div id="content-dettes" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-exclamation-triangle mr-2 text-red-600"></i>Dettes Actives des Patients
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-clock text-2xl text-red-500 mr-3"></i>
                            <div>
                                <p class="text-sm text-red-700">Dettes en attente</p>
                                <p id="dettesEnAttente" class="text-2xl font-bold text-red-800">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-calendar-times text-2xl text-orange-500 mr-3"></i>
                            <div>
                                <p class="text-sm text-orange-700">Montant total d√ª</p>
                                <p id="montantTotalDu" class="text-2xl font-bold text-orange-800">0 DA</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-user-friends text-2xl text-blue-500 mr-3"></i>
                            <div>
                                <p class="text-sm text-blue-700">Patients concern√©s</p>
                                <p id="patientsConcernes" class="text-2xl font-bold text-blue-800">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T√©l√©phone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dette totale</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dernier paiement</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="listeDettes" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                    Chargement des dettes...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Onglet Statistiques -->
        <div id="content-statistiques" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-chart-bar mr-2 text-indigo-600"></i>Statistiques Financi√®res
                </h3>
                
                <!-- Filtres statistiques -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">P√©riode</label>
                            <select id="statPeriode" class="w-full px-3 py-2 border rounded-md" onchange="updateStatistiques()">
                                <option value="mois_courant">Mois courant</option>
                                <option value="mois_precedent">Mois pr√©c√©dent</option>
                                <option value="trimestre">Trimestre</option>
                                <option value="annee_courante">Ann√©e courante</option>
                                <option value="personnalise">Personnalis√©</option>
                            </select>
                        </div>
                        <div id="statDateDebutGroup" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date d√©but</label>
                            <input type="date" id="statDateDebut" class="w-full px-3 py-2 border rounded-md" onchange="updateStatistiques()">
                        </div>
                        <div id="statDateFinGroup" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date fin</label>
                            <input type="date" id="statDateFin" class="w-full px-3 py-2 border rounded-md" onchange="updateStatistiques()">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Graphique des paiements par type -->
                    <div class="bg-white rounded-xl p-6 border">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-chart-pie mr-2 text-indigo-600"></i>R√©partition des Paiements
                        </h4>
                        <div class="h-80">
                            <canvas id="chartPaiements"></canvas>
                        </div>
                    </div>

                    <!-- √âvolution mensuelle -->
                    <div class="bg-white rounded-xl p-6 border">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-chart-line mr-2 text-green-600"></i>√âvolution Mensuelle
                        </h4>
                        <div class="h-80">
                            <canvas id="chartEvolution"></canvas>
                        </div>
                    </div>

                    <!-- Top patients -->
                    <div class="bg-white rounded-xl p-6 border lg:col-span-2">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-trophy mr-2 text-yellow-600"></i>Top 10 Patients
                        </h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Pay√©</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre de Paiements</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Derni√®re Visite</th>
                                    </tr>
                                </thead>
                                <tbody id="topPatients" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                                            Chargement des donn√©es...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

      <!-- Onglet Rapports  -->
<div id="content-rapports" class="tab-content hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h3 class="text-xl font-semibold mb-6 text-gray-800">
            <i class="fas fa-file-alt mr-2 text-indigo-600"></i>Rapports et Exports
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Rapport Journalier -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                <h4 class="text-lg font-semibold mb-4 text-blue-800">
                    <i class="fas fa-calendar-day mr-2"></i>Rapport Journalier
                </h4>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                    <input type="date" id="rapportDate" class="w-full px-3 py-2 border rounded-md" value="<?php echo date('Y-m-d'); ?>">
                </div>
                <div class="flex gap-2">
                    <button onclick="genererRapportJournalier()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-download mr-2"></i>G√©n√©rer
                    </button>
                    <button onclick="imprimerRapportJournalier()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-print mr-2"></i>
                    </button>
                </div>
            </div>

            <!-- Export Complet -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                <h4 class="text-lg font-semibold mb-4 text-green-800">
                    <i class="fas fa-file-export mr-2"></i>Export Complet
                </h4>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Format</label>
                    <select id="exportFormat" class="w-full px-3 py-2 border rounded-md">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                <button onclick="exporterDonneesCompletes()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                    <i class="fas fa-file-download mr-2"></i>Exporter Donn√©es
                </button>
            </div>

            <!-- Synth√®se Patient -->
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
                <h4 class="text-lg font-semibold mb-4 text-purple-800">
                    <i class="fas fa-user-chart mr-2"></i>Synth√®se Patient
                </h4>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Patient</label>
                    <select id="rapportPatient" class="w-full px-3 py-2 border rounded-md">
                        <option value="">S√©lectionner un patient...</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button onclick="genererSynthesePatient()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-user-md mr-2"></i>Voir Synth√®se
                    </button>
                    <button onclick="imprimerSynthesePatient()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-print mr-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Modal D√©tail Paiement -->
    <div id="modalDetail" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white rounded-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-file-invoice-dollar mr-2 text-indigo-600"></i>D√©tail du Paiement
                    </h3>
                    <button onclick="closeModalDetail()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6" id="modalDetailContent">
                <!-- Contenu charg√© dynamiquement -->
            </div>
        </div>
    </div>
   <!-- Modal Choix Impression -->
<div id="modalChoixImpression" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal-overlay">
    <div class="bg-white rounded-xl w-full max-w-md mx-4">
        <div class="p-6 border-b bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-t-xl">
            <h3 class="text-xl font-semibold flex items-center">
                <i class="fas fa-print mr-3 text-2xl"></i>
                Imprimer le Re√ßu
            </h3>
            <p class="text-sm mt-1 opacity-90">Choisissez le format d'impression</p>
        </div>
        <div class="p-6 space-y-4">
            <!-- Bouton A4 -->
            <button onclick="imprimerRecu('a4')" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-4 rounded-lg transition-all shadow-md hover:shadow-lg flex items-center justify-between group">
                <div class="flex items-center">
                    <i class="fas fa-file-alt text-2xl mr-4"></i>
                    <div class="text-left">
                        <div class="font-semibold text-lg">Format A4</div>
                        <div class="text-xs opacity-90">Re√ßu officiel complet (21 x 29.7 cm)</div>
                    </div>
                </div>
                <i class="fas fa-chevron-right group-hover:translate-x-1 transition-transform"></i>
            </button>

            <!-- Bouton Ticket -->
            <button onclick="imprimerRecu('ticket')" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-4 rounded-lg transition-all shadow-md hover:shadow-lg flex items-center justify-between group">
                <div class="flex items-center">
                    <i class="fas fa-receipt text-2xl mr-4"></i>
                    <div class="text-left">
                        <div class="font-semibold text-lg">Ticket 80mm</div>
                        <div class="text-xs opacity-90">Ticket de caisse thermique (8 cm)</div>
                    </div>
                </div>
                <i class="fas fa-chevron-right group-hover:translate-x-1 transition-transform"></i>
            </button>

            <!-- NOUVEAU : Bouton Vignette 60√ó40 mm -->
            <button onclick="imprimerRecu('vignette')" class="w-full bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white p-4 rounded-lg transition-all shadow-md hover:shadow-lg flex items-center justify-between group">
                <div class="flex items-center">
                    <i class="fas fa-tag text-2xl mr-4"></i>
                    <div class="text-left">
                        <div class="font-semibold text-lg">Vignette 60√ó40 mm</div>
                        <div class="text-xs opacity-90">√âtiquette avec QR code (6 x 4 cm)</div>
                    </div>
                </div>
                <i class="fas fa-chevron-right group-hover:translate-x-1 transition-transform"></i>
            </button>

            <div class="pt-4 border-t border-gray-200">
                <button onclick="fermerModalImpression()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                    <i class="fas fa-times mr-2"></i>
                    Fermer sans imprimer
                </button>
            </div>
        </div>
    </div>
</div>
   <!-- Modal Ajout rapide PATIENT depuis Paiement -->
<div id="quickPatientModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] hidden modal-overlay">
  <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 shadow-2xl">
    <div class="flex justify-between items-center mb-5 pb-3 border-b">
      <h3 class="text-xl font-semibold text-blue-700">
        <i class="fas fa-user-plus mr-2"></i>Nouveau Patient
      </h3>
      <button type="button" onclick="closeQuickPatientModal()" class="text-gray-500 hover:text-gray-800 text-2xl">
        √ó
      </button>
    </div>

    <form id="quickPatientForm" class="space-y-4" onsubmit="event.preventDefault(); saveQuickPatient();">
      <input type="hidden" id="quickPatientId">

      <div>
        <label class="block text-sm font-medium mb-1 text-gray-700">
          Nom & Pr√©nom <span class="text-red-500">*</span>
        </label>
        <input type="text" id="quickPatientNom" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1 text-gray-700">√Çge</label>
          <input type="number" id="quickPatientAge" min="0" max="120" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1 text-gray-700">Sexe</label>
          <select id="quickPatientSexe" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="">‚Äî</option>
            <option value="M">Masculin</option>
            <option value="F">F√©minin</option>
          </select>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1 text-gray-700">T√©l√©phone</label>
        <input type="tel" id="quickPatientTel" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t mt-2">
        <button type="button" onclick="closeQuickPatientModal()" class="px-5 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition">
          Annuler
        </button>
        <button type="submit" class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition flex items-center gap-2">
          <i class="fas fa-save"></i> Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>
        <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i id="toastIcon" class="mr-2"></i>
        <span id="toastMessage"></span>
    </div>

    <script>
        // Configuration API
        const API_BASE_URL = localStorage.getItem('apiBaseUrl') || 'https://anapath.onrender.com';
        let currentUserId = localStorage.getItem('userId');
        let allPaiements = [];
        let allPatients = [];
        let allDettes = [];
        let currentPage = 1;
        let perPage = 20;
        let totalPaiements = 0;
        let filtresActifs = {};

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            if (!currentUserId) {
                showToast('Veuillez vous connecter', 'error');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            updateCurrentUserDisplay();
            loadDashboardData();
            chargerPatientsDansSelect(true);
            loadPaiements();
            loadDettes();
            chargerPatientsFiltre();
            
            // Initialiser les dates par d√©faut
            const aujourdhui = new Date().toISOString().split('T')[0];
            document.getElementById('rapportDate').value = aujourdhui;
            document.getElementById('filterDateDebut').value = aujourdhui;
            document.getElementById('filterDateFin').value = aujourdhui;
            
            // √âcouteurs d'√©v√©nements
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('patientSelect').addEventListener('change', updatePatientInfo);
            document.getElementById('montantPaye').addEventListener('input', updateRecap);
            document.getElementById('montantTotal').addEventListener('input', updateRecap);
            document.querySelectorAll('input[name="modePaiement"]').forEach(radio => {
                radio.addEventListener('change', toggleMontantTotal);
            });
            
            // Filtres
            document.getElementById('statPeriode').addEventListener('change', function() {
                const periode = this.value;
                const dateDebutGroup = document.getElementById('statDateDebutGroup');
                const dateFinGroup = document.getElementById('statDateFinGroup');
                
                if (periode === 'personnalise') {
                    dateDebutGroup.classList.remove('hidden');
                    dateFinGroup.classList.remove('hidden');
                } else {
                    dateDebutGroup.classList.add('hidden');
                    dateFinGroup.classList.add('hidden');
                }
                updateStatistiques();
            });
        }

        function updateCurrentUserDisplay() {
            const selectedUser = JSON.parse(localStorage.getItem('selectedUtilisateur') || '{}');
            const displayName = selectedUser.nom || 'Utilisateur non s√©lectionn√©';
            document.getElementById('currentUser').textContent = displayName;
        }

        function showTab(tabName) {
            // Cacher tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // D√©sactiver tous les onglets
            document.querySelectorAll('button[onclick^="showTab"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });

            // Afficher l'onglet s√©lectionn√©
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Activer le bouton correspondant
            const tabBtn = document.getElementById(`tab-${tabName}`);
            tabBtn.classList.add('tab-active');
            tabBtn.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            
            // Actions sp√©cifiques par onglet
            if (tabName === 'statistiques') {
                updateStatistiques();
            }
        }

async function loadDashboardData() {
    try {
        // ‚úÖ Charger les statistiques (plus fiable)
        const statsRes = await fetch(`${API_BASE_URL}/paiements/statistiques`, {
            headers: { 'X-User-ID': currentUserId }
        });
        
        if (statsRes.ok) {
            const stats = await statsRes.json();
            console.log("üìä Stats re√ßues:", stats);
            
            // Mettre √† jour les KPI avec les donn√©es du backend
            document.getElementById('totalEncaisse').textContent = 
                `${(stats.total_encaisse_jour || 0).toFixed(2)} DA`;
            document.getElementById('encaisseAujourdhui').textContent = 
                `Total cumul√©: ${(stats.total_encaisse || 0).toFixed(2)} DA`;
        }
        
        // Charger tous les paiements pour la liste
        const paiementsRes = await fetch(`${API_BASE_URL}/paiements?page=1&per_page=1000`, {
            headers: { 'X-User-ID': currentUserId }
        });

        if (paiementsRes.ok) {
            const data = await paiementsRes.json();
            allPaiements = data.paiements || data || [];
            
            document.getElementById('totalPaiements').textContent = allPaiements.length;
            
            // Calculer paiements du mois
            const debutMois = new Date();
            debutMois.setDate(1);
            const paiementsMois = allPaiements.filter(p => {
                if (!p.date_paiement) return false;
                const datePaiement = new Date(p.date_paiement);
                return datePaiement >= debutMois;
            });
            document.getElementById('paiementsMois').textContent = paiementsMois.length;
        }
        
        // Charger les dettes
        await loadDettes();
        
    } catch (error) {
        console.error('‚ùå Erreur chargement dashboard:', error);
        showToast('Erreur lors du chargement des donn√©es', 'error');
    }
}
function renderTopPatients(topPatients) {
    const tbody = document.getElementById('topPatients');
    
    if (topPatients.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                    Aucune donn√©e disponible
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = topPatients.map(patient => `
        <tr class="hover:bg-yellow-50">
            <td class="px-6 py-4">
                <div class="text-sm font-medium text-gray-900">
                    ${patient.nom}
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm font-bold text-green-600">${parseFloat(patient.total_paye || 0).toFixed(2)} DA</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-900">${patient.nombre_paiements || 0}</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-500">-</div>
            </td>
        </tr>
    `).join('');
}
     async function loadPaiements() {
    try {
        // Charger tous les paiements initialement
        const response = await fetch(`${API_BASE_URL}/paiements?page=1&per_page=1000`, {
            headers: { 'X-User-ID': currentUserId }
        });

        if (response.ok) {
            const data = await response.json();
            
            // Normaliser les donn√©es selon la r√©ponse API
            if (Array.isArray(data)) {
                allPaiements = data;
            } else if (data.paiements && Array.isArray(data.paiements)) {
                allPaiements = data.paiements;
            } else if (data.data && Array.isArray(data.data)) {
                allPaiements = data.data;
            } else {
                allPaiements = [];
            }
            
            // Appliquer les filtres si pr√©sents
            if (Object.keys(filtresActifs).length > 0) {
                allPaiements = filtrerPaiements(allPaiements, filtresActifs);
            }
            
            totalPaiements = allPaiements.length;
            renderPaiementsList();
            updatePagination();
            
        } else {
            console.error('Erreur API:', await response.text());
            showToast('Erreur lors du chargement des paiements', 'error');
        }
    } catch (error) {
        console.error('Erreur chargement paiements:', error);
        showToast('Erreur lors du chargement des paiements', 'error');
    }
}

// Fonction helper pour filtrer les paiements localement
function filtrerPaiements(paiements, filtres) {
    return paiements.filter(p => {
        let match = true;
        
        if (filtres.patient_id && p.patient_id != filtres.patient_id) {
            match = false;
        }
        
        if (filtres.date_debut && p.date_paiement) {
            const datePaiement = new Date(p.date_paiement);
            const dateDebut = new Date(filtres.date_debut);
            if (datePaiement < dateDebut) {
                match = false;
            }
        }
        
        if (filtres.date_fin && p.date_paiement) {
            const datePaiement = new Date(p.date_paiement);
            const dateFin = new Date(filtres.date_fin + 'T23:59:59');
            if (datePaiement > dateFin) {
                match = false;
            }
        }
        
        if (filtres.mode_paiement && p.mode_paiement !== filtres.mode_paiement) {
            match = false;
        }
        
        if (filtres.type_examen) {
            // V√©rifier d'abord dans type_paiement
            if (p.type_paiement && p.type_paiement.toLowerCase().includes(filtres.type_examen.toLowerCase())) {
                // OK
            } 
            // V√©rifier ensuite dans le num√©ro CR
            else if (p.numero_cr) {
                const codeType = p.numero_cr.charAt(3);
                const typesMap = {
                    'H': 'histologie',
                    'B': 'biopsie',
                    'C': 'cytologie',
                    'F': 'fcv',
                    'I': 'immuno-histochimie'
                };
                if (typesMap[codeType] !== filtres.type_examen) {
                    match = false;
                }
            } else {
                match = false;
            }
        }
        
        return match;
    });
}
      async function chargerPatientsFiltre() {
    try {
        const response = await fetch(`${API_BASE_URL}/patients`, {
            headers: { 'X-User-ID': currentUserId }
        });

        if (response.ok) {
            const patients = await response.json();
            
            // S'assurer que patients est un tableau
            const patientsArray = Array.isArray(patients) ? patients : 
                                (patients.patients || patients.data || []);
            
            const selectFiltre = document.getElementById('filterPatient');
            const selectRapport = document.getElementById('rapportPatient');
            
            // Options pour les filtres
            let optionsFiltre = '<option value="">Tous les patients</option>';
            let optionsRapport = '<option value="">S√©lectionner un patient...</option>';
            
            patientsArray.forEach(p => {
                const solde = parseFloat(p.solde || 0);
                const soldeFormatted = Math.abs(solde).toFixed(2);
                const nomComplet = `${p.nom}${p.prenom ? ' ' + p.prenom : ''}`;
                
                let soldeText = '';
                if (solde < 0) {
                    soldeText = ` (Dette: ${soldeFormatted} DA)`;
                } else if (solde > 0) {
                    soldeText = ` (Cr√©dit: ${soldeFormatted} DA)`;
                } else {
                    soldeText = ` (Solde: ${soldeFormatted} DA)`;
                }
                
                optionsFiltre += `<option value="${p.id}">${nomComplet}${soldeText}</option>`;
                optionsRapport += `<option value="${p.id}">${nomComplet}${soldeText}</option>`;
            });
            
            selectFiltre.innerHTML = optionsFiltre;
            selectRapport.innerHTML = optionsRapport;
            
            // Charger aussi dans le select du formulaire de paiement
            chargerPatientsDansSelect(true);
            
        } else {
            console.error('Erreur chargement patients filtre:', await response.text());
        }
    } catch (error) {
        console.error('Erreur chargement patients filtre:', error);
        showToast('Erreur lors du chargement des patients', 'error');
    }
}

// Fonction pour charger les patients dans le select du formulaire
async function chargerPatientsDansSelect(preserveSelection = false) {
    try {
        const response = await fetch(`${API_BASE_URL}/patients`, {
            headers: { 'X-User-ID': currentUserId }
        });

        if (response.ok) {
            const patients = await response.json();
            const patientsArray = Array.isArray(patients) ? patients : 
                                (patients.patients || patients.data || []);
            
            const select = document.getElementById('patientSelect');
            
            // Si on doit pr√©server la s√©lection, la sauvegarder
            const currentValue = preserveSelection ? select.value : null;
            
            let options = '<option value="">S√©lectionner un patient...</option>';
            
            patientsArray.forEach(p => {
                const solde = parseFloat(p.solde || 0);
                const nomComplet = `${p.nom}${p.prenom ? ' ' + p.prenom : ''}`;
                
                options += `
                    <option value="${p.id}" 
                            data-age="${p.age || ''}" 
                            data-sexe="${p.sexe || ''}" 
                            data-tel="${p.telephone || ''}" 
                            data-solde="${solde}">
                        ${nomComplet} 
                        (${p.telephone || 'N/A'}) 
                        - Solde: ${solde.toFixed(2)} DA
                    </option>
                `;
            });
            
            select.innerHTML = options;
            
            // Restaurer la s√©lection si n√©cessaire
            if (currentValue && currentValue !== "") {
                select.value = currentValue;
                if (select.value === currentValue) {
                    updatePatientInfo();
                }
            }
            
            return patientsArray;
            
        } else {
            console.error('Erreur chargement patients:', await response.text());
            return [];
        }
    } catch (error) {
        console.error('Erreur chargement patients:', error);
        return [];
    }
}
       function updatePatientInfo() {
    const select = document.getElementById('patientSelect');
    const selectedOption = select.options[select.selectedIndex];
    const infoDiv = document.getElementById('patientInfo');

    if (selectedOption && selectedOption.value) {
        const age = selectedOption.dataset.age || '-';
        const sexe = selectedOption.dataset.sexe || '-';
        const tel = selectedOption.dataset.tel || '-';
        const solde = parseFloat(selectedOption.dataset.solde || 0);

        document.getElementById('infoAge').textContent = age;
        document.getElementById('infoSexe').textContent = sexe;
        document.getElementById('infoTel').textContent = tel;
        
        // Afficher correctement le solde avec la bonne couleur
        const infoSolde = document.getElementById('infoSolde');
        infoSolde.textContent = `${solde.toFixed(2)} DA`;
        
        if (solde < 0) {
            infoSolde.className = 'font-bold text-red-600';
            infoSolde.innerHTML = `${solde.toFixed(2)} DA <span class="text-xs">(Dette)</span>`;
        } else if (solde > 0) {
            infoSolde.className = 'font-bold text-green-600';
            infoSolde.innerHTML = `${solde.toFixed(2)} DA <span class="text-xs">(Cr√©dit)</span>`;
        } else {
            infoSolde.className = 'font-bold text-gray-600';
            infoSolde.textContent = `${solde.toFixed(2)} DA`;
        }

        infoDiv.classList.remove('hidden');
        updateRecap();
    } else {
        infoDiv.classList.add('hidden');
    }
}

    function toggleMontantTotal() {
    const modeRadio = document.querySelector('input[name="modePaiement"]:checked');
    
    // V√©rifier si l'√©l√©ment existe
    if (!modeRadio) return;
    
    const mode = modeRadio.value;
    const montantTotalGroup = document.getElementById('montantTotalGroup');
    const recapDetails = document.getElementById('recapDetails');

    if (montantTotalGroup && recapDetails) {
        if (mode === 'a_terme') {
            montantTotalGroup.classList.remove('hidden');
            recapDetails.classList.remove('hidden');
        } else {
            montantTotalGroup.classList.add('hidden');
            if (mode === 'espece' || mode === 'paiement_partiel') {
                recapDetails.classList.remove('hidden');
            }
        }
        updateRecap();
    }
}
  function updateRecap() {
    const patientSelect = document.getElementById('patientSelect');
    const mode = document.querySelector('input[name="modePaiement"]:checked').value;
    const montantPaye = parseFloat(document.getElementById('montantPaye').value) || 0;
    const montantTotal = parseFloat(document.getElementById('montantTotal').value) || 0;
    const soldeActuel = parseFloat(patientSelect.options[patientSelect.selectedIndex]?.dataset.solde || 0);

    let reste = 0;
    let nouveauSolde = soldeActuel;

    if (mode === 'a_terme') {
        reste = montantTotal - montantPaye;
        nouveauSolde = -reste;
    } else if (mode === 'paiement_partiel') {
        nouveauSolde = soldeActuel + montantPaye;
        reste = Math.abs(nouveauSolde) < 0.01 ? 0 : Math.abs(nouveauSolde);
    } else if (mode === 'espece') {
        nouveauSolde = soldeActuel;
        reste = 0;
    }

    // R√©cup√©rer l'info de la sous-famille s√©lectionn√©e
    const sousFamilleSelect = document.getElementById('sousFamilleSelect');
    const selectedOption = sousFamilleSelect.options[sousFamilleSelect.selectedIndex];
    let infoSousFamilleHTML = '';
    
    if (selectedOption && selectedOption.value && selectedOption.value !== 'autre') {
        const sousFamille = currentSousFamilles.find(sf => sf.id.toString() === selectedOption.value);
        
        if (sousFamille) {
            const prix = parseFloat(sousFamille.prix);
            const designation = sousFamille.designation;
            const code = sousFamille.code;
            
            infoSousFamilleHTML = `
                <div class="mt-4 p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-green-700 font-medium">
                                <i class="fas fa-tag mr-1"></i>Sous-famille s√©lectionn√©e
                            </p>
                            <p class="font-medium text-green-900">${designation}</p>
                            <p class="text-xs text-green-600">Code: ${code}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-green-700 font-medium">üí∞ Prix standard</p>
                            <p class="text-lg font-bold text-green-800">${prix.toLocaleString('fr-FR')} DA</p>
                        </div>
                    </div>
                    ${mode === 'a_terme' && montantTotal && montantTotal !== prix ? `
                        <div class="mt-2 p-2 bg-yellow-50 rounded text-xs text-yellow-800">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Le montant total saisi (${montantTotal.toLocaleString('fr-FR')} DA) diff√®re du prix standard
                        </div>
                    ` : ''}
                    <button onclick="utiliserPrixSousFamille()" 
                            class="mt-3 w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm transition flex items-center justify-center">
                        <i class="fas fa-hand-point-up mr-2"></i>
                        Utiliser ce prix ${mode === 'a_terme' ? 'comme montant total' : 'comme montant pay√©'}
                    </button>
                </div>
            `;
        }
    }

    // Mettre √† jour le contenu du r√©capitulatif
    const recapContent = document.getElementById('recapContent');
    recapContent.innerHTML = `
        <div class="space-y-4">
            <div class="flex justify-between items-center p-4 bg-indigo-50 rounded-lg">
                <span class="font-medium text-indigo-700">Mode de paiement:</span>
                <span class="px-3 py-1 rounded-full text-sm ${mode === 'espece' ? 'badge-espece' : mode === 'a_terme' ? 'badge-a_terme' : 'badge-partiel'}">
                    ${mode === 'espece' ? 'Comptant' : mode === 'a_terme' ? '√Ä terme' : 'Paiement partiel'}
                </span>
            </div>
            
            ${infoSousFamilleHTML}
            
            <div class="grid grid-cols-2 gap-4">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">Solde actuel</p>
                    <p class="text-xl font-bold ${soldeActuel < 0 ? 'text-red-600' : 'text-gray-800'}">
                        ${soldeActuel.toFixed(2)} DA
                    </p>
                </div>
                
                <div class="p-4 bg-green-50 rounded-lg">
                    <p class="text-sm text-green-600">Montant pay√©</p>
                    <p class="text-xl font-bold text-green-700">
                        ${montantPaye.toFixed(2)} DA
                    </p>
                </div>
            </div>
        </div>
    `;

    // Mettre √† jour les d√©tails
    if (mode === 'a_terme') {
        document.getElementById('recapTotal').textContent = `${montantTotal.toFixed(2)} DA`;
    } else {
        document.getElementById('recapTotal').textContent = `${montantPaye.toFixed(2)} DA`;
    }
    
    document.getElementById('recapPaye').textContent = `${montantPaye.toFixed(2)} DA`;
    document.getElementById('recapReste').textContent = `${reste.toFixed(2)} DA`;
    document.getElementById('recapNouveauSolde').textContent = `${nouveauSolde.toFixed(2)} DA`;
    document.getElementById('recapNouveauSolde').className = `font-bold text-lg ${nouveauSolde < 0 ? 'text-red-600' : nouveauSolde > 0 ? 'text-green-600' : 'text-gray-600'}`;
    
    // Toujours montrer les d√©tails
    document.getElementById('recapDetails').classList.remove('hidden');
}
async function enregistrerPaiement() {
    const patientId = document.getElementById('patientSelect').value;
    const mode = document.querySelector('input[name="modePaiement"]:checked').value;
    const montantPaye = parseFloat(document.getElementById('montantPaye').value);
    const montantTotal = parseFloat(document.getElementById('montantTotal').value);
    const typeExamen = document.getElementById('typeExamen').value;
    
    // R√©cup√©rer la sous-famille s√©lectionn√©e
    const sousFamilleSelect = document.getElementById('sousFamilleSelect');
    const sousFamilleId = sousFamilleSelect.value && sousFamilleSelect.value !== 'autre' ? sousFamilleSelect.value : null;
    const sousFamilleInfo = sousFamilleId ? 
        currentSousFamilles.find(sf => sf.id.toString() === sousFamilleId) : null;
    
    const numeroCR = document.getElementById('numeroCR').value.trim();
    const notes = document.getElementById('notes').value;

    // Validation
    if (!patientId) {
        showToast('Veuillez s√©lectionner un patient', 'error');
        return;
    }

    if (!typeExamen) {
        showToast('Veuillez s√©lectionner un type d\'examen', 'error');
        return;
    }

    if (!montantPaye || montantPaye <= 0) {
        showToast('Veuillez saisir un montant valide', 'error');
        return;
    }

    if (mode === 'a_terme') {
        if (!montantTotal || montantTotal <= 0) {
            showToast('Pour un paiement √† terme, veuillez saisir un montant total valide', 'error');
            return;
        }
        if (montantTotal <= montantPaye) {
            showToast('Le montant total doit √™tre sup√©rieur au montant pay√©', 'error');
            return;
        }
    }

    // Validation sp√©cifique pour les sous-familles
    if (sousFamilleInfo) {
        const prixSousFamille = parseFloat(sousFamilleInfo.prix);
        
        // Avertir si le montant pay√© est tr√®s diff√©rent du prix standard
        if (mode !== 'paiement_partiel' && Math.abs(montantPaye - prixSousFamille) > prixSousFamille * 0.3) {
            if (!confirm(`Le montant pay√© (${montantPaye} DA) diff√®re significativement du prix standard (${prixSousFamille} DA).\nVoulez-vous continuer ?`)) {
                return;
            }
        }
        
        // Pour les paiements √† terme, v√©rifier la coh√©rence
        if (mode === 'a_terme' && montantTotal && Math.abs(montantTotal - prixSousFamille) > prixSousFamille * 0.3) {
            if (!confirm(`Le montant total (${montantTotal} DA) diff√®re significativement du prix standard (${prixSousFamille} DA).\nVoulez-vous continuer ?`)) {
                return;
            }
        }
    }

    try {
        // Pr√©parer les donn√©es pour l'API
        const data = {
            patient_id: patientId,
            montant: montantPaye,
            type_paiement: typeExamen,
            mode_paiement: mode,
            sous_famille_id: sousFamilleId, // ID de la sous-famille
            numero_cr: numeroCR,
            notes: notes
        };

        // Ajouter le montant total pour les paiements √† terme
        if (mode === 'a_terme') {
            data.montant_total = montantTotal;
        } else if (sousFamilleInfo) {
            // Pour les autres modes, on peut aussi envoyer le prix de r√©f√©rence
            data.montant_total = sousFamilleInfo.prix;
        }

        // D√©terminer l'endpoint selon le mode de paiement
        let endpoint = `${API_BASE_URL}/paiements`;
        if (mode === 'paiement_partiel') {
            endpoint = `${API_BASE_URL}/paiements/paiement-partiel`;
        }

        // Envoyer la requ√™te
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-User-ID': currentUserId
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            const result = await response.json();
            
            // Message de succ√®s personnalis√©
            let message = `${result.message || 'Paiement enregistr√© avec succ√®s'}\nN¬∞ Re√ßu: ${result.numero_cr || numeroCR}`;
            
            // Ajouter les infos de la sous-famille si elle existe
            if (sousFamilleInfo) {
                message += `\nExamen: ${sousFamilleInfo.designation}`;
                message += `\nPrix standard: ${parseFloat(sousFamilleInfo.prix).toLocaleString('fr-FR')} DA`;
                
                // Afficher un message sp√©cifique si le montant diff√®re
                if (mode !== 'paiement_partiel' && sousFamilleInfo.prix !== montantPaye) {
                    message += `\nMontant pay√©: ${montantPaye.toLocaleString('fr-FR')} DA`;
                }
            }
            
            showToast(message, 'success');
            
            // Pr√©parer les informations pour l'impression
            const paiementInfo = {
                id: result.paiement_id || result.id,
                patient_nom: document.getElementById('patientSelect').selectedOptions[0].text.split('(')[0].trim(),
                patient_id: patientId,
                montant: montantPaye,
                montant_total: mode === 'a_terme' ? montantTotal : (sousFamilleInfo ? sousFamilleInfo.prix : null),
                mode_paiement: mode,
                type_paiement: typeExamen,
                sous_famille: sousFamilleInfo ? sousFamilleInfo.designation : null,
                prix_sous_famille: sousFamilleInfo ? sousFamilleInfo.prix : null,
                numero_cr: result.numero_cr || numeroCR,
                notes: notes,
                date_paiement: new Date().toISOString()
            };
            
            // Afficher la modal pour imprimer le re√ßu
            afficherModalChoixImpression(paiementInfo);
            
            // R√©initialiser le formulaire
            reinitialiserFormulaire();
            
            // Recharger toutes les donn√©es en arri√®re-plan
            setTimeout(async () => {
                try {
                    await Promise.all([
                        chargerPatientsDansSelect(),
                        chargerPatientsFiltre(),
                        loadDashboardData(),
                        loadPaiements(),
                        loadDettes()
                    ]);
                } catch (error) {
                    console.error('Erreur lors du rechargement des donn√©es:', error);
                }
            }, 1000);
            
        } else {
            const errorData = await response.json();
            
            // Gestion sp√©cifique des erreurs
            let errorMessage = errorData.erreur || 'Erreur lors de l\'enregistrement';
            
            // Suggestions bas√©es sur l'erreur
            if (errorMessage.includes('patient') || errorMessage.includes('Patient')) {
                errorMessage += '\nVeuillez v√©rifier la s√©lection du patient';
            } else if (errorMessage.includes('montant') || errorMessage.includes('Montant')) {
                errorMessage += '\nVeuillez v√©rifier les montants saisis';
            } else if (errorMessage.includes('sous_famille') || errorMessage.includes('sous-famille')) {
                errorMessage += '\nLa sous-famille s√©lectionn√©e n\'existe peut-√™tre plus';
                // Recharger les sous-familles
                setTimeout(() => {
                    const typeExamenValue = document.getElementById('typeExamen').value;
                    if (typeExamenValue) {
                        chargerSousFamilles();
                    }
                }, 2000);
            }
            
            throw new Error(errorMessage);
        }
    } catch (error) {
        console.error('Erreur enregistrement paiement:', error);
        
        // Afficher l'erreur de mani√®re lisible
        const errorLines = error.message.split('\n');
        const mainError = errorLines[0];
        const suggestions = errorLines.slice(1).filter(line => line.trim());
        
        let errorDisplay = mainError;
        if (suggestions.length > 0) {
            errorDisplay += '\n\nSuggestions:';
            suggestions.forEach(suggestion => {
                errorDisplay += `\n‚Ä¢ ${suggestion}`;
            });
        }
        
        showToast(errorDisplay, 'error');
        
        // Mettre en surbrillance les champs probl√©matiques
        if (error.message.includes('patient')) {
            document.getElementById('patientSelect').classList.add('border-red-500');
            setTimeout(() => {
                document.getElementById('patientSelect').classList.remove('border-red-500');
            }, 3000);
        }
        
        if (error.message.includes('montant')) {
            if (mode === 'a_terme') {
                document.getElementById('montantTotal').classList.add('border-red-500');
                setTimeout(() => {
                    document.getElementById('montantTotal').classList.remove('border-red-500');
                }, 3000);
            }
            document.getElementById('montantPaye').classList.add('border-red-500');
            setTimeout(() => {
                document.getElementById('montantPaye').classList.remove('border-red-500');
            }, 3000);
        }
        
        if (error.message.includes('type') || error.message.includes('examen')) {
            document.getElementById('typeExamen').classList.add('border-red-500');
            setTimeout(() => {
                document.getElementById('typeExamen').classList.remove('border-red-500');
            }, 3000);
        }
    }
}
       async function loadPaiements() {
    try {
        // Construire l'URL avec les filtres
        let url = `${API_BASE_URL}/paiements?page=${currentPage}&per_page=${perPage}`;
        
        if (filtresActifs.patient_id) {
            url += `&patient_id=${filtresActifs.patient_id}`;
        }
        if (filtresActifs.date_debut) {
            url += `&date_debut=${filtresActifs.date_debut}`;
        }
        if (filtresActifs.date_fin) {
            url += `&date_fin=${filtresActifs.date_fin}`;
        }
        if (filtresActifs.mode_paiement) {
            url += `&mode_paiement=${filtresActifs.mode_paiement}`;
        }

        const response = await fetch(url, {
            headers: { 'X-User-ID': currentUserId }
        });

        if (response.ok) {
            const data = await response.json();
            
            // G√©rer les deux formats de r√©ponse possibles
            if (data.paiements) {
                allPaiements = data.paiements;
                totalPaiements = data.pagination ? data.pagination.total : allPaiements.length;
            } else if (Array.isArray(data)) {
                allPaiements = data;
                totalPaiements = data.length;
            } else {
                allPaiements = [];
                totalPaiements = 0;
            }
            
            renderPaiementsList();
            updatePagination();
        } else {
            const errorText = await response.text();
            console.error('Erreur serveur:', errorText);
            showToast('Erreur lors du chargement des paiements', 'error');
        }
    } catch (error) {
        console.error('Erreur chargement paiements:', error);
        showToast('Erreur lors du chargement des paiements', 'error');
    }
}

  function renderPaiementsList() {
    const tbody = document.getElementById('listePaiements');
    
    if (allPaiements.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-4 text-gray-300"></i>
                    <p class="mt-2">Aucun paiement enregistr√©</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = allPaiements.map(p => {
        const dateObj = p.date_paiement ? new Date(p.date_paiement) : new Date();
        const date = dateObj.toLocaleDateString('fr-FR');
        const heure = dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        
        let modeBadge = '';
        if (p.mode_paiement === 'espece') {
            modeBadge = '<span class="badge-espece px-2 py-1 rounded-full text-xs">Comptant</span>';
        } else if (p.mode_paiement === 'a_terme') {
            modeBadge = '<span class="badge-a_terme px-2 py-1 rounded-full text-xs">√Ä terme</span>';
        } else {
            modeBadge = '<span class="badge-partiel px-2 py-1 rounded-full text-xs">Partiel</span>';
        }

        const typeInfo = getTypeExamen(p.numero_cr);

        return `
            <tr class="payment-card status-${p.mode_paiement} hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${date}</div>
                    <div class="text-sm text-gray-500">${heure}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm font-medium text-gray-900">${p.patient_nom_complet || p.patient_nom || 'N/A'}</div>
                    <div class="text-sm text-gray-500">${p.patient_telephone || ''}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <i class="fas ${typeInfo.icon} ${typeInfo.color} mr-2"></i>
                        <span class="text-sm text-gray-900">${typeInfo.text}</span>
                    </div>
                </td>
                <td class="px-6 py-4">
                    ${modeBadge}
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm font-bold text-gray-900">${parseFloat(p.montant || 0).toFixed(2)} DA</div>
                    ${p.mode_paiement === 'a_terme' && p.montant_total ? 
                        `<div class="text-xs text-gray-500">Total: ${parseFloat(p.montant_total || 0).toFixed(2)} DA</div>` : ''}
                </td>
                <td class="px-6 py-4">
                    ${getBadgeNumero(p.numero_cr)}
                </td>
                <td class="px-6 py-4 text-sm font-medium">
                    <div class="flex space-x-2">
                        <button onclick="viewPaymentDetail(${p.id})" 
                                class="text-indigo-600 hover:text-indigo-900 p-2 rounded-lg hover:bg-indigo-50 transition" 
                                title="Voir d√©tail">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="prepareAndShowPrintModal(${p.id})" 
                                class="text-green-600 hover:text-green-900 p-2 rounded-lg hover:bg-green-50 transition" 
                                title="Imprimer re√ßu">
                            <i class="fas fa-print"></i>
                        </button>
                        <button onclick="openAttachmentModal(${p.id}, '${p.numero_cr || ''}')" 
                                class="text-orange-600 hover:text-orange-900 p-2 rounded-lg hover:bg-orange-50 transition" 
                                title="Attacher fichier">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button onclick="deletePayment(${p.id})" 
                                class="text-red-600 hover:text-red-900 p-2 rounded-lg hover:bg-red-50 transition" 
                                title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}
function getTypeExamen(numeroCR) {
    if (!numeroCR) return { icon: 'fa-file-medical', color: 'text-gray-500', text: '-' };
    
    const typeCode = numeroCR.charAt(3);
    
    const types = {
        'H': { icon: 'fa-microscope', color: 'text-blue-600', text: 'Histologie' },
        'B': { icon: 'fa-syringe', color: 'text-red-600', text: 'Biopsie' },
        'C': { icon: 'fa-vials', color: 'text-green-600', text: 'Cytologie' },
        'F': { icon: 'fa-flask', color: 'text-purple-600', text: 'FCV' },
        'I': { icon: 'fa-dna', color: 'text-orange-600', text: 'Immuno-Histochimie' }
    };
    
    return types[typeCode] || { icon: 'fa-file-medical', color: 'text-gray-500', text: '-' };
}

// ‚úÖ Fonction pour d√©crire le num√©ro de re√ßu
function getDescriptionNumero(numeroCR) {
    if (!numeroCR || numeroCR.length < 7) return '';
    
    const numero = numeroCR.substring(0, 3);
    const typeCode = numeroCR.charAt(3);
    const annee = numeroCR.substring(4, 6);
    const moisCode = numeroCR.charAt(6);
    
    const types = {
        'H': 'Histologie',
        'B': 'Biopsie',
        'C': 'Cytologie',
        'F': 'FCV',
        'I': 'Immuno-Histo'
    };
    
    const mois = {
        'A': 'Jan', 'B': 'F√©v', 'C': 'Mar', 'D': 'Avr',
        'E': 'Mai', 'F': 'Juin', 'G': 'Juil', 'H': 'Ao√ªt',
        'I': 'Sep', 'J': 'Oct', 'K': 'Nov', 'L': 'D√©c'
    };
    
    const typeTexte = types[typeCode] || 'Inconnu';
    const moisTexte = mois[moisCode] || '?';
    
    return `#${numero} ‚Ä¢ ${typeTexte} ‚Ä¢ ${moisTexte} 20${annee}`;
}
        function toggleFiltres() {
            document.getElementById('filtresPanel').classList.toggle('open');
        }

function appliquerFiltres() {
    const patientId = document.getElementById('filterPatient').value;
    const typeExamen = document.getElementById('filterTypeExamen').value;
    const dateDebut = document.getElementById('filterDateDebut').value;
    const dateFin = document.getElementById('filterDateFin').value;
    const modePaiement = document.getElementById('filterModePaiement').value;
    
    // R√©initialiser les filtres
    filtresActifs = {};
    
    if (patientId) filtresActifs.patient_id = patientId;
    if (typeExamen) {
        // Convertir le code en type d'examen complet
        const typesExamen = {
            'H': 'histologie',
            'B': 'biopsie',
            'C': 'cytologie',
            'F': 'fcv',
            'I': 'immuno-histochimie'
        };
        filtresActifs.type_examen = typesExamen[typeExamen] || typeExamen;
    }
    if (dateDebut) filtresActifs.date_debut = dateDebut;
    if (dateFin) filtresActifs.date_fin = dateFin;
    if (modePaiement) filtresActifs.mode_paiement = modePaiement;
    
    // Recharger les paiements avec les filtres
    currentPage = 1;
    loadPaiements();
    
    showToast('Filtres appliqu√©s', 'success');
}
    function reinitialiserFormulaire() {
    // R√©initialiser tous les champs du formulaire
    document.getElementById('montantPaye').value = '';
    document.getElementById('montantTotal').value = '';
    document.getElementById('numeroCR').value = '';
    document.getElementById('notes').value = '';
    document.getElementById('patientSelect').value = '';
    document.getElementById('typeExamen').value = '';
    
    // Cacher les containers des sous-familles
    document.getElementById('sousFamilleContainer').classList.add('hidden');
    document.getElementById('prixExamenContainer').classList.add('hidden');
    
    // R√©initialiser le select des sous-familles
    document.getElementById('sousFamilleSelect').innerHTML = '<option value="">S√©lectionnez...</option>';
    currentSousFamilles = [];
    
    // Cacher les infos patient
    document.getElementById('patientInfo').classList.add('hidden');
    
    // R√©initialiser les radios √† "espece"
    document.querySelector('input[value="espece"]').checked = true;
    document.getElementById('montantTotalGroup').classList.add('hidden');
    
    // R√©initialiser le r√©capitulatif
    document.getElementById('recapContent').innerHTML = `
        <div class="text-center py-12 text-gray-400">
            <i class="fas fa-file-invoice-dollar text-4xl mb-4"></i>
            <p>Les d√©tails du paiement appara√Ætront ici</p>
        </div>
    `;
    document.getElementById('recapDetails').classList.add('hidden');
}

        function updatePagination() {
            const paginationDiv = document.getElementById('pagination');
            const start = (currentPage - 1) * perPage + 1;
            const end = Math.min(currentPage * perPage, totalPaiements);
            
            if (totalPaiements > perPage) {
                paginationDiv.classList.remove('hidden');
                document.getElementById('paginationStart').textContent = start;
                document.getElementById('paginationEnd').textContent = end;
                document.getElementById('paginationTotal').textContent = totalPaiements;
                document.getElementById('currentPage').textContent = currentPage;
            } else {
                paginationDiv.classList.add('hidden');
            }
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            const totalPages = Math.ceil(totalPaiements / perPage);
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadPaiements();
            }
        }

       async function loadDettes() {
    try {
        const response = await fetch(`${API_BASE_URL}/paiements/dettes-actives`, {
            headers: { 'X-User-ID': currentUserId }
        });

        if (response.ok) {
            const dettes = await response.json();
            allDettes = dettes;
            
            // Mettre √† jour le KPI patients detteurs
            document.getElementById('patientsDetteurs').textContent = dettes.length;
            
            renderDettesList();
            loadStatistiquesDettes();
        } else {
            console.error('Erreur chargement dettes:', await response.text());
        }
    } catch (error) {
        console.error('Erreur chargement dettes:', error);
        showToast('Erreur lors du chargement des dettes', 'error');
    }
}

      async function loadStatistiquesDettes() {
    try {
        const response = await fetch(`${API_BASE_URL}/paiements/statistiques-dettes`, {
            headers: { 'X-User-ID': currentUserId }
        });

        if (response.ok) {
            const stats = await response.json();
            
            if (stats.statistiques) {
                const stat = stats.statistiques;
                const montantDettes = parseFloat(stat.montant_total_dettes || 0);
                
                document.getElementById('dettesEnAttente').textContent = stat.nombre_patients_dette || 0;
                document.getElementById('montantTotalDu').textContent = `${montantDettes.toFixed(2)} DA`;
                document.getElementById('patientsConcernes').textContent = stat.nombre_patients_dette || 0;
                
                // Mettre √† jour aussi le KPI de dettes dans le header
                document.getElementById('totalDettes').textContent = stat.nombre_patients_dette || 0;
                document.getElementById('montantDettes').textContent = `${montantDettes.toFixed(2)} DA`;
            }
        }
    } catch (error) {
        console.error('Erreur chargement statistiques dettes:', error);
    }
}
      function renderDettesList() {
    const tbody = document.getElementById('listeDettes');
    
    if (allDettes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                    <i class="fas fa-check-circle text-4xl mb-4 text-green-300"></i>
                    <p class="mt-2">Aucune dette active</p>
                    <p class="text-sm mt-1">Tous les patients sont √† jour dans leurs paiements</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = allDettes.map(patient => {
        const dette = patient.montant_dette || Math.abs(parseFloat(patient.solde || 0));
        const nomComplet = `${patient.nom}${patient.prenom ? ' ' + patient.prenom : ''}`;
        const dernierPaiement = patient.dernier_paiement ? 
            new Date(patient.dernier_paiement).toLocaleDateString('fr-FR') : 'Aucun';
        
        // CORRIGER L'APPEL DE FONCTION - utiliser patient.id
        return `
            <tr class="hover:bg-red-50 transition-colors">
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10 bg-red-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${nomComplet}</div>
                            ${patient.age ? `<div class="text-xs text-gray-500">${patient.age} ans</div>` : ''}
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-900">${patient.telephone || '-'}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <i class="fas fa-money-bill-wave text-red-500 mr-2"></i>
                        <div>
                            <div class="text-lg font-bold text-red-600">${dette.toFixed(2)} DA</div>
                            ${patient.nombre_paiements ? 
                                `<div class="text-xs text-gray-500">${patient.nombre_paiements} paiement(s)</div>` : 
                                ''}
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-500">${dernierPaiement}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="flex space-x-2">
                        <!-- CORRECTION : Passer patient.id au lieu de pId -->
                        <button onclick="payerDette(${patient.id})" 
                                class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-4 py-2 rounded-lg transition flex items-center shadow-md hover:shadow-lg">
                            <i class="fas fa-money-bill-wave mr-2"></i>R√©gler
                        </button>
                        <!-- CORRECTION : Passer patient.id et nomComplet -->
                        <button onclick="voirHistoriquePatient(${patient.id}, '${nomComplet.replace(/'/g, "\\'")}')" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                            <i class="fas fa-history mr-2"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}
        async function updateStatistiques() {
            try {
                // R√©cup√©rer les param√®tres de p√©riode
                const periode = document.getElementById('statPeriode').value;
                let dateDebut, dateFin;
                
                const aujourdhui = new Date();
                
                switch(periode) {
                    case 'mois_courant':
                        dateDebut = new Date(aujourdhui.getFullYear(), aujourdhui.getMonth(), 1).toISOString().split('T')[0];
                        dateFin = aujourdhui.toISOString().split('T')[0];
                        break;
                    case 'mois_precedent':
                        const premierJourMoisPrecedent = new Date(aujourdhui.getFullYear(), aujourdhui.getMonth() - 1, 1);
                        const dernierJourMoisPrecedent = new Date(aujourdhui.getFullYear(), aujourdhui.getMonth(), 0);
                        dateDebut = premierJourMoisPrecedent.toISOString().split('T')[0];
                        dateFin = dernierJourMoisPrecedent.toISOString().split('T')[0];
                        break;
                    case 'personnalise':
                        dateDebut = document.getElementById('statDateDebut').value;
                        dateFin = document.getElementById('statDateFin').value;
                        break;
                    default:
                        dateDebut = '';
                        dateFin = '';
                }
                
                // Charger les statistiques
                let url = `${API_BASE_URL}/paiements/statistiques`;
                if (dateDebut) url += `?date_debut=${dateDebut}`;
                if (dateFin) url += `${dateDebut ? '&' : '?'}date_fin=${dateFin}`;
                
                const response = await fetch(url, {
                    headers: { 'X-User-ID': currentUserId }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    renderStatistiques(stats);
                }
            } catch (error) {
                console.error('Erreur chargement statistiques:', error);
            }
        }

        function renderStatistiques(stats) {
            // Mettre √† jour les graphiques
            renderChartPaiements(stats.par_mode_paiement);
            renderChartEvolution(stats.evolution_mensuelle);
            
            // Mettre √† jour le tableau Top Patients
            const tbody = document.getElementById('topPatients');
            if (stats.top_patients && stats.top_patients.length > 0) {
                tbody.innerHTML = stats.top_patients.map(patient => `
                    <tr class="hover:bg-yellow-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">
                                ${patient.nom}${patient.prenom ? ' ' + patient.prenom : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-bold text-green-600">${parseFloat(patient.total_paye || 0).toFixed(2)} DA</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${patient.nombre_paiements || 0}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-500">-</div>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                            Aucune donn√©e disponible
                        </td>
                    </tr>
                `;
            }
        }

       function renderChartPaiements(data) {
    const ctx = document.getElementById('chartPaiements');
    if (!ctx) return;
    
    const context = ctx.getContext('2d');
    
    // D√©truire le graphique existant seulement s'il existe
    if (window.chartPaiements && typeof window.chartPaiements.destroy === 'function') {
        window.chartPaiements.destroy();
    }
    
    // V√©rifier que nous avons des donn√©es
    if (!data || data.length === 0) {
        context.clearRect(0, 0, ctx.width, ctx.height);
        context.font = '14px Arial';
        context.fillStyle = '#999';
        context.textAlign = 'center';
        context.fillText('Aucune donn√©e disponible', ctx.width / 2, ctx.height / 2);
        return;
    }
    
    const labels = data.map(item => {
        switch(item.mode_paiement) {
            case 'espece': return 'Comptant';
            case 'a_terme': return '√Ä terme';
            case 'paiement_partiel': return 'Partiel';
            default: return item.mode_paiement;
        }
    });
    
    const montants = data.map(item => parseFloat(item.total || 0));
    const couleurs = ['#10b981', '#f59e0b', '#3b82f6'];
    
    window.chartPaiements = new Chart(context, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: montants,
                backgroundColor: couleurs,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.parsed.toFixed(2)} DA`;
                        }
                    }
                }
            }
        }
    });
}
       function renderChartEvolution(data) {
    const ctx = document.getElementById('chartEvolution');
    if (!ctx) return;
    
    const context = ctx.getContext('2d');
    
    // D√©truire le graphique existant seulement s'il existe
    if (window.chartEvolution && typeof window.chartEvolution.destroy === 'function') {
        window.chartEvolution.destroy();
    }
    
    // V√©rifier que nous avons des donn√©es
    if (!data || data.length === 0) {
        context.clearRect(0, 0, ctx.width, ctx.height);
        context.font = '14px Arial';
        context.fillStyle = '#999';
        context.textAlign = 'center';
        context.fillText('Aucune donn√©e disponible', ctx.width / 2, ctx.height / 2);
        return;
    }
    
    const labels = data.map(item => item.mois).reverse();
    const montants = data.map(item => parseFloat(item.total_montant || 0)).reverse();
    
    window.chartEvolution = new Chart(context, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Montant total (DA)',
                data: montants,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + ' DA';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Montant: ${context.parsed.y.toFixed(2)} DA`;
                        }
                    }
                }
            }
        }
    });
}
        async function genererRapportJournalier() {
    const date = document.getElementById('rapportDate').value;
    
    try {
        const response = await fetch(`${API_BASE_URL}/paiements/rapport-journalier?date=${date}`, {
            headers: { 'X-User-ID': currentUserId }
        });
        
        if (response.ok) {
            const rapport = await response.json();
            
            const modalContent = `
                <div class="space-y-6">
                    <div class="p-4 bg-indigo-50 rounded-lg">
                        <h4 class="text-lg font-semibold text-indigo-800">
                            <i class="fas fa-calendar-day mr-2"></i>Rapport Journalier
                        </h4>
                        <p class="text-indigo-700">Date: ${date}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-green-50 rounded-lg">
                            <p class="text-sm text-green-600">Total g√©n√©ral</p>
                            <p class="text-2xl font-bold text-green-700">${(rapport.total_general || 0).toFixed(2)} DA</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-600">Nombre de paiements</p>
                            <p class="text-2xl font-bold text-blue-700">${rapport.nombre_paiements || 0}</p>
                        </div>
                    </div>
                    
                    ${rapport.totaux_par_mode && rapport.totaux_par_mode.length > 0 ? `
                        <div class="space-y-2">
                            <h5 class="font-medium text-gray-700">D√©tails par mode de paiement:</h5>
                            ${rapport.totaux_par_mode.map(mode => `
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <span>${mode.mode_paiement === 'espece' ? 'Comptant' : 
                                           mode.mode_paiement === 'a_terme' ? '√Ä terme' : 
                                           'Partiel'}</span>
                                    <span class="font-bold">${parseFloat(mode.total || 0).toFixed(2)} DA</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p class="text-center text-gray-500 py-4">Aucun paiement pour cette date</p>'}
                    
                    <div class="pt-4 border-t border-gray-200 flex justify-end space-x-2">
                        <button onclick="imprimerRapportJournalier()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                            <i class="fas fa-print mr-2"></i>Imprimer
                        </button>
                        <button onclick="closeModalDetail()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
                            Fermer
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalDetailContent').innerHTML = modalContent;
            document.getElementById('modalDetail').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Erreur g√©n√©ration rapport:', error);
        showToast('Erreur lors de la g√©n√©ration du rapport', 'error');
    }
}
        async function exporterDonneesCompletes() {
            const format = document.getElementById('exportFormat').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/paiements/export?format=${format}`, {
                    headers: { 'X-User-ID': currentUserId }
                });
                
                if (response.ok) {
                    if (format === 'json') {
                        const data = await response.json();
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `paiements_export_${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                    } else if (format === 'csv') {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `paiements_export_${new Date().toISOString().split('T')[0]}.csv`;
                        a.click();
                    } else if (format === 'excel') {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `paiements_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                        a.click();
                    }
                    
                    showToast('Export termin√© avec succ√®s', 'success');
                } else {
                    throw new Error('Erreur lors de l\'export');
                }
            } catch (error) {
                console.error('Erreur export:', error);
                showToast('Erreur lors de l\'export des donn√©es', 'error');
            }
        }

      async function genererSynthesePatient() {
    const patientId = document.getElementById('rapportPatient').value;
    
    if (!patientId) {
        showToast('Veuillez s√©lectionner un patient', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/paiements/synthese-patient/${patientId}`, {
            headers: { 'X-User-ID': currentUserId }
        });
        
        if (response.ok) {
            const synthese = await response.json();
            const patient = synthese.patient;
            
            const modalContent = `
                <div class="space-y-6">
                    <div class="p-4 bg-indigo-50 rounded-lg">
                        <h4 class="text-lg font-semibold text-indigo-800 mb-2">
                            <i class="fas fa-user-chart mr-2"></i>Synth√®se Patient
                        </h4>
                        <p class="text-indigo-700 font-bold">${patient.nom}${patient.prenom ? ' ' + patient.prenom : ''}</p>
                        <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                            <div><span class="font-medium">√Çge:</span> ${patient.age || '-'}</div>
                            <div><span class="font-medium">Sexe:</span> ${patient.sexe || '-'}</div>
                            <div><span class="font-medium">T√©l√©phone:</span> ${patient.telephone || '-'}</div>
                            <div><span class="font-medium">Solde:</span> <span class="font-bold ${patient.solde < 0 ? 'text-red-600' : 'text-green-600'}">${parseFloat(patient.solde || 0).toFixed(2)} DA</span></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-green-50 rounded-lg">
                            <p class="text-sm text-green-600">Total pay√©</p>
                            <p class="text-2xl font-bold text-green-700">${(synthese.statistiques.total_paye || 0).toFixed(2)} DA</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-600">Nombre de paiements</p>
                            <p class="text-2xl font-bold text-blue-700">${synthese.statistiques.nombre_total_paiements || 0}</p>
                        </div>
                    </div>
                    
                    ${synthese.details_a_terme && synthese.details_a_terme.length > 0 ? `
                        <div class="space-y-2">
                            <h5 class="font-medium text-gray-700">D√©tails des paiements √† terme:</h5>
                            ${synthese.details_a_terme.map(detail => `
                                <div class="p-3 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm">${detail.date ? new Date(detail.date).toLocaleDateString('fr-FR') : '-'}</span>
                                        <span class="text-sm font-bold">${parseFloat(detail.montant_paye || 0).toFixed(2)} / ${parseFloat(detail.montant_total || 0).toFixed(2)} DA</span>
                                    </div>
                                    <div class="text-xs text-gray-600">
                                        Reste √† payer: <span class="font-bold">${parseFloat(detail.reste_a_payer || 0).toFixed(2)} DA</span>
                                        ${detail.numero_cr ? `‚Ä¢ Re√ßu: ${detail.numero_cr}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p class="text-center text-gray-500 py-4">Aucun paiement √† terme pour ce patient</p>'}
                    
                    <div class="pt-4 border-t border-gray-200 flex justify-end space-x-2">
                        <button onclick="imprimerSynthesePatient()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                            <i class="fas fa-print mr-2"></i>Imprimer
                        </button>
                        <button onclick="closeModalDetail()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
                            Fermer
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalDetailContent').innerHTML = modalContent;
            document.getElementById('modalDetail').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Erreur synth√®se patient:', error);
        showToast('Erreur lors de la g√©n√©ration de la synth√®se', 'error');
    }
}
function ouvrirModalHistorique(paiements, nomPatient) {
    const modalHTML = `
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Historique - ${nomPatient}</h2>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-600">‚úï</button>
            </div>
            
            ${paiements.length > 0 ? `
                <table class="min-w-full border">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="p-2 border">Date</th>
                            <th class="p-2 border">Montant</th>
                            <th class="p-2 border">Mode</th>
                            <th class="p-2 border">Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paiements.map(p => `
                            <tr>
                                <td class="p-2 border">${p.date_paiement || '-'}</td>
                                <td class="p-2 border">${p.montant || '0'} DA</td>
                                <td class="p-2 border">${p.mode_paiement || '-'}</td>
                                <td class="p-2 border">${p.statut || 'pay√©'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : `<p class="text-gray-500 text-center py-8">Aucun paiement trouv√©</p>`}
            
            <div class="mt-4 text-right">
                <button onclick="this.closest('.fixed').remove()" 
                        class="bg-gray-500 text-white px-4 py-2 rounded">Fermer</button>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}
     async function voirHistoriquePatient(pId, nomPatient) {
    try {
        console.log(`üîç Chargement historique patient ${pId}: ${nomPatient}`);
        
        const userId = localStorage.getItem('userId');
        if (!userId) {
            showToast('Veuillez vous reconnecter', 'error');
            return;
        }
        
        // Essayer plusieurs endpoints possibles
        const endpoints = [
            `${API_BASE_URL}/paiements/patient/${pId}`,
            `${API_BASE_URL}/paiements?patient_id=${pId}`,
            `${API_BASE_URL}/patients/${pId}/paiements`
        ];
        
        let paiements = [];
        let lastError = null;
        
        // Essayer chaque endpoint jusqu'√† ce qu'un fonctionne
        for (const endpoint of endpoints) {
            try {
                console.log(`üîÑ Essai endpoint: ${endpoint}`);
                
                const response = await fetch(endpoint, {
                    headers: { 'X-User-ID': userId }
                });
                
                if (!response.ok) {
                    console.log(`‚ùå Endpoint ${endpoint}: ${response.status}`);
                    continue;
                }
                
                const result = await response.json();
                console.log(`üì¶ R√©sultat de ${endpoint}:`, result);
                
                // Fonction pour extraire les paiements
                const extractPaiements = (data) => {
                    if (Array.isArray(data)) return data;
                    if (data?.paiements) return data.paiements;
                    if (data?.data?.paiements) return data.data.paiements;
                    if (data?.historique) return data.historique;
                    if (data?.payments) return data.payments;
                    return [];
                };
                
                paiements = extractPaiements(result);
                
                if (Array.isArray(paiements) && paiements.length > 0) {
                    console.log(`‚úÖ ${paiements.length} paiement(s) trouv√©(s) avec ${endpoint}`);
                    break;
                }
                
            } catch (err) {
                lastError = err;
                console.log(`‚ö†Ô∏è Erreur avec ${endpoint}:`, err.message);
                continue;
            }
        }
        
        if (paiements.length === 0) {
            console.log('‚ÑπÔ∏è Aucun paiement trouv√© pour ce patient');
        }
        
        // Ouvrir le modal avec les paiements trouv√©s
        ouvrirModalHistorique(paiements, nomPatient);
        
    } catch (error) {
        console.error('üî• Erreur critique dans voirHistoriquePatient:', error);
        showToast('Impossible de charger l\'historique', 'error');
        
        // Ouvrir un modal vide
        ouvrirModalHistorique([], nomPatient);
    }
}async function viewPaymentDetail(paymentId) {
    try {
        const response = await fetch(`${API_BASE_URL}/paiements/${paymentId}`, {
            headers: { 'X-User-ID': currentUserId }
        });

        if (!response.ok) {
            throw new Error("Erreur lors du chargement des d√©tails du paiement");
        }

        const payment = await response.json();

        // Calcul du reste √† payer si paiement √† terme
        const reste = payment.mode_paiement === 'a_terme' && payment.montant_total
            ? (parseFloat(payment.montant_total) - parseFloat(payment.montant)).toFixed(2)
            : 0;

        const modalContent = `
            <div class="space-y-6">
                <!-- En-t√™te avec infos principales -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="p-4 bg-indigo-50 rounded-lg">
                        <p class="text-sm text-indigo-600 font-medium">Patient</p>
                        <p class="text-lg font-semibold text-gray-900 mt-1">
                            ${payment.patient_nom_complet || payment.patient_nom || '‚Äî'}
                        </p>
                    </div>
                    
                    <div class="p-4 bg-green-50 rounded-lg">
                        <p class="text-sm text-green-600 font-medium">Montant pay√©</p>
                        <p class="text-2xl font-bold text-green-700 mt-1">
                            ${parseFloat(payment.montant || 0).toFixed(2)} DA
                        </p>
                    </div>
                </div>

                <!-- Informations d√©taill√©es -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 font-medium">Date</p>
                        <p class="font-medium mt-1">
                            ${new Date(payment.date_paiement).toLocaleDateString('fr-FR', {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            })}
                            <br>
                            <span class="text-sm text-gray-500">
                                ${new Date(payment.date_paiement).toLocaleTimeString('fr-FR', {
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </span>
                        </p>
                    </div>

                    <div class="p-4 bg-purple-50 rounded-lg">
                        <p class="text-sm text-purple-600 font-medium">Type d'acte</p>
                        <p class="font-medium mt-1">${payment.type_paiement || '‚Äî'}</p>
                    </div>
                </div>

                <!-- Bloc paiement √† terme (si concern√©) -->
                ${payment.mode_paiement === 'a_terme' && payment.montant_total ? `
                    <div class="p-5 bg-orange-50 rounded-lg border border-orange-200">
                        <p class="text-sm font-medium text-orange-700 mb-3">Paiement √† terme</p>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-700">Montant total de la facture :</span>
                                <span class="font-bold">${parseFloat(payment.montant_total).toFixed(2)} DA</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">Montant vers√© :</span>
                                <span class="font-bold text-green-700">${parseFloat(payment.montant).toFixed(2)} DA</span>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-orange-200 mt-2">
                                <span class="text-gray-800 font-medium">Reste √† payer :</span>
                                <span class="font-bold text-red-600 text-lg">${reste} DA</span>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Notes -->
                ${payment.notes ? `
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm font-medium text-blue-600 mb-2">Notes / Observations</p>
                        <p class="text-gray-700 whitespace-pre-line">${payment.notes}</p>
                    </div>
                ` : ''}

                <!-- Boutons d'action -->
                <div class="pt-6 border-t border-gray-200 flex flex-col sm:flex-row justify-end gap-3">
                    <button onclick="prepareAndShowPrintModal(${payment.id})"
                            class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-6 py-3 rounded-lg transition flex items-center justify-center shadow-sm font-medium">
                        <i class="fas fa-print mr-2"></i>
                        Imprimer Re√ßu
                    </button>
                    
                    <button onclick="closeModalDetail()"
                            class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg transition font-medium">
                        Fermer
                    </button>
                </div>
            </div>
        `;

        document.getElementById('modalDetailContent').innerHTML = modalContent;
        document.getElementById('modalDetail').classList.remove('hidden');

    } catch (error) {
        console.error('Erreur chargement d√©tail paiement:', error);
        showToast('Impossible de charger les d√©tails du paiement', 'error');
    }
}
        async function prepareAndShowPrintModal(paymentId) {
    try {
        const res = await fetch(`${API_BASE_URL}/paiements/${paymentId}`, {
            headers: { 'X-User-ID': currentUserId }
        });

        if (!res.ok) throw new Error("Erreur chargement paiement");

        const paiement = await res.json();

        // Format compatible avec afficherModalChoixImpression()
        const paiementInfo = {
            id: paiement.id,
            patient_nom: paiement.patient_nom_complet || paiement.patient_nom || "‚Äî",
            montant: paiement.montant,
            montant_total: paiement.montant_total || null,
            mode_paiement: paiement.mode_paiement,
            type_paiement: paiement.type_paiement || "‚Äî",
            numero_cr: paiement.numero_cr || "‚Äî",
            notes: paiement.notes || "",
            date_paiement: paiement.date_paiement || new Date().toISOString()
        };

        // On r√©utilise exactement le m√™me modal de choix que pour les nouveaux paiements
        afficherModalChoixImpression(paiementInfo);

    } catch (err) {
        console.error("Erreur pr√©paration modal impression:", err);
        showToast("Impossible de pr√©parer l'impression", "error");
    }
}
async function prepareAndShowPrintModal(paymentId) {
    try {
        // R√©cup√©rer les donn√©es compl√®tes du paiement
        const res = await fetch(`${API_BASE_URL}/paiements/${paymentId}`, {
            headers: { 'X-User-ID': currentUserId }
        });

        if (!res.ok) {
            throw new Error("Impossible de charger les d√©tails du paiement");
        }

        const paiement = await res.json();

        // Format compatible avec ce que attend genererRecuA4 / genererRecuTicket
        const paiementInfo = {
            id: paiement.id,
            patient_nom: paiement.patient_nom_complet || paiement.patient_nom || "‚Äî",
            montant: paiement.montant,
            montant_total: paiement.montant_total || null,
            mode_paiement: paiement.mode_paiement,
            type_paiement: paiement.type_paiement || "‚Äî",
            numero_cr: paiement.numero_cr || "‚Äî",
            notes: paiement.notes || "",
            date_paiement: paiement.date_paiement || new Date().toISOString()
        };

        // ‚Üí On r√©utilise exactement la m√™me logique que apr√®s l'enregistrement
        afficherModalChoixImpression(paiementInfo);

    } catch (err) {
        console.error("Erreur pr√©paration impression:", err);
        showToast("Impossible de pr√©parer l'impression", "error");
    }
}
        function closeModalDetail() {
            document.getElementById('modalDetail').classList.add('hidden');
        }

      async function payerDette(patientId) {
    try {
        // 1. Chercher d'abord dans les dettes charg√©es
        const patientDette = allDettes.find(p => p.id == patientId);
        
        if (!patientDette) {
            // 2. Si non trouv√©, charger le patient depuis l'API
            const response = await fetch(`${API_BASE_URL}/patients/${patientId}`, {
                headers: { 'X-User-ID': currentUserId }
            });
            
            if (!response.ok) {
                throw new Error('Patient non trouv√©');
            }
            
            const patient = await response.json();
            
            // S√©lectionner le patient dans le formulaire
            document.getElementById('patientSelect').value = patientId;
            
            // Calculer la dette (solde n√©gatif)
            const dette = Math.abs(parseFloat(patient.solde || 0));
            
            // Configurer le formulaire pour paiement partiel
            document.querySelector('input[value="paiement_partiel"]').checked = true;
            toggleMontantTotal();
            
            // Mettre √† jour les infos patient
            setTimeout(() => {
                updatePatientInfo();
                document.getElementById('montantPaye').value = dette;
                document.getElementById('montantPaye').focus();
                updateRecap();
            }, 100);
            
            // Passer √† l'onglet nouveau paiement
            showTab('nouveau');
            
            showToast(`Dette de ${patient.nom}${patient.prenom ? ' ' + patient.prenom : ''}: ${dette.toFixed(2)} DA`, 'success');
            return;
        }
        
        // Si trouv√© dans allDettes
        const dette = patientDette.montant_dette || Math.abs(parseFloat(patientDette.solde || 0));
        const nomComplet = `${patientDette.nom}${patientDette.prenom ? ' ' + patientDette.prenom : ''}`;
        
        // S√©lectionner le patient
        document.getElementById('patientSelect').value = patientId;
        
        // Configurer pour paiement partiel
        document.querySelector('input[value="paiement_partiel"]').checked = true;
        toggleMontantTotal();
        
        // Mettre √† jour les infos patient
        setTimeout(() => {
            updatePatientInfo();
            document.getElementById('montantPaye').value = dette;
            document.getElementById('montantPaye').focus();
            updateRecap();
        }, 100);
        
        // Passer √† l'onglet nouveau paiement
        showTab('nouveau');
        
        showToast(`Dette de ${nomComplet}: ${dette.toFixed(2)} DA`, 'success');
        
    } catch (error) {
        console.error('Erreur pr√©paration r√®glement dette:', error);
        showToast('Impossible de charger les informations du patient', 'error');
    }
}
        async function deletePayment(paymentId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce paiement ? Cette action est irr√©versible.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/paiements/${paymentId}`, {
                    method: 'DELETE',
                    headers: { 'X-User-ID': currentUserId }
                });

                if (response.ok) {
                    showToast('Paiement supprim√© avec succ√®s', 'success');
                    loadDashboardData();
                    loadPaiements();
                    loadDettes();
                } else {
                    throw new Error('Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur suppression paiement:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        function printReceipt(paymentId) {
            // Impl√©mentez la g√©n√©ration du re√ßu ici
            showToast('Fonctionnalit√© d\'impression en d√©veloppement', 'warning');
        }

        function exporterExcel() {
    if (allPaiements.length === 0) {
        showToast('Aucun paiement √† exporter', 'warning');
        return;
    }

    // Cr√©er le contenu CSV
    const headers = ['Date', 'Heure', 'Patient', 'T√©l√©phone', 'Type', 'Mode Paiement', 'Montant (DA)', 'Montant Total (DA)', 'Reste (DA)', 'Num√©ro CR', 'Notes'];
    const rows = allPaiements.map(p => {
        const dateObj = p.date_paiement ? new Date(p.date_paiement) : new Date();
        const date = dateObj.toLocaleDateString('fr-FR');
        const heure = dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        
        const modePaiement = p.mode_paiement === 'espece' ? 'Comptant' : 
                            p.mode_paiement === 'a_terme' ? '√Ä terme' : 'Partiel';
        
        const montantTotal = p.montant_total ? parseFloat(p.montant_total).toFixed(2) : '';
        const reste = p.montant_total ? (parseFloat(p.montant_total) - parseFloat(p.montant)).toFixed(2) : '';
        
        return [
            date,
            heure,
            p.patient_nom_complet || p.patient_nom || '',
            p.patient_telephone || '',
            p.type_paiement || '',
            modePaiement,
            parseFloat(p.montant || 0).toFixed(2),
            montantTotal,
            reste,
            p.numero_cr || '',
            p.notes || ''
        ];
    });

    // Convertir en CSV
    let csvContent = '\uFEFF'; // BOM pour Excel
    csvContent += headers.join(';') + '\n';
    rows.forEach(row => {
        csvContent += row.map(cell => `"${cell}"`).join(';') + '\n';
    });

    // Cr√©er et t√©l√©charger le fichier
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    const dateExport = new Date().toISOString().split('T')[0];
    link.setAttribute('href', url);
    link.setAttribute('download', `paiements_${dateExport}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast(`${allPaiements.length} paiement(s) export√©(s) avec succ√®s`, 'success');
}

function imprimerListe() {
    if (allPaiements.length === 0) {
        showToast('Aucun paiement √† imprimer', 'warning');
        return;
    }

    // Calculer les totaux
    const totalGeneral = allPaiements.reduce((sum, p) => sum + parseFloat(p.montant || 0), 0);
    const totalComptant = allPaiements.filter(p => p.mode_paiement === 'espece')
                                     .reduce((sum, p) => sum + parseFloat(p.montant || 0), 0);
    const totalATerme = allPaiements.filter(p => p.mode_paiement === 'a_terme')
                                   .reduce((sum, p) => sum + parseFloat(p.montant || 0), 0);
    const totalPartiel = allPaiements.filter(p => p.mode_paiement === 'paiement_partiel')
                                    .reduce((sum, p) => sum + parseFloat(p.montant || 0), 0);

    // Cr√©er le contenu HTML pour l'impression
    const printWindow = window.open('', '', 'height=800,width=1000');
    
    const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Liste des Paiements - ANAPATH</title>
            <style>
                @media print {
                    @page { margin: 1cm; }
                    body { margin: 0; }
                    .no-print { display: none; }
                }
                body {
                    font-family: Arial, sans-serif;
                    padding: 20px;
                    color: #333;
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 3px solid #4f46e5;
                    padding-bottom: 20px;
                }
                .header h1 {
                    color: #4f46e5;
                    margin: 0;
                    font-size: 28px;
                }
                .header p {
                    margin: 5px 0;
                    color: #666;
                }
                .info-box {
                    background: #f8fafc;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 20px;
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 10px;
                }
                .info-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 8px;
                    background: white;
                    border-radius: 4px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                    font-size: 12px;
                }
                th {
                    background: #4f46e5;
                    color: white;
                    padding: 12px 8px;
                    text-align: left;
                    font-weight: 600;
                }
                td {
                    padding: 10px 8px;
                    border-bottom: 1px solid #e5e7eb;
                }
                tr:hover {
                    background: #f9fafb;
                }
                .mode-comptant { color: #10b981; font-weight: 600; }
                .mode-a-terme { color: #f59e0b; font-weight: 600; }
                .mode-partiel { color: #3b82f6; font-weight: 600; }
                .totaux {
                    margin-top: 30px;
                    padding: 20px;
                    background: #f8fafc;
                    border-radius: 8px;
                    border-left: 4px solid #4f46e5;
                }
                .totaux h3 {
                    margin-top: 0;
                    color: #4f46e5;
                }
                .total-row {
                    display: flex;
                    justify-content: space-between;
                    padding: 8px 0;
                    border-bottom: 1px solid #e5e7eb;
                }
                .total-row:last-child {
                    border-bottom: none;
                    font-weight: bold;
                    font-size: 16px;
                    color: #4f46e5;
                    padding-top: 15px;
                    margin-top: 10px;
                    border-top: 2px solid #4f46e5;
                }
                .footer {
                    margin-top: 40px;
                    text-align: center;
                    color: #666;
                    font-size: 11px;
                    padding-top: 20px;
                    border-top: 1px solid #e5e7eb;
                }
                .btn-print {
                    background: #4f46e5;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    margin-bottom: 20px;
                }
                .btn-print:hover {
                    background: #4338ca;
                }
            </style>
        </head>
        <body>
            <button onclick="window.print()" class="btn-print no-print">üñ®Ô∏è Imprimer</button>
            
            <div class="header">
                <h1>üìã LISTE DES PAIEMENTS</h1>
                <p><strong>ANAPATH - Gestion des Paiements</strong></p>
                <p>Date d'√©dition: ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}</p>
            </div>

            <div class="info-box">
                <div class="info-item">
                    <span>Nombre total de paiements:</span>
                    <strong>${allPaiements.length}</strong>
                </div>
                <div class="info-item">
                    <span>Montant total encaiss√©:</span>
                    <strong>${totalGeneral.toFixed(2)} DA</strong>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Patient</th>
                        <th>Type</th>
                        <th>Mode</th>
                        <th style="text-align: right">Montant</th>
                        <th>N¬∞ CR</th>
                    </tr>
                </thead>
                <tbody>
                    ${allPaiements.map(p => {
                        const dateObj = p.date_paiement ? new Date(p.date_paiement) : new Date();
                        const date = dateObj.toLocaleDateString('fr-FR');
                        const heure = dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                        
                        let modeClass = 'mode-comptant';
                        let modeText = 'Comptant';
                        if (p.mode_paiement === 'a_terme') {
                            modeClass = 'mode-a-terme';
                            modeText = '√Ä terme';
                        } else if (p.mode_paiement === 'paiement_partiel') {
                            modeClass = 'mode-partiel';
                            modeText = 'Partiel';
                        }
                        
                        return `
                            <tr>
                                <td>${date}<br><small style="color: #666;">${heure}</small></td>
                                <td>
                                    <strong>${p.patient_nom_complet || p.patient_nom || 'N/A'}</strong>
                                    ${p.patient_telephone ? `<br><small style="color: #666;">${p.patient_telephone}</small>` : ''}
                                </td>
                                <td>${p.type_paiement}</td>
                                <td class="${modeClass}">${modeText}</td>
                                <td style="text-align: right; font-weight: 600;">
                                    ${parseFloat(p.montant || 0).toFixed(2)} DA
                                    ${p.montant_total ? `<br><small style="color: #666;">/${parseFloat(p.montant_total).toFixed(2)} DA</small>` : ''}
                                </td>
                                <td>${p.numero_cr || '-'}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>

            <div class="totaux">
                <h3>üí∞ R√©capitulatif des Totaux</h3>
                <div class="total-row">
                    <span>Paiements comptant (${allPaiements.filter(p => p.mode_paiement === 'espece').length}):</span>
                    <span class="mode-comptant">${totalComptant.toFixed(2)} DA</span>
                </div>
                <div class="total-row">
                    <span>Paiements √† terme (${allPaiements.filter(p => p.mode_paiement === 'a_terme').length}):</span>
                    <span class="mode-a-terme">${totalATerme.toFixed(2)} DA</span>
                </div>
                <div class="total-row">
                    <span>Paiements partiels (${allPaiements.filter(p => p.mode_paiement === 'paiement_partiel').length}):</span>
                    <span class="mode-partiel">${totalPartiel.toFixed(2)} DA</span>
                </div>
                <div class="total-row">
                    <span>TOTAL G√âN√âRAL:</span>
                    <span>${totalGeneral.toFixed(2)} DA</span>
                </div>
            </div>

            <div class="footer">
                <p>Document g√©n√©r√© automatiquement par ANAPATH - Syst√®me de Gestion des Paiements</p>
                <p>Ce document est confidentiel et ne peut √™tre reproduit sans autorisation</p>
            </div>
      
        </body>
        </html>
    `;
    
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    
    // Attendre que le contenu soit charg√© avant d'ouvrir la bo√Æte de dialogue d'impression
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.focus();
        }, 250);
    };
    
    showToast('Aper√ßu avant impression g√©n√©r√©', 'success');
}

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            toast.className = `toast ${type}`;
            icon.className = `fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-check-circle'} mr-2`;
            msg.textContent = message;

            toast.classList.add('show');
            toast.classList.remove('hide');

            setTimeout(() => {
                toast.classList.add('hide');
                toast.classList.remove('show');
            }, 3000);
        }
        // Variables globales pour l'impression
let paiementEnCours = null;

function afficherModalChoixImpression(paiementInfo) {
    paiementEnCours = paiementInfo;
    document.getElementById('modalChoixImpression').classList.remove('hidden');
}

function fermerModalImpression() {
    document.getElementById('modalChoixImpression').classList.add('hidden');
    paiementEnCours = null;
    // Revenir √† l'onglet liste apr√®s fermeture
    showTab('liste');
}

function imprimerRecu(format) {
    if (!paiementEnCours) {
        showToast('Erreur: Aucun paiement √† imprimer', 'error');
        return;
    }

    if (format === 'a4') {
        genererRecuA4(paiementEnCours);
    } else if (format === 'ticket') {
        genererRecuTicket(paiementEnCours);
    } else if (format === 'vignette') {
        genererRecuVignette(paiementEnCours); // Nouvelle fonction
    }

    // Fermer la modal apr√®s impression
    setTimeout(() => {
        fermerModalImpression();
    }, 500);
}

function genererRecuA4(paiement) {
    const dateObj = new Date(paiement.date_paiement);
    const date = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const heure = dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    
    const modePaiementTexte = paiement.mode_paiement === 'espece' ? 'Comptant' : 
                             paiement.mode_paiement === 'a_terme' ? '√Ä Terme' : 'Paiement Partiel';
    
    const reste = paiement.montant_total ? (parseFloat(paiement.montant_total) - parseFloat(paiement.montant)) : 0;

    const printWindow = window.open('', '', 'height=800,width=600');
    
    const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Re√ßu de Paiement - ${paiement.numero_cr || 'N/A'}</title>
            <style>
                @media print {
                    @page { 
                        size: A4;
                        margin: 2cm;
                    }
                    body { margin: 0; }
                    .no-print { display: none !important; }
                }
                
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body {
                    font-family: 'Arial', sans-serif;
                    color: #333;
                    line-height: 1.6;
                    padding: 20px;
                }
                
                .recu-container {
                    max-width: 800px;
                    margin: 0 auto;
                    border: 2px solid #4f46e5;
                    border-radius: 10px;
                    overflow: hidden;
                }
                
                .header {
                    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
                    color: white;
                    padding: 30px;
                    text-align: center;
                }
                
                .header h1 {
                    font-size: 32px;
                    margin-bottom: 5px;
                    text-transform: uppercase;
                    letter-spacing: 2px;
                }
                
                .header p {
                    font-size: 14px;
                    opacity: 0.9;
                }
                
                .numero-recu {
                    background: white;
                    color: #4f46e5;
                    display: inline-block;
                    padding: 8px 20px;
                    border-radius: 20px;
                    font-weight: bold;
                    margin-top: 15px;
                    font-size: 16px;
                }
                
                .content {
                    padding: 40px;
                }
                
                .info-section {
                    margin-bottom: 30px;
                }
                
                .info-section h3 {
                    color: #4f46e5;
                    font-size: 14px;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    margin-bottom: 15px;
                    border-bottom: 2px solid #e5e7eb;
                    padding-bottom: 8px;
                }
                
                .info-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 15px;
                }
                
                .info-item {
                    display: flex;
                    flex-direction: column;
                }
                
                .info-label {
                    font-size: 11px;
                    color: #6b7280;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 4px;
                }
                
                .info-value {
                    font-size: 16px;
                    font-weight: 600;
                    color: #1f2937;
                }
                
                .montant-principal {
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    padding: 25px;
                    border-radius: 10px;
                    text-align: center;
                    margin: 30px 0;
                }
                
                .montant-principal .label {
                    font-size: 14px;
                    opacity: 0.9;
                    margin-bottom: 10px;
                }
                
                .montant-principal .montant {
                    font-size: 42px;
                    font-weight: bold;
                    letter-spacing: 1px;
                }
                
                .details-paiement {
                    background: #f9fafb;
                    padding: 20px;
                    border-radius: 8px;
                    border-left: 4px solid #4f46e5;
                }
                
                .detail-row {
                    display: flex;
                    justify-content: space-between;
                    padding: 10px 0;
                    border-bottom: 1px solid #e5e7eb;
                }
                
                .detail-row:last-child {
                    border-bottom: none;
                }
                
                .detail-label {
                    color: #6b7280;
                }
                
                .detail-value {
                    font-weight: 600;
                    color: #1f2937;
                }
                
                .reste-a-payer {
                    color: #dc2626;
                    font-size: 18px;
                }
                
                .notes {
                    background: #fef3c7;
                    border-left: 4px solid #f59e0b;
                    padding: 15px;
                    margin: 20px 0;
                    border-radius: 4px;
                }
                
                .notes h4 {
                    color: #92400e;
                    font-size: 12px;
                    margin-bottom: 8px;
                    text-transform: uppercase;
                }
                
                .notes p {
                    color: #78350f;
                    font-size: 14px;
                }
                
                .footer {
                    background: #f9fafb;
                    padding: 25px 40px;
                    border-top: 2px solid #e5e7eb;
                    text-align: center;
                }
                
                .signature-section {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 40px;
                    margin-top: 40px;
                    text-align: center;
                }
                
                .signature-box {
                    padding: 15px;
                }
                
                .signature-line {
                    border-top: 2px solid #9ca3af;
                    margin-top: 60px;
                    padding-top: 10px;
                    color: #6b7280;
                    font-size: 12px;
                }
                
                .footer-info {
                    margin-top: 30px;
                    font-size: 11px;
                    color: #6b7280;
                    line-height: 1.8;
                }
                
                .btn-print {
                    background: #4f46e5;
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 16px;
                    margin: 20px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    transition: all 0.3s;
                }
                
                .btn-print:hover {
                    background: #4338ca;
                    transform: translateY(-2px);
                    box-shadow: 0 6px 8px rgba(0,0,0,0.15);
                }
                
                .watermark {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%) rotate(-45deg);
                    font-size: 100px;
                    color: rgba(79, 70, 229, 0.05);
                    font-weight: bold;
                    z-index: -1;
                    pointer-events: none;
                }
            </style>
        </head>
        <body>
            <div class="watermark">ANAPATH</div>
            
            <button onclick="window.print()" class="btn-print no-print">
                üñ®Ô∏è Imprimer le Re√ßu
            </button>
            
            <div class="recu-container">
                <div class="header">
                    <h1>üè• ANAPATH</h1>
                    <p>Centre d'Anatomie Pathologique</p>
                    <div class="numero-recu">
                        Re√ßu N¬∞ ${paiement.numero_cr || 'Non sp√©cifi√©'}
                    </div>
                </div>
                
                <div class="content">
                    <div class="info-section">
                        <h3>üìÖ Informations de Transaction</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Date</span>
                                <span class="info-value">${date}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Heure</span>
                                <span class="info-value">${heure}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h3>üë§ Informations Patient</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Nom du Patient</span>
                                <span class="info-value">${paiement.patient_nom}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Type d'Acte</span>
                                <span class="info-value">${paiement.type_paiement}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="montant-principal">
                        <div class="label">MONTANT PAY√â</div>
                        <div class="montant">${parseFloat(paiement.montant).toFixed(2)} DA</div>
                    </div>
                    
                    <div class="details-paiement">
                        <div class="detail-row">
                            <span class="detail-label">Mode de paiement:</span>
                            <span class="detail-value">${modePaiementTexte}</span>
                        </div>
                        ${paiement.montant_total ? `
                            <div class="detail-row">
                                <span class="detail-label">Montant total de la facture:</span>
                                <span class="detail-value">${parseFloat(paiement.montant_total).toFixed(2)} DA</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Montant vers√©:</span>
                                <span class="detail-value">${parseFloat(paiement.montant).toFixed(2)} DA</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Reste √† payer:</span>
                                <span class="detail-value reste-a-payer">${reste.toFixed(2)} DA</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${paiement.notes ? `
                        <div class="notes">
                            <h4>üìù Notes</h4>
                            <p>${paiement.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="signature-section">
                        <div class="signature-box">
                            <div class="signature-line">Signature du Patient</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">Signature du Caissier</div>
                        </div>
                    </div>
                </div>
                
                <div class="footer">
                    <div class="footer-info">
                        <strong>ANAPATH - Centre d'Anatomie Pathologique</strong><br>
                        Merci de votre confiance | Ce re√ßu fait foi de paiement<br>
                        Pour toute r√©clamation, veuillez conserver ce re√ßu
                    </div>
                </div>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.focus();
        }, 250);
    };
}

function genererRecuTicket(paiement) {
    const dateObj = new Date(paiement.date_paiement);
    const date = dateObj.toLocaleDateString('fr-FR');
    const heure = dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    
    const modePaiementTexte = paiement.mode_paiement === 'espece' ? 'COMPTANT' : 
                             paiement.mode_paiement === 'a_terme' ? 'A TERME' : 'PARTIEL';
    
    const reste = paiement.montant_total ? (parseFloat(paiement.montant_total) - parseFloat(paiement.montant)) : 0;

    const printWindow = window.open('', '', 'height=600,width=320');
    
    const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Ticket - ${paiement.numero_cr || 'N/A'}</title>
            <style>
                @media print {
                    @page { 
                        size: 80mm auto;
                        margin: 0;
                    }
                    body { margin: 0; }
                    .no-print { display: none !important; }
                }
                
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body {
                    font-family: 'Courier New', monospace;
                    width: 80mm;
                    background: white;
                    color: #000;
                    font-size: 12px;
                    line-height: 1.4;
                }
                
                .ticket {
                    padding: 10px;
                }
                
                .header {
                    text-align: center;
                    border-bottom: 2px dashed #000;
                    padding-bottom: 10px;
                    margin-bottom: 10px;
                }
                
                .header h1 {
                    font-size: 20px;
                    font-weight: bold;
                    margin-bottom: 3px;
                }
                
                .header p {
                    font-size: 10px;
                    margin: 2px 0;
                }
                
                .numero-recu {
                    text-align: center;
                    font-size: 14px;
                    font-weight: bold;
                    margin: 10px 0;
                    padding: 5px;
                    border: 2px solid #000;
                }
                
                .section {
                    margin: 10px 0;
                    padding: 8px 0;
                    border-bottom: 1px dashed #000;
                }
                
                .section:last-child {
                    border-bottom: 2px dashed #000;
                }
                
                .row {
                    display: flex;
                    justify-content: space-between;
                    margin: 4px 0;
                }
                
                .label {
                    font-size: 11px;
                }
                
                .value {
                    font-weight: bold;
                    text-align: right;
                }
                
                .montant-principal {
                    text-align: center;
                    margin: 15px 0;
                    padding: 10px;
                    background: #000;
                    color: #fff;
                }
                
                .montant-principal .label {
                    font-size: 10px;
                    margin-bottom: 5px;
                }
                
                .montant-principal .montant {
                    font-size: 24px;
                    font-weight: bold;
                    letter-spacing: 1px;
                }
                
                .detail-important {
                    font-size: 13px;
                    font-weight: bold;
                }
                
                .reste-payer {
                    background: #f0f0f0;
                    padding: 8px;
                    margin: 10px 0;
                    text-align: center;
                    border: 2px solid #000;
                }
                
                .reste-payer .montant {
                    font-size: 18px;
                    font-weight: bold;
                }
                
                .notes {
                    background: #f5f5f5;
                    padding: 8px;
                    margin: 10px 0;
                    font-size: 10px;
                    border-left: 3px solid #000;
                }
                
                .footer {
                    text-align: center;
                    margin-top: 15px;
                    padding-top: 10px;
                    border-top: 2px dashed #000;
                    font-size: 10px;
                }
                
                .footer p {
                    margin: 3px 0;
                }
                
                .merci {
                    font-size: 14px;
                    font-weight: bold;
                    margin: 10px 0;
                }
                
                .btn-print {
                    background: #000;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    cursor: pointer;
                    font-size: 14px;
                    margin: 10px;
                    width: calc(100% - 20px);
                    border-radius: 4px;
                }
                
                .btn-print:hover {
                    background: #333;
                }
            </style>
        </head>
        <body>
            <button onclick="window.print()" class="btn-print no-print">
                üñ®Ô∏è IMPRIMER
            </button>
            
            <div class="ticket">
                <div class="header">
                    <h1>ANAPATH</h1>
                    <p>Centre d'Anatomie Pathologique</p>
                    <p>================================</p>
                </div>
                
                <div class="numero-recu">
                    RECU N¬∞ ${paiement.numero_cr || 'N/A'}
                </div>
                
                <div class="section">
                    <div class="row">
                        <span class="label">Date:</span>
                        <span class="value">${date}</span>
                    </div>
                    <div class="row">
                        <span class="label">Heure:</span>
                        <span class="value">${heure}</span>
                    </div>
                </div>
                
                <div class="section">
                    <div class="row">
                        <span class="label">Patient:</span>
                    </div>
                    <div class="row">
                        <span class="value" style="width: 100%; text-align: left; font-size: 13px;">${paiement.patient_nom}</span>
                    </div>
                    <div class="row">
                        <span class="label">Type:</span>
                        <span class="value">${paiement.type_paiement}</span>
                    </div>
                    <div class="row">
                        <span class="label">Mode:</span>
                        <span class="value">${modePaiementTexte}</span>
                    </div>
                </div>
                
                <div class="montant-principal">
                    <div class="label">MONTANT PAYE</div>
                    <div class="montant">${parseFloat(paiement.montant).toFixed(2)} DA</div>
                </div>
                
                ${paiement.montant_total ? `
                    <div class="section">
                        <div class="row">
                            <span class="label">Total facture:</span>
                            <span class="value">${parseFloat(paiement.montant_total).toFixed(2)} DA</span>
                        </div>
                        <div class="row">
                            <span class="label">Vers√©:</span>
                            <span class="value">${parseFloat(paiement.montant).toFixed(2)} DA</span>
                        </div>
                    </div>
                    
                    <div class="reste-payer">
                        <div style="font-size: 11px; margin-bottom: 5px;">RESTE A PAYER</div>
                        <div class="montant">${reste.toFixed(2)} DA</div>
                    </div>
                ` : ''}
                
                ${paiement.notes ? `
                    <div class="notes">
                        <strong>Notes:</strong><br>
                        ${paiement.notes}
                    </div>
                ` : ''}
                
                <div class="footer">
                    <p class="merci">MERCI DE VOTRE CONFIANCE</p>
                    <p>================================</p>
                    <p>Conservez ce ticket</p>
                    <p>Il fait foi de paiement</p>
                    <p>--------------------------------</p>
                    <p>${new Date().toLocaleString('fr-FR')}</p>
                </div>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.focus();
        }, 250);
    };
}

function genererRecuVignette(paiement) {
    const dateObj = new Date(paiement.date_paiement);
    const date = dateObj.toLocaleDateString('fr-FR');
    
    // QR code contient le num√©ro de re√ßu
    const qrContent = paiement.numero_cr || 'N/A';
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(qrContent)}`;
    
    const printWindow = window.open('', '', 'height=600,width=400');
    
    const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Vignette 60x40 - ${paiement.numero_cr || 'N/A'}</title>
            <style>
                @media print {
                    @page {
                        size: 60mm 40mm;
                        margin: 0;
                    }
                    body {
                        margin: 0;
                        padding: 0;
                    }
                    .no-print {
                        display: none !important;
                    }
                }
                
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body {
                    width: 60mm;
                    height: 40mm;
                    font-family: Arial, sans-serif;
                    background: white;
                    color: black;
                    padding: 2mm;
                }
                
                .vignette {
                    width: 100%;
                    height: 100%;
                    border: 1px solid #000;
                    display: flex;
                    flex-direction: column;
                    padding: 2mm;
                }
                
                .header {
                    text-align: center;
                    border-bottom: 1px solid #000;
                    padding-bottom: 1mm;
                    margin-bottom: 1.5mm;
                }
                
                .header h1 {
                    font-size: 10pt;
                    font-weight: bold;
                    margin: 0;
                    color: #1e40af;
                }
                
                .content {
                    display: flex;
                    gap: 2mm;
                    flex: 1;
                    align-items: flex-start;
                }
                
                .left-section {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    justify-content: space-between;
                }
                
                .qr-section {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                }
                
                .qr-container {
                    width: 22mm;
                    height: 22mm;
                    border: 1px solid #000;
                    padding: 1mm;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: white;
                }
                
                .qr-container img {
                    width: 100%;
                    height: 100%;
                    object-fit: contain;
                }
                
                .numero-cr {
                    font-size: 7pt;
                    font-weight: bold;
                    color: #1e40af;
                    text-align: center;
                    margin-top: 1mm;
                    word-break: break-all;
                }
                
                .patient-info {
                    font-size: 7pt;
                    line-height: 1.3;
                }
                
                .patient-nom {
                    font-weight: bold;
                    font-size: 8pt;
                    margin-bottom: 1mm;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }
                
                .montant {
                    font-size: 9pt;
                    font-weight: bold;
                    color: #059669;
                    margin: 1mm 0;
                }
                
                .notes-section {
                    font-size: 5pt;
                    line-height: 1.2;
                    color: #333;
                    border-top: 0.5px dashed #666;
                    padding-top: 1mm;
                    margin-top: auto;
                    max-height: 8mm;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }
                
                .notes-title {
                    font-weight: bold;
                    margin-bottom: 0.5mm;
                }
                
                /* Bouton d'impression - cach√© √† l'impression */
                .btn-print {
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: #4f46e5;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    cursor: pointer;
                    font-size: 14px;
                    border-radius: 4px;
                    z-index: 1000;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                }
                
                .btn-print:hover {
                    background: #4338ca;
                }
            </style>
        </head>
        <body>
            <button onclick="window.print()" class="btn-print no-print">
                üñ®Ô∏è Imprimer
            </button>
            
            <div class="vignette">
                <!-- En-t√™te -->
                <div class="header">
                    <h1>ANAPATH ELYOUSR</h1>
                </div>
                
                <!-- Contenu principal -->
                <div class="content">
                    <!-- Partie gauche : Infos patient -->
                    <div class="left-section">
                        <div class="patient-info">
                            <div class="patient-nom">${paiement.patient_nom.substring(0, 25)}${paiement.patient_nom.length > 25 ? '...' : ''}</div>
                            <div class="montant">${parseFloat(paiement.montant).toFixed(2)} DA</div>
                            <div style="font-size: 6pt; color: #666;">${date}</div>
                            <div style="font-size: 6pt; color: #666;">${paiement.type_paiement || '‚Äî'}</div>
                        </div>
                        
                        <!-- Notes en bas -->
                        ${paiement.notes ? `
                            <div class="notes-section">
                                <div class="notes-title">Notes:</div>
                                <div>${paiement.notes.substring(0, 80)}${paiement.notes.length > 80 ? '...' : ''}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Partie droite : QR Code + Num√©ro CR -->
                    <div class="qr-section">
                        <div class="qr-container">
                            <img src="${qrUrl}" alt="QR Code" 
                                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'font-size:8pt;text-align:center;\\'>QR<br>Code</div>';">
                        </div>
                        <div class="numero-cr">N¬∞ ${paiement.numero_cr || 'N/A'}</div>
                    </div>
                </div>
            </div>
            
            <script>
                window.onload = function() {
                    // Attendre le chargement du QR code avant d'imprimer automatiquement
                    const img = document.querySelector('img');
                    if (img) {
                        img.onload = function() {
                            setTimeout(() => window.print(), 500);
                        };
                        if (img.complete) {
                            setTimeout(() => window.print(), 500);
                        }
                    } else {
                        setTimeout(() => window.print(), 500);
                    }
                };
            <\/script>
        </body>
        </html>
    `;
    
    printWindow.document.write(htmlContent);
    printWindow.document.close();
}
    // Fonction pour imprimer le rapport journalier
async function imprimerRapportJournalier() {
    const date = document.getElementById('rapportDate').value;
    
    if (!date) {
        showToast('Veuillez s√©lectionner une date', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/paiements/rapport-journalier?date=${date}`, {
            headers: { 'X-User-ID': currentUserId }
        });
        
        if (response.ok) {
            const rapport = await response.json();
            
            // Cr√©er une nouvelle fen√™tre pour l'impression
            const printWindow = window.open('', '', 'height=800,width=1000');
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Rapport Journalier - ${date}</title>
                    <style>
                        @media print {
                            @page { margin: 1cm; }
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            color: #333;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 3px solid #4f46e5;
                            padding-bottom: 20px;
                        }
                        .header h1 {
                            color: #4f46e5;
                            margin: 0;
                            font-size: 28px;
                        }
                        .header p {
                            margin: 5px 0;
                            color: #666;
                        }
                        .summary-cards {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 15px;
                            margin: 20px 0;
                        }
                        .summary-card {
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                        }
                        .summary-card.total {
                            background: #dbeafe;
                            color: #1e40af;
                        }
                        .summary-card.count {
                            background: #d1fae5;
                            color: #065f46;
                        }
                        .summary-card h3 {
                            margin: 0;
                            font-size: 14px;
                        }
                        .summary-card .value {
                            font-size: 24px;
                            font-weight: bold;
                            margin-top: 10px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                            font-size: 12px;
                        }
                        th {
                            background: #4f46e5;
                            color: white;
                            padding: 12px 8px;
                            text-align: left;
                            font-weight: 600;
                        }
                        td {
                            padding: 10px 8px;
                            border-bottom: 1px solid #e5e7eb;
                        }
                        .total-row {
                            font-weight: bold;
                            background: #f8fafc;
                        }
                        .footer {
                            margin-top: 40px;
                            text-align: center;
                            color: #666;
                            font-size: 11px;
                            padding-top: 20px;
                            border-top: 1px solid #e5e7eb;
                        }
                        .btn-print {
                            background: #4f46e5;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            margin-bottom: 20px;
                        }
                    </style>
                </head>
                <body>
                    <button onclick="window.print()" class="btn-print no-print">üñ®Ô∏è Imprimer</button>
                    
                    <div class="header">
                        <h1>üìä RAPPORT JOURNALIER DES PAIEMENTS</h1>
                        <p><strong>ANAPATH - Centre d'Anatomie Pathologique</strong></p>
                        <p>Date du rapport: ${date}</p>
                        <p>G√©n√©r√© le: ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}</p>
                    </div>
                    
                    <div class="summary-cards">
                        <div class="summary-card total">
                            <h3>TOTAL ENCAISS√â</h3>
                            <div class="value">${(rapport.total_general || 0).toFixed(2)} DA</div>
                        </div>
                        <div class="summary-card count">
                            <h3>NOMBRE DE PAIEMENTS</h3>
                            <div class="value">${rapport.nombre_paiements || 0}</div>
                        </div>
                    </div>
                    
                    ${rapport.totaux_par_mode && rapport.totaux_par_mode.length > 0 ? `
                        <h3>R√©partition par mode de paiement:</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Mode de paiement</th>
                                    <th style="text-align: right">Montant</th>
                                    <th style="text-align: right">Pourcentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rapport.totaux_par_mode.map(mode => {
                                    const pourcentage = rapport.total_general > 0 
                                        ? ((mode.total / rapport.total_general) * 100).toFixed(1)
                                        : '0.0';
                                    return `
                                        <tr>
                                            <td>${mode.mode_paiement === 'espece' ? 'Comptant' : 
                                                  mode.mode_paiement === 'a_terme' ? '√Ä terme' : 
                                                  'Partiel'}</td>
                                            <td style="text-align: right">${parseFloat(mode.total || 0).toFixed(2)} DA</td>
                                            <td style="text-align: right">${pourcentage}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="text-align: center; color: #666; padding: 20px;">Aucun paiement pour cette date</p>'}
                    
                    <div class="footer">
                        <p>Document g√©n√©r√© automatiquement par ANAPATH - Syst√®me de Gestion des Paiements</p>
                        <p>Confidentiel ‚Ä¢ Ne pas diffuser</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.focus();
                }, 250);
            };
            
            showToast('Rapport g√©n√©r√© pour impression', 'success');
        } else {
            throw new Error('Erreur lors de la g√©n√©ration du rapport');
        }
    } catch (error) {
        console.error('Erreur impression rapport:', error);
        showToast('Erreur lors de la g√©n√©ration du rapport', 'error');
    }
}

// Fonction pour imprimer la synth√®se patient
async function imprimerSynthesePatient() {
    const patientId = document.getElementById('rapportPatient').value;
    
    if (!patientId) {
        showToast('Veuillez s√©lectionner un patient', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/paiements/synthese-patient/${patientId}`, {
            headers: { 'X-User-ID': currentUserId }
        });
        
        if (response.ok) {
            const synthese = await response.json();
            const patient = synthese.patient;
            
            // Cr√©er une nouvelle fen√™tre pour l'impression
            const printWindow = window.open('', '', 'height=800,width=1000');
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Synth√®se Patient - ${patient.nom}${patient.prenom ? ' ' + patient.prenom : ''}</title>
                    <style>
                        @media print {
                            @page { margin: 1cm; }
                            body { margin: 0; }
                            .no-print { display: none; }
                            .page-break { page-break-before: always; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            color: #333;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 3px solid #4f46e5;
                            padding-bottom: 20px;
                        }
                        .header h1 {
                            color: #4f46e5;
                            margin: 0;
                            font-size: 28px;
                        }
                        .patient-info {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 15px;
                            margin: 20px 0;
                            padding: 20px;
                            background: #f8fafc;
                            border-radius: 8px;
                        }
                        .info-item {
                            display: flex;
                            justify-content: space-between;
                            padding: 8px 0;
                            border-bottom: 1px solid #e5e7eb;
                        }
                        .info-item:last-child {
                            border-bottom: none;
                        }
                        .info-label {
                            font-weight: 600;
                            color: #4b5563;
                        }
                        .info-value {
                            color: #1f2937;
                        }
                        .solde-negatif {
                            color: #dc2626;
                            font-weight: bold;
                        }
                        .solde-positif {
                            color: #059669;
                            font-weight: bold;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 15px;
                            margin: 20px 0;
                        }
                        .stat-card {
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                        }
                        .stat-card.total {
                            background: #dbeafe;
                            color: #1e40af;
                        }
                        .stat-card.count {
                            background: #d1fae5;
                            color: #065f46;
                        }
                        .stat-card.last {
                            background: #fef3c7;
                            color: #92400e;
                        }
                        .stat-card h3 {
                            margin: 0;
                            font-size: 14px;
                        }
                        .stat-card .value {
                            font-size: 24px;
                            font-weight: bold;
                            margin-top: 10px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                            font-size: 12px;
                        }
                        th {
                            background: #4f46e5;
                            color: white;
                            padding: 12px 8px;
                            text-align: left;
                            font-weight: 600;
                        }
                        td {
                            padding: 10px 8px;
                            border-bottom: 1px solid #e5e7eb;
                        }
                        .footer {
                            margin-top: 40px;
                            text-align: center;
                            color: #666;
                            font-size: 11px;
                            padding-top: 20px;
                            border-top: 1px solid #e5e7eb;
                        }
                        .btn-print {
                            background: #4f46e5;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            margin-bottom: 20px;
                        }
                        .notes {
                            background: #fef3c7;
                            padding: 15px;
                            margin: 20px 0;
                            border-radius: 4px;
                            border-left: 4px solid #f59e0b;
                        }
                    </style>
                </head>
                <body>
                    <button onclick="window.print()" class="btn-print no-print">üñ®Ô∏è Imprimer</button>
                    
                    <div class="header">
                        <h1>üìã SYNTH√àSE PATIENT</h1>
                        <p><strong>ANAPATH - Centre d'Anatomie Pathologique</strong></p>
                        <p>Date du rapport: ${new Date().toLocaleDateString('fr-FR')}</p>
                    </div>
                    
                    <div class="patient-info">
                        <div class="info-item">
                            <span class="info-label">Nom complet:</span>
                            <span class="info-value">${patient.nom}${patient.prenom ? ' ' + patient.prenom : ''}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">√Çge:</span>
                            <span class="info-value">${patient.age || 'Non sp√©cifi√©'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Sexe:</span>
                            <span class="info-value">${patient.sexe || 'Non sp√©cifi√©'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">T√©l√©phone:</span>
                            <span class="info-value">${patient.telephone || 'Non sp√©cifi√©'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Date d'inscription:</span>
                            <span class="info-value">${patient.date_creation ? new Date(patient.date_creation).toLocaleDateString('fr-FR') : 'Non sp√©cifi√©'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Solde actuel:</span>
                            <span class="info-value ${parseFloat(patient.solde || 0) < 0 ? 'solde-negatif' : 'solde-positif'}">
                                ${parseFloat(patient.solde || 0).toFixed(2)} DA
                                ${parseFloat(patient.solde || 0) < 0 ? '(Dette)' : parseFloat(patient.solde || 0) > 0 ? '(Cr√©dit)' : ''}
                            </span>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card total">
                            <h3>TOTAL PAY√â</h3>
                            <div class="value">${(synthese.statistiques.total_paye || 0).toFixed(2)} DA</div>
                        </div>
                        <div class="stat-card count">
                            <h3>NOMBRE DE PAIEMENTS</h3>
                            <div class="value">${synthese.statistiques.nombre_total_paiements || 0}</div>
                        </div>
                        <div class="stat-card last">
                            <h3>DERNIER PAIEMENT</h3>
                            <div class="value">${synthese.statistiques.date_dernier_paiement ? new Date(synthese.statistiques.date_dernier_paiement).toLocaleDateString('fr-FR') : 'Aucun'}</div>
                        </div>
                    </div>
                    
                    ${synthese.details_a_terme && synthese.details_a_terme.length > 0 ? `
                        <div class="page-break"></div>
                        <h3>üìã D√©tails des paiements √† terme:</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Montant total</th>
                                    <th>Montant pay√©</th>
                                    <th>Reste √† payer</th>
                                    <th>N¬∞ Re√ßu</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${synthese.details_a_terme.map(detail => {
                                    const statut = detail.reste_a_payer > 0 ? 'En cours' : 'R√©gularis√©';
                                    return `
                                        <tr>
                                            <td>${detail.date ? new Date(detail.date).toLocaleDateString('fr-FR') : '-'}</td>
                                            <td>${parseFloat(detail.montant_total || 0).toFixed(2)} DA</td>
                                            <td>${parseFloat(detail.montant_paye || 0).toFixed(2)} DA</td>
                                            <td class="${detail.reste_a_payer > 0 ? 'solde-negatif' : 'solde-positif'}">
                                                ${parseFloat(detail.reste_a_payer || 0).toFixed(2)} DA
                                            </td>
                                            <td>${detail.numero_cr || '-'}</td>
                                            <td>${statut}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="text-align: center; color: #666; padding: 20px;">Aucun paiement √† terme pour ce patient</p>'}
                    
                    ${patient.notes || patient.observations ? `
                        <div class="notes">
                            <h4>Notes/Observations:</h4>
                            <p>${patient.notes || patient.observations || ''}</p>
                        </div>
                    ` : ''}
                    
                    <div class="footer">
                        <p>Document g√©n√©r√© automatiquement par ANAPATH - Syst√®me de Gestion des Paiements</p>
                        <p>Confidentiel ‚Ä¢ Informations m√©dicales prot√©g√©es</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.focus();
                }, 250);
            };
            
            showToast('Synth√®se patient g√©n√©r√©e pour impression', 'success');
        } else {
            throw new Error('Erreur lors de la g√©n√©ration de la synth√®se');
        }
    } catch (error) {
        console.error('Erreur impression synth√®se:', error);
        showToast('Erreur lors de la g√©n√©ration de la synth√®se patient', 'error');
    }
}
     function reinitialiserFiltres() {
    // R√©initialiser tous les champs de filtre
    document.getElementById('filterPatient').value = '';
    document.getElementById('filterTypeExamen').value = '';
    document.getElementById('filterDateDebut').value = '';
    document.getElementById('filterDateFin').value = '';
    document.getElementById('filterModePaiement').value = '';
    
    // R√©initialiser les filtres actifs
    filtresActifs = {};
    
    // Recharger tous les paiements
    currentPage = 1;
    loadPaiements();
    
    showToast('Filtres r√©initialis√©s', 'success');
}
        function scannerQRCode() {
    // Cr√©er un modal pour le scanner QR
    const modalHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl w-full max-w-md mx-4">
                <div class="p-6 border-b bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-t-xl">
                    <h3 class="text-xl font-semibold flex items-center">
                        <i class="fas fa-qrcode mr-3 text-2xl"></i>
                        Scanner QR Code
                    </h3>
                    <p class="text-sm mt-1 opacity-90">Scannez le QR code d'un re√ßu pour trouver le paiement</p>
                </div>
                <div class="p-6">
                    <div class="text-center mb-6">
                        <div id="qrReader" class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center">
                            <p class="text-gray-500">Zone de scan QR code</p>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">Placez le QR code dans la zone de scan</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Ou saisissez manuellement le num√©ro de re√ßu
                            </label>
                            <input type="text" id="numeroRecuInput" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                   placeholder="Ex: 001H26A">
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="rechercherParNumeroRecu()" 
                                    class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-3 rounded-lg transition hover:from-indigo-700 hover:to-purple-700">
                                <i class="fas fa-search mr-2"></i>Rechercher
                            </button>
                            <button onclick="fermerModalQR()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg transition">
                                <i class="fas fa-times mr-2"></i>Fermer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Initialiser le scanner QR si la biblioth√®que est disponible
    if (typeof Html5QrcodeScanner !== 'undefined') {
        const qrScanner = new Html5QrcodeScanner("qrReader", { 
            fps: 10, 
            qrbox: 250 
        });
        
        qrScanner.render((decodedText) => {
            // Quand un QR code est scann√©
            document.getElementById('numeroRecuInput').value = decodedText;
            rechercherParNumeroRecu();
            qrScanner.clear();
            fermerModalQR();
        });
    }
}

function fermerModalQR() {
    const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-75');
    if (modal) {
        modal.remove();
    }
}

function rechercherParNumeroRecu() {
    const numeroRecu = document.getElementById('numeroRecuInput').value.trim();
    
    if (!numeroRecu) {
        showToast('Veuillez saisir un num√©ro de re√ßu', 'error');
        return;
    }
    
    // Filtrer les paiements par num√©ro de re√ßu
    const paiementTrouve = allPaiements.find(p => 
        p.numero_cr && p.numero_cr.toLowerCase() === numeroRecu.toLowerCase()
    );
    
    if (paiementTrouve) {
        // Afficher l'onglet liste
        showTab('liste');
        
        // Filtrer pour ne montrer que ce paiement
        filtresActifs = { numero_cr: numeroRecu };
        allPaiements = [paiementTrouve];
        renderPaiementsList();
        
        // Mettre en surbrillance la ligne
        setTimeout(() => {
            const rows = document.querySelectorAll('#listePaiements tr');
            rows.forEach(row => {
                if (row.textContent.includes(numeroRecu)) {
                    row.classList.add('bg-yellow-50', 'border-2', 'border-yellow-300');
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }, 100);
        
        fermerModalQR();
        showToast(`Paiement trouv√©: ${numeroRecu}`, 'success');
    } else {
        // Chercher via API
        rechercherPaiementParNumeroAPI(numeroRecu);
    }
}

async function rechercherPaiementParNumeroAPI(numeroRecu) {
    try {
        const response = await fetch(`${API_BASE_URL}/paiements/par-numero/${encodeURIComponent(numeroRecu)}`, {
            headers: { 'X-User-ID': currentUserId }
        });
        
        if (response.ok) {
            const paiement = await response.json();
            
            if (paiement) {
                // Afficher l'onglet liste
                showTab('liste');
                
                // Filtrer pour ne montrer que ce paiement
                filtresActifs = { numero_cr: numeroRecu };
                allPaiements = [paiement];
                renderPaiementsList();
                
                showToast(`Paiement trouv√©: ${numeroRecu}`, 'success');
                fermerModalQR();
            } else {
                showToast(`Aucun paiement trouv√© avec le num√©ro: ${numeroRecu}`, 'error');
            }
        } else {
            // Si l'API ne trouve pas, filtrer localement
            const paiementsFiltres = allPaiements.filter(p => 
                p.numero_cr && p.numero_cr.toLowerCase().includes(numeroRecu.toLowerCase())
            );
            
            if (paiementsFiltres.length > 0) {
                // Afficher l'onglet liste
                showTab('liste');
                
                // Filtrer pour montrer les paiements correspondants
                filtresActifs = { numero_cr: numeroRecu };
                allPaiements = paiementsFiltres;
                renderPaiementsList();
                
                showToast(`${paiementsFiltres.length} paiement(s) trouv√©(s)`, 'success');
                fermerModalQR();
            } else {
                showToast(`Aucun paiement trouv√© avec le num√©ro: ${numeroRecu}`, 'error');
            }
        }
    } catch (error) {
        console.error('Erreur recherche paiement:', error);
        showToast('Erreur lors de la recherche', 'error');
    }
}
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODAL AJOUT RAPIDE PATIENT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function openQuickPatientModal() {
  document.getElementById('quickPatientForm').reset();
  document.getElementById('quickPatientId').value = '';
  document.getElementById('quickPatientModal').classList.remove('hidden');
}

function closeQuickPatientModal() {
  document.getElementById('quickPatientModal').classList.add('hidden');
}

async function saveQuickPatient() {
  const nom = document.getElementById('quickPatientNom').value.trim();
  const age = document.getElementById('quickPatientAge').value;
  const sexe = document.getElementById('quickPatientSexe').value;
  const tel = document.getElementById('quickPatientTel').value.trim();

  if (!nom) {
    showToast('Le nom est obligatoire', 'error');
    return;
  }

  try {
    const data = {
      nom,
      age: age ? parseInt(age) : null,
      sexe: sexe || null,
      telephone: tel || null,
      adresse: null,
      solde: 0
    };

    const response = await fetch(`${API_BASE_URL}/patients`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-User-ID': currentUserId
      },
      body: JSON.stringify(data)
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.erreur || 'Erreur cr√©ation patient');
    }

    const result = await response.json();
    const newPatientId = result.id || result.numero;
    const newPatientNom = nom;

    showToast('Patient cr√©√© avec succ√®s', 'success');
    closeQuickPatientModal();

    // Mettre un flag pour indiquer qu'on vient d'ajouter un patient
    window.justAddedPatient = {
      id: newPatientId,
      nom: nom
    };

    // Ajouter directement √† la liste SANS appeler chargerPatientsDansSelect()
    const patientSelect = document.getElementById('patientSelect');
    
    // Cr√©er et ajouter la nouvelle option
    const newOption = document.createElement('option');
    newOption.value = newPatientId.toString();
    newOption.textContent = `${nom} (${tel || 'N/A'}) - Solde: 0.00 DA`;
    newOption.setAttribute('data-age', age || '');
    newOption.setAttribute('data-sexe', sexe || '');
    newOption.setAttribute('data-tel', tel || '');
    newOption.setAttribute('data-solde', '0');
    
    // Ins√©rer au bon endroit (tri alphab√©tique)
    let inserted = false;
    const searchText = nom.toLowerCase();
    
    for (let i = 1; i < patientSelect.options.length; i++) { // Commencer √† 1 pour sauter l'option vide
      const optionText = patientSelect.options[i].text.toLowerCase();
      if (optionText > searchText) {
        patientSelect.insertBefore(newOption, patientSelect.options[i]);
        inserted = true;
        break;
      }
    }
    
    // Si pas ins√©r√©, ajouter √† la fin
    if (!inserted) {
      patientSelect.appendChild(newOption);
    }
    
    // S√©lectionner cette nouvelle option
    for (let i = 0; i < patientSelect.options.length; i++) {
      if (patientSelect.options[i].value === newPatientId.toString()) {
        patientSelect.selectedIndex = i;
        break;
      }
    }
    
    // Mettre √† jour les infos et focus
    updatePatientInfo();
    patientSelect.focus();
    
    // Synchroniser en arri√®re-plan SANS interf√©rer
    setTimeout(async () => {
      try {
        // Sauvegarder la s√©lection actuelle
        const currentSelection = patientSelect.value;
        
        // Recharger silencieusement
        await chargerPatientsDansSelect();
        
        // Restaurer la s√©lection
        if (currentSelection) {
          patientSelect.value = currentSelection;
          updatePatientInfo();
        }
        
        // Recharger les filtres
        chargerPatientsFiltre();
      } catch (err) {
        console.error('Erreur synchronisation:', err);
      }
      
      // Nettoyer le flag
      delete window.justAddedPatient;
    }, 3000); // Attendre 3 secondes pour √™tre s√ªr

  } catch (err) {
    console.error('Erreur cr√©ation patient:', err);
    showToast(err.message || 'Erreur lors de la cr√©ation', 'error');
  }
}
// Mapper les types d'examen aux codes famille API
const mappingTypesFamille = {
    'histologie': 'HISTO',
    'biopsie': 'BIOPS',
    'cytologie': 'CYTO',
    'fcv': 'FCV',
    'immuno-histochimie': 'IMMUN',
    'autre': 'AUTRE'
};

// Variable globale pour stocker les sous-familles charg√©es
let currentSousFamilles = [];

/**
 * Charge les sous-familles correspondant au type d'examen s√©lectionn√©
 * et ouvre automatiquement le menu d√©roulant pendant ~1.4 seconde
 */
async function chargerSousFamilles() {
    const typeExamen = document.getElementById('typeExamen').value;
    const sousFamilleContainer = document.getElementById('sousFamilleContainer');
    const sousFamilleSelect = document.getElementById('sousFamilleSelect');
    const prixContainer = document.getElementById('prixExamenContainer');

    // Si aucun type s√©lectionn√© ‚Üí on cache tout
    if (!typeExamen) {
        sousFamilleContainer.classList.add('hidden');
        prixContainer.classList.add('hidden');
        sousFamilleSelect.innerHTML = '<option value="">S√©lectionnez d‚Äôabord un type d‚Äôexamen</option>';
        return;
    }

    // Afficher le conteneur et indiquer le chargement
    sousFamilleContainer.classList.remove('hidden');
    sousFamilleSelect.innerHTML = '<option value="">Chargement des sous-familles...</option>';

    const familleCode = mappingTypesFamille[typeExamen];

    if (!familleCode) {
        sousFamilleSelect.innerHTML = '<option value="">Type d‚Äôexamen non reconnu</option>';
        showToast('Type d‚Äôexamen non valide', 'error');
        return;
    }

    try {
        const response = await fetch(
            `${API_BASE_URL}/api/sous-familles-examens/famille/${familleCode}`,
            {
                headers: { 'X-User-ID': currentUserId }
            }
        );

        if (!response.ok) {
            throw new Error(`Erreur HTTP ${response.status}`);
        }

        const data = await response.json();
        currentSousFamilles = data.sous_familles || [];

        if (currentSousFamilles.length > 0) {
            // Remplir le select
            sousFamilleSelect.innerHTML = `
                <option value="">S√©lectionnez une sous-famille...</option>
                ${currentSousFamilles.map(sf => `
                    <option value="${sf.id}"
                            data-prix="${sf.prix}"
                            data-designation="${sf.designation}"
                            data-code="${sf.code}"
                            data-description="${sf.description || ''}">
                        ${sf.designation} ‚Äî ${parseFloat(sf.prix).toLocaleString('fr-FR')} DA
                    </option>
                `).join('')}
                <option value="autre">Autre (prix manuel)</option>
            `;

            showToast(`${currentSousFamilles.length} sous-famille(s) charg√©e(s)`, 'success');

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // OUVERTURE AUTOMATIQUE DU MENU D√âROULANT (effet UX fluide)
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (currentSousFamilles.length > 0) {
                // 1. Mettre le focus sur le select
                sousFamilleSelect.focus();

                // 2. Calculer combien d‚Äôoptions afficher (limit√© √† 10-12 pour ne pas √™tre trop envahissant)
                const optionsCount = currentSousFamilles.length + 2; // + vide + "autre"
                const visibleLines = Math.min(optionsCount, 10);

                // 3. Ouvrir temporairement le menu en augmentant la taille visible
                sousFamilleSelect.size = visibleLines;

                // 4. Refermer automatiquement apr√®s 1.4 seconde
                setTimeout(() => {
                    sousFamilleSelect.size = 1;
                    // Optionnel : remettre le focus ou le laisser √† l‚Äôutilisateur
                    // sousFamilleSelect.blur();
                }, 4000); // ‚Üê Ajuste ce d√©lai selon tes pr√©f√©rences (800‚Äì2000 ms)
            }
        } 
        else {
            // Pas de sous-familles pour cette famille
            sousFamilleSelect.innerHTML = `
                <option value="">Aucune sous-famille pour ce type</option>
                <option value="autre">Autre (prix manuel)</option>
            `;
            showToast('Aucune sous-famille disponible pour ce type d‚Äôexamen', 'info');
        }

    } catch (error) {
        console.error('Erreur chargement sous-familles:', error);
        sousFamilleSelect.innerHTML = '<option value="">Erreur de chargement</option>';
        showToast('Impossible de charger les sous-familles', 'error');
    }

    // Cacher le bloc prix tant qu‚Äôaucune sous-famille n‚Äôest s√©lectionn√©e
    prixContainer.classList.add('hidden');
}

// Fonction pour afficher le prix quand une sous-famille est s√©lectionn√©e
function afficherPrixSousFamille() {
    const sousFamilleSelect = document.getElementById('sousFamilleSelect');
    const selectedOption = sousFamilleSelect.options[sousFamilleSelect.selectedIndex];
    const prixContainer = document.getElementById('prixExamenContainer');
    const prixValeur = document.getElementById('prixExamenValeur');
    const descriptionEl = document.getElementById('descriptionSousFamille');
    const notesTextarea = document.getElementById('notes');

    if (!selectedOption.value || selectedOption.value === 'autre') {
        prixContainer.classList.add('hidden');
        return;
    }

    // R√©cup√©rer la sous-famille compl√®te
    const sousFamille = currentSousFamilles.find(sf => sf.id.toString() === selectedOption.value);
    
    if (sousFamille) {
        const prix = parseFloat(sousFamille.prix);
        const designation = sousFamille.designation;
        const code = sousFamille.code;
        const description = sousFamille.description;
        
        // Afficher le prix
        prixContainer.classList.remove('hidden');
        prixValeur.textContent = `${prix.toLocaleString('fr-FR')} DA`;
        
        // Afficher la description si elle existe
        if (description) {
            descriptionEl.textContent = description;
            descriptionEl.classList.remove('hidden');
        } else {
            descriptionEl.classList.add('hidden');
        }
        
        // Ajouter automatiquement dans les notes
        const infoExamen = `Sous-famille: ${designation} (${code})\nPrix standard: ${prix.toLocaleString('fr-FR')} DA`;
        
        // V√©rifier si les notes existantes contiennent d√©j√† "Sous-famille:"
        const notesExistantes = notesTextarea.value.trim();
        if (!notesExistantes.includes('Sous-famille:')) {
            if (notesExistantes) {
                notesTextarea.value = `${infoExamen}\n\n${notesExistantes}`;
            } else {
                notesTextarea.value = infoExamen;
            }
        }
        
        showToast(`Prix de la sous-famille: ${prix.toLocaleString('fr-FR')} DA`, 'info');
    }
}

// Fonction pour utiliser le prix de la sous-famille
function utiliserPrixSousFamille() {
    const sousFamilleSelect = document.getElementById('sousFamilleSelect');
    const selectedOption = sousFamilleSelect.options[sousFamilleSelect.selectedIndex];
    const modePaiement = document.querySelector('input[name="modePaiement"]:checked').value;
    
    if (!selectedOption.value || selectedOption.value === 'autre') {
        showToast('S√©lectionnez d\'abord une sous-famille', 'warning');
        return;
    }
    
    // Trouver la sous-famille s√©lectionn√©e
    const sousFamille = currentSousFamilles.find(sf => sf.id.toString() === selectedOption.value);
    
    if (sousFamille) {
        const prix = parseFloat(sousFamille.prix);
        
        // Si c'est un paiement √† terme, remplir automatiquement le montant total
        if (modePaiement === 'a_terme') {
            document.getElementById('montantTotal').value = prix;
            showToast(`Montant total d√©fini √† ${prix.toLocaleString('fr-FR')} DA`, 'success');
        } else {
            // Pour les autres modes, sugg√©rer le montant pay√©
            document.getElementById('montantPaye').value = prix;
            showToast(`Montant sugg√©r√©: ${prix.toLocaleString('fr-FR')} DA`, 'info');
        }
        
        // Mettre √† jour le r√©capitulatif
        updateRecap();
    }
}
 // Variables globales pour l'attachement LOCAL
let currentAttachmentPaymentId = null;
let currentAttachmentNumeroCR = null;
let selectedFiles = [];

// Ouvrir le modal d'attachement
function openAttachmentModal(paymentId, numeroCR) {
    currentAttachmentPaymentId = paymentId;
    currentAttachmentNumeroCR = numeroCR;
    selectedFiles = [];
    
    document.getElementById('attachmentFolder').textContent = numeroCR || 'N/A';
    document.getElementById('filesList').innerHTML = '';
    document.getElementById('attachmentModal').classList.remove('hidden');
    
    // Charger les fichiers existants depuis le localStorage
    loadExistingFilesLocal(numeroCR);
    
    // Setup drag and drop
    setupDragAndDrop();
}

// Fermer le modal
function closeAttachmentModal() {
    document.getElementById('attachmentModal').classList.add('hidden');
    currentAttachmentPaymentId = null;
    currentAttachmentNumeroCR = null;
    selectedFiles = [];
}

// Configuration du drag and drop
function setupDragAndDrop() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    // Click pour ouvrir le s√©lecteur
    dropZone.onclick = () => fileInput.click();
    
    // Drag and drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('border-orange-500', 'bg-orange-50');
        }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('border-orange-500', 'bg-orange-50');
        }, false);
    });
    
    dropZone.addEventListener('drop', handleDrop, false);
    fileInput.addEventListener('change', handleFileSelect, false);
}

// Gestion du drop
function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

// Gestion de la s√©lection de fichiers
function handleFileSelect(e) {
    const files = e.target.files;
    handleFiles(files);
}

// Traitement des fichiers
function handleFiles(files) {
    const maxSize = 10 * 1024 * 1024; // 10MB
    const validExtensions = ['jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx'];
    
    Array.from(files).forEach(file => {
        // V√©rifier la taille
        if (file.size > maxSize) {
            showToast(`${file.name} est trop volumineux (max 10MB)`, 'error');
            return;
        }
        
        // V√©rifier l'extension
        const extension = file.name.split('.').pop().toLowerCase();
        if (!validExtensions.includes(extension)) {
            showToast(`${file.name} - format non support√©`, 'error');
            return;
        }
        
        // Ajouter √† la liste
        selectedFiles.push(file);
    });
    
    displaySelectedFiles();
}

// Afficher les fichiers s√©lectionn√©s
function displaySelectedFiles() {
    const filesList = document.getElementById('filesList');
    
    if (selectedFiles.length === 0) {
        filesList.innerHTML = '';
        return;
    }
    
    filesList.innerHTML = `
        <div class="space-y-2">
            ${selectedFiles.map((file, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-file-${getFileIcon(file.name)} text-2xl text-orange-600"></i>
                        <div>
                            <p class="font-medium text-sm">${file.name}</p>
                            <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
                        </div>
                    </div>
                    <button onclick="removeFile(${index})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('')}
        </div>
    `;
}

// Supprimer un fichier de la liste
function removeFile(index) {
    selectedFiles.splice(index, 1);
    displaySelectedFiles();
}

// Obtenir l'ic√¥ne selon le type de fichier
function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const icons = {
        'jpg': 'image', 'jpeg': 'image', 'png': 'image',
        'pdf': 'pdf',
        'doc': 'word', 'docx': 'word'
    };
    return icons[ext] || 'alt';
}

// Formater la taille du fichier
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// 1. Charger les fichiers existants depuis PostgreSQL
async function loadExistingFilesFromDB(numeroCR) {
    try {
        // R√©cup√©rer le paiement_id depuis le num√©ro CR
        const paiement = allPaiements.find(p => p.numero_cr === numeroCR);
        if (!paiement || !paiement.id) {
            console.log('Paiement non trouv√© pour ce num√©ro CR');
            return [];
        }

        const response = await fetch(`${API_BASE_URL}/api/paiements/${paiement.id}/fichiers`, {
            headers: { 'X-User-ID': currentUserId }
        });

        if (response.ok) {
            const data = await response.json();
            return data.fichiers || [];
        } else {
            console.error('Erreur chargement fichiers:', await response.text());
            return [];
        }
    } catch (error) {
        console.error('Erreur chargement fichiers DB:', error);
        return [];
    }
}

// 2. Sauvegarder les fichiers dans PostgreSQL
// Remplacer la fonction saveFilesToDB par cette version am√©lior√©e
async function saveFilesToDB() {
    if (selectedFiles.length === 0) {
        showToast('Aucun fichier √† enregistrer', 'warning');
        return;
    }

    // Trouver le paiement correspondant au num√©ro CR
    const paiement = allPaiements.find(p => p.numero_cr === currentAttachmentNumeroCR);
    if (!paiement || !paiement.id) {
        showToast('Impossible de trouver le paiement correspondant', 'error');
        return;
    }

    const uploadBtn = document.getElementById('uploadBtn');
    uploadBtn.disabled = true;
    
    // Cr√©er la barre de progression
    createProgressBar();

    try {
        const totalFiles = selectedFiles.length;
        let uploadedFiles = 0;

        // Upload fichier par fichier pour un meilleur contr√¥le
        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            
            // Mettre √† jour le texte de progression
            updateProgressText(`Upload de ${file.name}... (${i + 1}/${totalFiles})`);
            
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch(`${API_BASE_URL}/api/paiements/${paiement.id}/fichiers`, {
                method: 'POST',
                headers: {
                    'X-User-ID': currentUserId
                },
                body: formData
            });

            if (response.ok) {
                uploadedFiles++;
                updateProgressBar((uploadedFiles / totalFiles) * 100);
            } else {
                const error = await response.json();
                throw new Error(`Erreur sur ${file.name}: ${error.erreur || 'Erreur inconnue'}`);
            }
        }

        showToast(`${uploadedFiles} fichier(s) enregistr√©(s) avec succ√®s`, 'success');
        
        // R√©initialiser
        selectedFiles = [];
        displaySelectedFiles();
        
        // Recharger la liste
        await loadExistingFilesLocal(currentAttachmentNumeroCR);
        
    } catch (error) {
        console.error('Erreur sauvegarde DB:', error);
        showToast(error.message || 'Erreur lors de l\'enregistrement', 'error');
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer';
        removeProgressBar();
    }
}

// Fonction pour cr√©er la barre de progression
function createProgressBar() {
    const progressHTML = `
        <div id="uploadProgress" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[70]">
            <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 shadow-2xl">
                <div class="text-center mb-4">
                    <i class="fas fa-cloud-upload-alt text-4xl text-orange-600 mb-3"></i>
                    <h3 class="text-lg font-semibold text-gray-800">Upload en cours...</h3>
                    <p id="progressText" class="text-sm text-gray-600 mt-2">Pr√©paration...</p>
                </div>
                
                <!-- Barre de progression -->
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-orange-500 to-orange-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <!-- Pourcentage -->
                <div class="text-center mt-3">
                    <span id="progressPercent" class="text-2xl font-bold text-orange-600">0%</span>
                </div>
                
                <!-- Animation -->
                <div class="flex justify-center mt-4">
                    <div class="flex space-x-2">
                        <div class="w-3 h-3 bg-orange-600 rounded-full animate-bounce"></div>
                        <div class="w-3 h-3 bg-orange-600 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-3 h-3 bg-orange-600 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', progressHTML);
}

// Fonction pour mettre √† jour la barre de progression
function updateProgressBar(percent) {
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    
    if (progressBar && progressPercent) {
        progressBar.style.width = `${percent}%`;
        progressPercent.textContent = `${Math.round(percent)}%`;
    }
}

// Fonction pour mettre √† jour le texte de progression
function updateProgressText(text) {
    const progressText = document.getElementById('progressText');
    if (progressText) {
        progressText.textContent = text;
    }
}

// Fonction pour supprimer la barre de progression
function removeProgressBar() {
    const progressElement = document.getElementById('uploadProgress');
    if (progressElement) {
        setTimeout(() => {
            progressElement.remove();
        }, 500);
    }
}

// VERSION AM√âLIOR√âE avec upload par chunks pour les tr√®s gros fichiers (> 5MB)
async function uploadLargeFile(file, paiementId, onProgress) {
    const chunkSize = 1024 * 1024; // 1MB par chunk
    const totalChunks = Math.ceil(file.size / chunkSize);
    
    for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
        const start = chunkIndex * chunkSize;
        const end = Math.min(start + chunkSize, file.size);
        const chunk = file.slice(start, end);
        
        const formData = new FormData();
        formData.append('chunk', chunk);
        formData.append('chunkIndex', chunkIndex);
        formData.append('totalChunks', totalChunks);
        formData.append('fileName', file.name);
        formData.append('fileSize', file.size);
        
        const response = await fetch(`${API_BASE_URL}/api/paiements/${paiementId}/fichiers/chunk`, {
            method: 'POST',
            headers: {
                'X-User-ID': currentUserId
            },
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`Erreur upload chunk ${chunkIndex + 1}/${totalChunks}`);
        }
        
        // Callback de progression
        if (onProgress) {
            onProgress((chunkIndex + 1) / totalChunks * 100);
        }
    }
    
    return true;
}

// Fonction saveFilesToDB am√©lior√©e avec support des gros fichiers
async function saveFilesToDBImproved() {
    if (selectedFiles.length === 0) {
        showToast('Aucun fichier √† enregistrer', 'warning');
        return;
    }

    const paiement = allPaiements.find(p => p.numero_cr === currentAttachmentNumeroCR);
    if (!paiement || !paiement.id) {
        showToast('Impossible de trouver le paiement correspondant', 'error');
        return;
    }

    const uploadBtn = document.getElementById('uploadBtn');
    uploadBtn.disabled = true;
    
    createProgressBar();

    try {
        const totalFiles = selectedFiles.length;
        let uploadedFiles = 0;
        let totalProgress = 0;

        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            const fileSize = file.size / (1024 * 1024); // Taille en MB
            
            updateProgressText(`Upload de ${file.name}... (${i + 1}/${totalFiles})`);
            
            // Si le fichier fait plus de 5MB, utiliser l'upload par chunks
            if (fileSize > 5) {
                await uploadLargeFile(file, paiement.id, (fileProgress) => {
                    const overallProgress = ((uploadedFiles + (fileProgress / 100)) / totalFiles) * 100;
                    updateProgressBar(overallProgress);
                });
            } else {
                // Upload normal pour les petits fichiers
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE_URL}/api/paiements/${paiement.id}/fichiers`, {
                    method: 'POST',
                    headers: {
                        'X-User-ID': currentUserId
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Erreur sur ${file.name}: ${error.erreur || 'Erreur inconnue'}`);
                }
            }

            uploadedFiles++;
            totalProgress = (uploadedFiles / totalFiles) * 100;
            updateProgressBar(totalProgress);
        }

        showToast(`${uploadedFiles} fichier(s) enregistr√©(s) avec succ√®s`, 'success');
        
        selectedFiles = [];
        displaySelectedFiles();
        await loadExistingFilesLocal(currentAttachmentNumeroCR);
        
    } catch (error) {
        console.error('Erreur sauvegarde DB:', error);
        showToast(error.message || 'Erreur lors de l\'enregistrement', 'error');
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer';
        removeProgressBar();
    }
}

// Ajouter une validation de taille am√©lior√©e
function handleFiles(files) {
    const maxSize = 50 * 1024 * 1024; // Augmenter √† 50MB
    const validExtensions = ['jpg', 'jpeg', 'png', 'pdf', 'doc', 'docx'];
    
    Array.from(files).forEach(file => {
        // V√©rifier la taille
        if (file.size > maxSize) {
            showToast(`${file.name} est trop volumineux (max 50MB)`, 'error');
            return;
        }
        
        // V√©rifier l'extension
        const extension = file.name.split('.').pop().toLowerCase();
        if (!validExtensions.includes(extension)) {
            showToast(`${file.name} - format non support√©`, 'error');
            return;
        }
        
        // Avertissement pour les fichiers > 10MB
        const fileSize = file.size / (1024 * 1024);
        if (fileSize > 10) {
            showToast(`${file.name} (${fileSize.toFixed(2)}MB) - L'upload peut prendre du temps`, 'warning');
        }
        
        selectedFiles.push(file);
    });
    
    displaySelectedFiles();
}
    async function saveFilesLocally() {
    if (selectedFiles.length === 0) {
        showToast('Aucun fichier √† enregistrer', 'warning');
        return;
    }
    
    const uploadBtn = document.getElementById('uploadBtn');
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enregistrement...';
    
    try {
        // R√©cup√©rer les fichiers existants du localStorage
        const storageKey = `fichiers_${currentAttachmentNumeroCR}`;
        let fichiers = JSON.parse(localStorage.getItem(storageKey) || '[]');
        
        // Convertir chaque fichier en base64 et l'ajouter
        for (const file of selectedFiles) {
            const base64 = await convertFileToBase64(file);
            
            fichiers.push({
                id: Date.now() + Math.random(), // ID unique
                nom: file.name,
                type: file.type,
                taille: file.size,
                data: base64,
                date_upload: new Date().toISOString(),
                numero_cr: currentAttachmentNumeroCR,
                payment_id: currentAttachmentPaymentId
            });
        }
        
        // Sauvegarder dans le localStorage
        localStorage.setItem(storageKey, JSON.stringify(fichiers));
        
        showToast(`${selectedFiles.length} fichier(s) enregistr√©(s) localement`, 'success');
        
        // R√©initialiser la s√©lection
        selectedFiles = [];
        displaySelectedFiles();
        
        // Recharger la liste des fichiers existants
        loadExistingFilesLocal(currentAttachmentNumeroCR);
        
    } catch (error) {
        console.error('Erreur sauvegarde locale:', error);
        
        if (error.name === 'QuotaExceededError') {
            showToast('Espace de stockage insuffisant. Supprimez des anciens fichiers.', 'error');
        } else {
            showToast('Erreur lors de l\'enregistrement des fichiers', 'error');
        }
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer localement';
    }
}

// Convertir un fichier en base64
function convertFileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// 3. Modifier la fonction loadExistingFilesLocal pour utiliser PostgreSQL
async function loadExistingFilesLocal(numeroCR) {
    try {
        const files = await loadExistingFilesFromDB(numeroCR);
        displayExistingFiles(files);
    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('existingFilesList').innerHTML = 
            '<p class="text-sm text-gray-500">Aucun fichier attach√©</p>';
    }
}

// Afficher les fichiers existants
function displayExistingFiles(files) {
    const container = document.getElementById('existingFilesList');
    
    if (!files || files.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500">Aucun fichier attach√©</p>';
        return;
    }
    
    container.innerHTML = files.map(file => `
        <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex items-center gap-3">
                <i class="fas fa-file-${getFileIcon(file.nom)} text-2xl text-blue-600"></i>
                <div>
                    <p class="font-medium text-sm">${file.nom}</p>
                    <p class="text-xs text-gray-500">
                        ${formatFileSize(file.taille)} ‚Ä¢ ${new Date(file.date_upload).toLocaleDateString('fr-FR')}
                    </p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="downloadFileLocal(${file.id})" class="text-blue-600 hover:text-blue-800 p-2" title="T√©l√©charger">
                    <i class="fas fa-download"></i>
                </button>
                <button onclick="viewFileLocal(${file.id})" class="text-green-600 hover:text-green-800 p-2" title="Visualiser">
                    <i class="fas fa-eye"></i>
                </button>
                <button onclick="deleteFileLocal(${file.id})" class="text-red-600 hover:text-red-800 p-2" title="Supprimer">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}
// 4. Modifier les fonctions de gestion des fichiers
function downloadFileLocal(fichierId) {
    // ‚úÖ CORRECTION : Utiliser fichierId directement (pas besoin de window.open)
    const url = `${API_BASE_URL}/api/fichiers/${fichierId}/download`;
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', '');
    link.setAttribute('target', '_blank');
    
    // Ajouter le header X-User-ID via les cookies ou autre m√©thode
    fetch(url, {
        headers: { 'X-User-ID': currentUserId }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Erreur de t√©l√©chargement');
    })
    .then(blob => {
        const downloadUrl = window.URL.createObjectURL(blob);
        link.href = downloadUrl;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(downloadUrl);
    })
    .catch(error => {
        console.error('Erreur:', error);
        showToast('Erreur lors du t√©l√©chargement', 'error');
    });
}

function viewFileLocal(fichierId) {
    // ‚úÖ CORRECTION : Ouvrir directement l'URL avec l'ID
    const url = `${API_BASE_URL}/api/fichiers/${fichierId}/view`;
    
    // Cr√©er une requ√™te avec les headers
    fetch(url, {
        headers: { 'X-User-ID': currentUserId }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Fichier non trouv√©');
    })
    .then(blob => {
        const fileUrl = window.URL.createObjectURL(blob);
        window.open(fileUrl, '_blank');
        // Lib√©rer l'URL apr√®s un d√©lai
        setTimeout(() => window.URL.revokeObjectURL(fileUrl), 1000);
    })
    .catch(error => {
        console.error('Erreur:', error);
        showToast('Fichier introuvable', 'error');
    });
}

async function deleteFileLocal(fichierId) {
    if (!confirm('Supprimer ce fichier d√©finitivement ?')) return;
    
    try {
        const response = await fetch(`${API_BASE_URL}/api/fichiers/${fichierId}`, {
            method: 'DELETE',
            headers: { 'X-User-ID': currentUserId }
        });

        if (response.ok) {
            showToast('Fichier supprim√©', 'success');
            await loadExistingFilesLocal(currentAttachmentNumeroCR);
        } else {
            const error = await response.json();
            throw new Error(error.erreur || 'Erreur de suppression');
        }
    } catch (error) {
        console.error('Erreur suppression:', error);
        showToast(error.message || 'Erreur lors de la suppression', 'error');
    }
}



// BONUS : Fonction pour exporter tous les fichiers d'un paiement
function exporterTousFichiers(numeroCR) {
    try {
        const storageKey = `fichiers_${numeroCR}`;
        const fichiers = JSON.parse(localStorage.getItem(storageKey) || '[]');
        
        if (fichiers.length === 0) {
            showToast('Aucun fichier √† exporter', 'warning');
            return;
        }
        
        // T√©l√©charger chaque fichier
        fichiers.forEach(file => {
            setTimeout(() => {
                const link = document.createElement('a');
                link.href = file.data;
                link.download = file.nom;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }, 500);
        });
        
        showToast(`${fichiers.length} fichier(s) export√©(s)`, 'success');
    } catch (error) {
        console.error('Erreur export:', error);
        showToast('Erreur lors de l\'export', 'error');
    }
}
        // Fonction pour g√©n√©rer le badge du num√©ro de re√ßu avec style selon le type
function getBadgeNumero(numeroCR) {
    if (!numeroCR) {
        return '<span class="text-xs text-gray-400">N/A</span>';
    }
    
    // Extraire le type d'examen du num√©ro (4√®me caract√®re)
    const typeCode = numeroCR.charAt(3);
    
    // Classes CSS selon le type
    const typeClasses = {
        'H': 'badge-histologie',
        'B': 'badge-biopsie',
        'C': 'badge-cytologie',
        'F': 'badge-fcv',
        'I': 'badge-immuno'
    };
    
    const badgeClass = typeClasses[typeCode] || 'badge-recu';
    
    return `
        <div class="flex flex-col gap-1">
            <span class="badge-recu ${badgeClass}">
                <i class="fas fa-receipt"></i>
                ${numeroCR}
            </span>
            <span class="text-xs text-gray-500">
                ${getDescriptionNumero(numeroCR)}
            </span>
        </div>
    `;
}
    </script>
 <!-- Modal Attacher Fichier -->
<div id="attachmentModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] hidden modal-overlay">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl mx-4 shadow-2xl">
        <div class="flex justify-between items-center mb-5 pb-3 border-b">
            <h3 class="text-xl font-semibold text-orange-700">
                <i class="fas fa-paperclip mr-2"></i>Attacher des Fichiers
            </h3>
            <button onclick="closeAttachmentModal()" class="text-gray-500 hover:text-gray-800 text-2xl">
                √ó
            </button>
        </div>

        <div class="mb-4 p-4 bg-orange-50 border-l-4 border-orange-500 rounded">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-orange-600 mr-3"></i>
                <div>
                    <p class="font-medium text-orange-800">Dossier : <span id="attachmentFolder" class="font-bold"></span></p>
                    <p class="text-sm text-orange-700 mt-1">Les fichiers seront enregistr√©s avec ce num√©ro de re√ßu</p>
                </div>
            </div>
        </div>

        <!-- Zone de drop -->
        <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-orange-500 transition cursor-pointer mb-4">
            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
            <p class="text-gray-600 mb-2">Glissez vos fichiers ici ou cliquez pour parcourir</p>
            <p class="text-sm text-gray-500">Formats accept√©s: JPG, PNG, PDF, DOCX (Max 10MB par fichier)</p>
            <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx" class="hidden">
        </div>

        <!-- Liste des fichiers s√©lectionn√©s -->
        <div id="filesList" class="mb-4 max-h-48 overflow-y-auto"></div>

        <!-- Fichiers d√©j√† attach√©s -->
        <div id="existingFiles" class="mb-4">
            <h4 class="font-medium text-gray-700 mb-2">Fichiers d√©j√† attach√©s:</h4>
            <div id="existingFilesList" class="space-y-2"></div>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t">
            <button onclick="closeAttachmentModal()" class="px-5 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition">
                Fermer
            </button>
          <button onclick="saveFilesToDBImproved()" id="uploadBtn" class="px-5 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition flex items-center gap-2">
    <i class="fas fa-save"></i> Enregistrer
</button>
        </div>
    </div>
</div>
</body>
</html>
