<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Paiements - ANAPATH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .kpi-card { transition: all 0.3s ease; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
        }
        
        .tab-active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        
        .payment-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .payment-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .status-comptant { border-left-color: #10b981; }
        .status-a_terme { border-left-color: #f59e0b; }
        .status-paiement_partiel { border-left-color: #3b82f6; }
        
        .badge-espece { background-color: #d1fae5; color: #065f46; }
        .badge-a_terme { background-color: #fef3c7; color: #92400e; }
        .badge-partiel { background-color: #dbeafe; color: #1e40af; }
        
        .solde-positif { color: #10b981; }
        .solde-negatif { color: #ef4444; }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        
        .table-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .drawer-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1);
        }
        
        .drawer-content.open {
            max-height: 2000px;
        }
        
        .filter-active {
            background-color: #4f46e5;
            color: white;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.warning { background: #f59e0b; }
        .toast.show { display: flex; align-items: center; }
        .toast.hide { display: none; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-credit-card text-2xl text-blue-300"></i>
                <h1 class="text-2xl font-bold">Gestion des Paiements</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="currentUser" class="text-sm bg-white/20 px-3 py-1 rounded-full"></span>
                <a href="index.html" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition flex items-center space-x-2">
                    <i class="fas fa-home"></i>
                    <span>Accueil</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- En-tête et KPI -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Tableau de Bord Paiements</h2>
            <p class="text-gray-600">Gérez les paiements, les dettes et consultez les statistiques financières</p>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 animate-fade-in">
            <div class="kpi-card bg-gradient-to-br from-green-500 to-emerald-600 text-white p-6 rounded-xl shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Total Encaisse</p>
                        <p id="totalEncaisse" class="text-3xl font-bold">0 DA</p>
                    </div>
                    <i class="fas fa-money-bill-wave text-4xl opacity-30"></i>
                </div>
                <div class="mt-4 pt-3 border-t border-white/20">
                    <p class="text-xs opacity-80">Aujourd'hui: <span id="encaisseAujourdhui">0 DA</span></p>
                </div>
            </div>

            <div class="kpi-card bg-gradient-to-br from-orange-500 to-red-600 text-white p-6 rounded-xl shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Dettes Actives</p>
                        <p id="totalDettes" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-file-invoice-dollar text-4xl opacity-30"></i>
                </div>
                <div class="mt-4 pt-3 border-t border-white/20">
                    <p class="text-xs opacity-80">Montant total: <span id="montantDettes">0 DA</span></p>
                </div>
            </div>

            <div class="kpi-card bg-gradient-to-br from-blue-500 to-cyan-600 text-white p-6 rounded-xl shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Paiements</p>
                        <p id="totalPaiements" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-credit-card text-4xl opacity-30"></i>
                </div>
                <div class="mt-4 pt-3 border-t border-white/20">
                    <p class="text-xs opacity-80">Ce mois: <span id="paiementsMois">0</span></p>
                </div>
            </div>

            <div class="kpi-card bg-gradient-to-br from-purple-500 to-pink-600 text-white p-6 rounded-xl shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Patients Detteurs</p>
                        <p id="patientsDetteurs" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-user-clock text-4xl opacity-30"></i>
                </div>
                <div class="mt-4 pt-3 border-t border-white/20">
                    <p class="text-xs opacity-80">À suivre</p>
                </div>
            </div>
        </div>

        <!-- Onglets -->
        <div class="mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="showTab('nouveau')" id="tab-nouveau" class="py-3 px-1 border-b-2 font-medium text-lg tab-active">
                        <i class="fas fa-plus-circle mr-2"></i>Nouveau Paiement
                    </button>
                    <button onclick="showTab('liste')" id="tab-liste" class="py-3 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-list mr-2"></i>Liste des Paiements
                    </button>
                    <button onclick="showTab('dettes')" id="tab-dettes" class="py-3 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Dettes Actives
                    </button>
                    <button onclick="showTab('statistiques')" id="tab-statistiques" class="py-3 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-chart-bar mr-2"></i>Statistiques
                    </button>
                    <button onclick="showTab('rapports')" id="tab-rapports" class="py-3 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-file-alt mr-2"></i>Rapports
                    </button>
                </nav>
            </div>
        </div>

        <!-- Contenu des onglets -->
        <div id="content-nouveau" class="tab-content animate-fade-in">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-cash-register mr-2 text-indigo-600"></i>Enregistrer un Paiement
                </h3>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Formulaire de paiement -->
                    <div class="space-y-6">
                        <!-- Sélection du patient -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user-injured mr-2 text-blue-600"></i>Sélectionner un Patient*
                            </label>
                            <div class="flex gap-2">
                                <select id="patientSelect" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required onchange="updatePatientInfo()">
                                    <option value="">Chargement des patients...</option>
                                </select>
                                <button onclick="loadPatients()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-lg transition" title="Actualiser">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div id="patientInfo" class="mt-3 p-4 bg-blue-50 rounded-lg hidden">
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div><span class="font-medium">Âge:</span> <span id="infoAge">-</span></div>
                                    <div><span class="font-medium">Sexe:</span> <span id="infoSexe">-</span></div>
                                    <div><span class="font-medium">Téléphone:</span> <span id="infoTel">-</span></div>
                                    <div><span class="font-medium">Solde actuel:</span> <span id="infoSolde" class="font-bold">0 DA</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Type de paiement -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-money-check-alt mr-2 text-green-600"></i>Type de Paiement*
                            </label>
                            <div class="grid grid-cols-3 gap-4">
                                <label class="cursor-pointer">
                                    <input type="radio" name="modePaiement" value="espece" checked class="sr-only peer" onchange="toggleMontantTotal()">
                                    <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-green-500 peer-checked:bg-green-50 transition-all">
                                        <i class="fas fa-money-bill-wave text-2xl text-green-600 mb-2"></i>
                                        <p class="font-medium">Comptant</p>
                                        <p class="text-xs text-gray-500 mt-1">Paiement immédiat</p>
                                    </div>
                                </label>
                                
                                <label class="cursor-pointer">
                                    <input type="radio" name="modePaiement" value="a_terme" class="sr-only peer" onchange="toggleMontantTotal()">
                                    <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-orange-500 peer-checked:bg-orange-50 transition-all">
                                        <i class="fas fa-calendar-alt text-2xl text-orange-600 mb-2"></i>
                                        <p class="font-medium">À Terme</p>
                                        <p class="text-xs text-gray-500 mt-1">Paiement différé</p>
                                    </div>
                                </label>
                                
                                <label class="cursor-pointer">
                                    <input type="radio" name="modePaiement" value="paiement_partiel" class="sr-only peer" onchange="toggleMontantTotal()">
                                    <div class="p-4 border-2 border-gray-200 rounded-lg text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 transition-all">
                                        <i class="fas fa-hand-holding-usd text-2xl text-blue-600 mb-2"></i>
                                        <p class="font-medium">Partiel</p>
                                        <p class="text-xs text-gray-500 mt-1">Règlement dette</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Montants -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div id="montantTotalGroup" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Montant Total (DA)*
                                </label>
                                <input type="number" id="montantTotal" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" min="0" step="0.01" placeholder="0.00" oninput="updateRecap()">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Montant Payé (DA)*
                                </label>
                                <input type="number" id="montantPaye" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" min="0" step="0.01" placeholder="0.00" required oninput="updateRecap()">
                            </div>
                        </div>

                        <!-- Détails supplémentaires -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-stethoscope mr-2 text-purple-600"></i>Type d'Acte
                                </label>
                                <select id="typePaiement" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <option value="consultation">Consultation</option>
                                    <option value="examen">Examen</option>
                                    <option value="biopsie">Biopsie</option>
                                    <option value="analyse">Analyse</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-file-invoice mr-2 text-gray-600"></i>Numéro de Reçu
                                </label>
                                <input type="text" id="numeroCR" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="CR-2024-001">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-comment-alt mr-2 text-gray-600"></i>Notes
                                </label>
                                <textarea id="notes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Informations supplémentaires..."></textarea>
                            </div>
                        </div>

                        <!-- Bouton d'enregistrement -->
                        <button onclick="enregistrerPaiement()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold py-4 px-6 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg">
                            <i class="fas fa-save mr-2"></i>Enregistrer le Paiement
                        </button>
                    </div>

                    <!-- Récapitulatif -->
                    <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                        <h4 class="text-lg font-semibold mb-6 text-gray-800">
                            <i class="fas fa-receipt mr-2 text-indigo-600"></i>Récapitulatif
                        </h4>
                        
                        <div id="recapContent" class="space-y-4">
                            <div class="text-center py-12 text-gray-400">
                                <i class="fas fa-file-invoice-dollar text-4xl mb-4"></i>
                                <p>Les détails du paiement apparaîtront ici</p>
                            </div>
                        </div>
                        
                        <!-- Résumé dynamique -->
                        <div id="recapDetails" class="mt-8 pt-6 border-t border-gray-200 hidden">
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Montant total:</span>
                                    <span id="recapTotal" class="font-semibold">0 DA</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Montant payé:</span>
                                    <span id="recapPaye" class="font-semibold text-green-600">0 DA</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Reste à payer:</span>
                                    <span id="recapReste" class="font-semibold text-orange-600">0 DA</span>
                                </div>
                                <div class="flex justify-between pt-3 border-t">
                                    <span class="text-gray-700 font-medium">Nouveau solde:</span>
                                    <span id="recapNouveauSolde" class="font-bold text-lg">0 DA</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Liste des Paiements -->
        <div id="content-liste" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 md:mb-0">
                        <i class="fas fa-history mr-2 text-indigo-600"></i>Historique des Paiements
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="toggleFiltres()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                            <i class="fas fa-filter mr-2"></i>Filtres
                        </button>
                        <button onclick="exporterExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                            <i class="fas fa-file-excel mr-2"></i>Excel
                        </button>
                        <button onclick="imprimerListe()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                            <i class="fas fa-print mr-2"></i>Imprimer
                        </button>
                    </div>
                </div>

                <!-- Panneau de filtres -->
                <div id="filtresPanel" class="drawer-content mb-6">
                    <div class="p-4 bg-gray-50 rounded-lg border">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Patient</label>
                                <select id="filterPatient" class="w-full px-3 py-2 border rounded-md">
                                    <option value="">Tous les patients</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date début</label>
                                <input type="date" id="filterDateDebut" class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date fin</label>
                                <input type="date" id="filterDateFin" class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mode paiement</label>
                                <select id="filterModePaiement" class="w-full px-3 py-2 border rounded-md">
                                    <option value="">Tous</option>
                                    <option value="espece">Comptant</option>
                                    <option value="a_terme">À terme</option>
                                    <option value="paiement_partiel">Partiel</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button onclick="appliquerFiltres()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">
                                Appliquer
                            </button>
                            <button onclick="reinitialiserFiltres()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition">
                                Réinitialiser
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mode</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reçu</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="listePaiements" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Chargement des paiements...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div id="pagination" class="mt-4 flex justify-between items-center hidden">
                    <div class="text-sm text-gray-700">
                        Affichage de <span id="paginationStart">0</span> à <span id="paginationEnd">0</span> sur <span id="paginationTotal">0</span> paiements
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="changePage(-1)" class="px-3 py-1 border rounded-md hover:bg-gray-50">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="currentPage" class="px-3 py-1">1</span>
                        <button onclick="changePage(1)" class="px-3 py-1 border rounded-md hover:bg-gray-50">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Dettes Actives -->
        <div id="content-dettes" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-exclamation-triangle mr-2 text-red-600"></i>Dettes Actives des Patients
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-clock text-2xl text-red-500 mr-3"></i>
                            <div>
                                <p class="text-sm text-red-700">Dettes en attente</p>
                                <p id="dettesEnAttente" class="text-2xl font-bold text-red-800">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-calendar-times text-2xl text-orange-500 mr-3"></i>
                            <div>
                                <p class="text-sm text-orange-700">Montant total dû</p>
                                <p id="montantTotalDu" class="text-2xl font-bold text-orange-800">0 DA</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-user-friends text-2xl text-blue-500 mr-3"></i>
                            <div>
                                <p class="text-sm text-blue-700">Patients concernés</p>
                                <p id="patientsConcernes" class="text-2xl font-bold text-blue-800">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Téléphone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dette totale</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dernier paiement</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="listeDettes" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                    Chargement des dettes...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Onglet Statistiques -->
        <div id="content-statistiques" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-chart-bar mr-2 text-indigo-600"></i>Statistiques Financières
                </h3>
                
                <!-- Filtres statistiques -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Période</label>
                            <select id="statPeriode" class="w-full px-3 py-2 border rounded-md" onchange="updateStatistiques()">
                                <option value="mois_courant">Mois courant</option>
                                <option value="mois_precedent">Mois précédent</option>
                                <option value="trimestre">Trimestre</option>
                                <option value="annee_courante">Année courante</option>
                                <option value="personnalise">Personnalisé</option>
                            </select>
                        </div>
                        <div id="statDateDebutGroup" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date début</label>
                            <input type="date" id="statDateDebut" class="w-full px-3 py-2 border rounded-md" onchange="updateStatistiques()">
                        </div>
                        <div id="statDateFinGroup" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date fin</label>
                            <input type="date" id="statDateFin" class="w-full px-3 py-2 border rounded-md" onchange="updateStatistiques()">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Graphique des paiements par type -->
                    <div class="bg-white rounded-xl p-6 border">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-chart-pie mr-2 text-indigo-600"></i>Répartition des Paiements
                        </h4>
                        <div class="h-80">
                            <canvas id="chartPaiements"></canvas>
                        </div>
                    </div>

                    <!-- Évolution mensuelle -->
                    <div class="bg-white rounded-xl p-6 border">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-chart-line mr-2 text-green-600"></i>Évolution Mensuelle
                        </h4>
                        <div class="h-80">
                            <canvas id="chartEvolution"></canvas>
                        </div>
                    </div>

                    <!-- Top patients -->
                    <div class="bg-white rounded-xl p-6 border lg:col-span-2">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-trophy mr-2 text-yellow-600"></i>Top 10 Patients
                        </h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Payé</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre de Paiements</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dernière Visite</th>
                                    </tr>
                                </thead>
                                <tbody id="topPatients" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                                            Chargement des données...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Rapports -->
        <div id="content-rapports" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-file-alt mr-2 text-indigo-600"></i>Rapports et Exports
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Rapport Journalier -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold mb-4 text-blue-800">
                            <i class="fas fa-calendar-day mr-2"></i>Rapport Journalier
                        </h4>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                            <input type="date" id="rapportDate" class="w-full px-3 py-2 border rounded-md" value="<?php echo date('Y-m-d'); ?>">
                        </div>
                        <button onclick="genererRapportJournalier()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                            <i class="fas fa-download mr-2"></i>Générer Rapport
                        </button>
                    </div>

                    <!-- Export Complet -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold mb-4 text-green-800">
                            <i class="fas fa-file-export mr-2"></i>Export Complet
                        </h4>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Format</label>
                            <select id="exportFormat" class="w-full px-3 py-2 border rounded-md">
                                <option value="json">JSON</option>
                                <option value="csv">CSV</option>
                                <option value="excel">Excel</option>
                            </select>
                        </div>
                        <button onclick="exporterDonneesCompletes()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                            <i class="fas fa-file-download mr-2"></i>Exporter Données
                        </button>
                    </div>

                    <!-- Synthèse Patient -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold mb-4 text-purple-800">
                            <i class="fas fa-user-chart mr-2"></i>Synthèse Patient
                        </h4>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Patient</label>
                            <select id="rapportPatient" class="w-full px-3 py-2 border rounded-md">
                                <option value="">Sélectionner un patient...</option>
                            </select>
                        </div>
                        <button onclick="genererSynthesePatient()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                            <i class="fas fa-user-md mr-2"></i>Voir Synthèse
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Détail Paiement -->
    <div id="modalDetail" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white rounded-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-file-invoice-dollar mr-2 text-indigo-600"></i>Détail du Paiement
                    </h3>
                    <button onclick="closeModalDetail()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6" id="modalDetailContent">
                <!-- Contenu chargé dynamiquement -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i id="toastIcon" class="mr-2"></i>
        <span id="toastMessage"></span>
    </div>

    <script>
        // Configuration API
        const API_BASE_URL = localStorage.getItem('apiBaseUrl') || 'https://anapath.onrender.com';
        let currentUserId = localStorage.getItem('userId');
        let allPaiements = [];
        let allPatients = [];
        let allDettes = [];
        let currentPage = 1;
        let perPage = 20;
        let totalPaiements = 0;
        let filtresActifs = {};

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            if (!currentUserId) {
                showToast('Veuillez vous connecter', 'error');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            updateCurrentUserDisplay();
            loadDashboardData();
            loadPatients();
            loadPaiements();
            loadDettes();
            chargerPatientsFiltre();
            
            // Initialiser les dates par défaut
            const aujourdhui = new Date().toISOString().split('T')[0];
            document.getElementById('rapportDate').value = aujourdhui;
            document.getElementById('filterDateDebut').value = aujourdhui;
            document.getElementById('filterDateFin').value = aujourdhui;
            
            // Écouteurs d'événements
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('patientSelect').addEventListener('change', updatePatientInfo);
            document.getElementById('montantPaye').addEventListener('input', updateRecap);
            document.getElementById('montantTotal').addEventListener('input', updateRecap);
            document.querySelectorAll('input[name="modePaiement"]').forEach(radio => {
                radio.addEventListener('change', toggleMontantTotal);
            });
            
            // Filtres
            document.getElementById('statPeriode').addEventListener('change', function() {
                const periode = this.value;
                const dateDebutGroup = document.getElementById('statDateDebutGroup');
                const dateFinGroup = document.getElementById('statDateFinGroup');
                
                if (periode === 'personnalise') {
                    dateDebutGroup.classList.remove('hidden');
                    dateFinGroup.classList.remove('hidden');
                } else {
                    dateDebutGroup.classList.add('hidden');
                    dateFinGroup.classList.add('hidden');
                }
                updateStatistiques();
            });
        }

        function updateCurrentUserDisplay() {
            const selectedUser = JSON.parse(localStorage.getItem('selectedUtilisateur') || '{}');
            const displayName = selectedUser.nom || 'Utilisateur non sélectionné';
            document.getElementById('currentUser').textContent = displayName;
        }

        function showTab(tabName) {
            // Cacher tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Désactiver tous les onglets
            document.querySelectorAll('button[onclick^="showTab"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });

            // Afficher l'onglet sélectionné
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Activer le bouton correspondant
            const tabBtn = document.getElementById(`tab-${tabName}`);
            tabBtn.classList.add('tab-active');
            tabBtn.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            
            // Actions spécifiques par onglet
            if (tabName === 'statistiques') {
                updateStatistiques();
            }
        }

        async function loadDashboardData() {
            try {
                const [paiementsRes, patientsRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/paiements`, {
                        headers: { 'X-User-ID': currentUserId }
                    }),
                    fetch(`${API_BASE_URL}/patients`, {
                        headers: { 'X-User-ID': currentUserId }
                    })
                ]);

                if (paiementsRes.ok && patientsRes.ok) {
                    const paiements = await paiementsRes.json();
                    const patients = await patientsRes.json();

                    // Calculer les KPI
                    const totalEncaisse = paiements.reduce((sum, p) => sum + parseFloat(p.montant || 0), 0);
                    const aujourdhui = new Date().toISOString().split('T')[0];
                    const encaisseAujourdhui = paiements
                        .filter(p => p.date_paiement && p.date_paiement.startsWith(aujourdhui))
                        .reduce((sum, p) => sum + parseFloat(p.montant || 0), 0);

                    const dettes = patients.filter(p => parseFloat(p.solde || 0) < 0);
                    const montantDettes = dettes.reduce((sum, p) => sum + Math.abs(parseFloat(p.solde || 0)), 0);

                    // Paiements ce mois
                    const moisCourant = new Date().toISOString().slice(0, 7);
                    const paiementsMois = paiements.filter(p => 
                        p.date_paiement && p.date_paiement.startsWith(moisCourant)
                    ).length;

                    // Mettre à jour les KPI
                    document.getElementById('totalEncaisse').textContent = `${totalEncaisse.toFixed(2)} DA`;
                    document.getElementById('encaisseAujourdhui').textContent = `${encaisseAujourdhui.toFixed(2)} DA`;
                    document.getElementById('totalDettes').textContent = dettes.length;
                    document.getElementById('montantDettes').textContent = `${montantDettes.toFixed(2)} DA`;
                    document.getElementById('totalPaiements').textContent = paiements.length;
                    document.getElementById('patientsDetteurs').textContent = dettes.length;
                    document.getElementById('paiementsMois').textContent = paiementsMois;
                }
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
            }
        }

        async function loadPatients() {
            try {
                const response = await fetch(`${API_BASE_URL}/patients`, {
                    headers: { 'X-User-ID': currentUserId }
                });

                if (response.ok) {
                    allPatients = await response.json();
                    const select = document.getElementById('patientSelect');
                    
                    select.innerHTML = '<option value="">Sélectionner un patient...</option>' +
                        allPatients.map(p => {
                            const solde = parseFloat(p.solde || 0);
                            const soldeFormatted = Math.abs(solde).toFixed(2);
                            
                            let soldeText = '';
                            let soldeClass = '';
                            
                            if (solde < 0) {
                                soldeText = ` (Dette: ${soldeFormatted} DA)`;
                                soldeClass = 'text-red-600 font-semibold';
                            } else if (solde > 0) {
                                soldeText = ` (Crédit: ${soldeFormatted} DA)`;
                                soldeClass = 'text-green-600 font-semibold';
                            }
                            
                            return `<option value="${p.id}" 
                                data-age="${p.age || ''}" 
                                data-sexe="${p.sexe || ''}" 
                                data-tel="${p.telephone || ''}" 
                                data-solde="${solde}"
                                class="${soldeClass}">
                                ${p.nom}${p.prenom ? ' ' + p.prenom : ''}${soldeText}
                            </option>`;
                        }).join('');
                }
            } catch (error) {
                console.error('Erreur chargement patients:', error);
                showToast('Erreur lors du chargement des patients', 'error');
            }
        }

        async function chargerPatientsFiltre() {
            try {
                const response = await fetch(`${API_BASE_URL}/patients`, {
                    headers: { 'X-User-ID': currentUserId }
                });

                if (response.ok) {
                    const patients = await response.json();
                    const selectFiltre = document.getElementById('filterPatient');
                    const selectRapport = document.getElementById('rapportPatient');
                    
                    const options = '<option value="">Tous les patients</option>' +
                        patients.map(p => 
                            `<option value="${p.id}">${p.nom}${p.prenom ? ' ' + p.prenom : ''}</option>`
                        ).join('');
                    
                    selectFiltre.innerHTML = options;
                    selectRapport.innerHTML = '<option value="">Sélectionner un patient...</option>' +
                        patients.map(p => 
                            `<option value="${p.id}">${p.nom}${p.prenom ? ' ' + p.prenom : ''}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Erreur chargement patients filtre:', error);
            }
        }

        function updatePatientInfo() {
            const select = document.getElementById('patientSelect');
            const selectedOption = select.options[select.selectedIndex];
            const infoDiv = document.getElementById('patientInfo');

            if (selectedOption && selectedOption.value) {
                const age = selectedOption.dataset.age || '-';
                const sexe = selectedOption.dataset.sexe || '-';
                const tel = selectedOption.dataset.tel || '-';
                const solde = parseFloat(selectedOption.dataset.solde || 0);

                document.getElementById('infoAge').textContent = age;
                document.getElementById('infoSexe').textContent = sexe;
                document.getElementById('infoTel').textContent = tel;
                document.getElementById('infoSolde').textContent = `${solde.toFixed(2)} DA`;
                document.getElementById('infoSolde').className = `font-bold ${solde < 0 ? 'text-red-600' : solde > 0 ? 'text-green-600' : 'text-gray-600'}`;

                infoDiv.classList.remove('hidden');
                updateRecap();
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        function toggleMontantTotal() {
            const mode = document.querySelector('input[name="modePaiement"]:checked').value;
            const montantTotalGroup = document.getElementById('montantTotalGroup');
            const recapDetails = document.getElementById('recapDetails');

            if (mode === 'a_terme') {
                montantTotalGroup.classList.remove('hidden');
                recapDetails.classList.remove('hidden');
            } else {
                montantTotalGroup.classList.add('hidden');
                if (mode === 'espece' || mode === 'paiement_partiel') {
                    recapDetails.classList.remove('hidden');
                }
            }
            updateRecap();
        }

        function updateRecap() {
            const patientSelect = document.getElementById('patientSelect');
            const mode = document.querySelector('input[name="modePaiement"]:checked').value;
            const montantPaye = parseFloat(document.getElementById('montantPaye').value) || 0;
            const montantTotal = parseFloat(document.getElementById('montantTotal').value) || 0;
            const soldeActuel = parseFloat(patientSelect.options[patientSelect.selectedIndex]?.dataset.solde || 0);

            let reste = 0;
            let nouveauSolde = soldeActuel;

            if (mode === 'a_terme') {
                reste = montantTotal - montantPaye;
                nouveauSolde = -reste;
            } else if (mode === 'paiement_partiel') {
                nouveauSolde = soldeActuel + montantPaye;
                reste = Math.abs(nouveauSolde) < 0.01 ? 0 : Math.abs(nouveauSolde);
            } else if (mode === 'espece') {
                nouveauSolde = soldeActuel;
                reste = 0;
            }

            // Mettre à jour les éléments du récapitulatif
            const recapContent = document.getElementById('recapContent');
            recapContent.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-4 bg-indigo-50 rounded-lg">
                        <span class="font-medium text-indigo-700">Mode de paiement:</span>
                        <span class="px-3 py-1 rounded-full text-sm ${mode === 'espece' ? 'badge-espece' : mode === 'a_terme' ? 'badge-a_terme' : 'badge-partiel'}">
                            ${mode === 'espece' ? 'Comptant' : mode === 'a_terme' ? 'À terme' : 'Paiement partiel'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600">Solde actuel</p>
                            <p class="text-xl font-bold ${soldeActuel < 0 ? 'text-red-600' : 'text-gray-800'}">
                                ${soldeActuel.toFixed(2)} DA
                            </p>
                        </div>
                        
                        <div class="p-4 bg-green-50 rounded-lg">
                            <p class="text-sm text-green-600">Montant payé</p>
                            <p class="text-xl font-bold text-green-700">
                                ${montantPaye.toFixed(2)} DA
                            </p>
                        </div>
                    </div>
                </div>
            `;

            // Mettre à jour les détails
            if (mode === 'a_terme') {
                document.getElementById('recapTotal').textContent = `${montantTotal.toFixed(2)} DA`;
            } else {
                document.getElementById('recapTotal').textContent = `${montantPaye.toFixed(2)} DA`;
            }
            
            document.getElementById('recapPaye').textContent = `${montantPaye.toFixed(2)} DA`;
            document.getElementById('recapReste').textContent = `${reste.toFixed(2)} DA`;
            document.getElementById('recapNouveauSolde').textContent = `${nouveauSolde.toFixed(2)} DA`;
            document.getElementById('recapNouveauSolde').className = `font-bold text-lg ${nouveauSolde < 0 ? 'text-red-600' : nouveauSolde > 0 ? 'text-green-600' : 'text-gray-600'}`;
        }

        async function enregistrerPaiement() {
            const patientId = document.getElementById('patientSelect').value;
            const mode = document.querySelector('input[name="modePaiement"]:checked').value;
            const montantPaye = parseFloat(document.getElementById('montantPaye').value);
            const montantTotal = parseFloat(document.getElementById('montantTotal').value);
            const typePaiement = document.getElementById('typePaiement').value;
            const numeroCR = document.getElementById('numeroCR').value;
            const notes = document.getElementById('notes').value;

            // Validation
            if (!patientId) {
                showToast('Veuillez sélectionner un patient', 'error');
                return;
            }

            if (!montantPaye || montantPaye <= 0) {
                showToast('Veuillez saisir un montant valide', 'error');
                return;
            }

            if (mode === 'a_terme' && (!montantTotal || montantTotal <= montantPaye)) {
                showToast('Pour un paiement à terme, le montant total doit être supérieur au montant payé', 'error');
                return;
            }

            try {
                const data = {
                    patient_id: patientId,
                    montant: montantPaye,
                    type_paiement: typePaiement,
                    mode_paiement: mode,
                    numero_cr: numeroCR,
                    notes: notes
                };

                if (mode === 'a_terme') {
                    data.montant_total = montantTotal;
                }

                let endpoint = `${API_BASE_URL}/paiements`;
                if (mode === 'paiement_partiel') {
                    endpoint = `${API_BASE_URL}/paiements/paiement-partiel`;
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': currentUserId
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast(result.message || 'Paiement enregistré avec succès', 'success');
                    
                    // Réinitialiser le formulaire
                    document.getElementById('montantPaye').value = '';
                    document.getElementById('montantTotal').value = '';
                    document.getElementById('numeroCR').value = '';
                    document.getElementById('notes').value = '';
                    
                    // Recharger les données
                    loadDashboardData();
                    loadPaiements();
                    loadDettes();
                    
                    // Revenir à l'onglet liste
                    showTab('liste');
                } else {
                    const error = await response.json();
                    throw new Error(error.erreur || 'Erreur lors de l\'enregistrement');
                }
            } catch (error) {
                console.error('Erreur enregistrement paiement:', error);
                showToast(error.message, 'error');
            }
        }

        async function loadPaiements() {
            try {
                // Construire l'URL avec les filtres
                let url = `${API_BASE_URL}/paiements?page=${currentPage}&per_page=${perPage}`;
                
                if (filtresActifs.patient_id) {
                    url += `&patient_id=${filtresActifs.patient_id}`;
                }
                if (filtresActifs.date_debut) {
                    url += `&date_debut=${filtresActifs.date_debut}`;
                }
                if (filtresActifs.date_fin) {
                    url += `&date_fin=${filtresActifs.date_fin}`;
                }
                if (filtresActifs.mode_paiement) {
                    url += `&mode_paiement=${filtresActifs.mode_paiement}`;
                }

                const response = await fetch(url, {
                    headers: { 'X-User-ID': currentUserId }
                });

                if (response.ok) {
                    const data = await response.json();
                    allPaiements = data.paiements || data;
                    totalPaiements = data.pagination ? data.pagination.total : allPaiements.length;
                    
                    renderPaiementsList();
                    updatePagination();
                }
            } catch (error) {
                console.error('Erreur chargement paiements:', error);
                showToast('Erreur lors du chargement des paiements', 'error');
            }
        }

        function renderPaiementsList() {
            const tbody = document.getElementById('listePaiements');
            
            if (allPaiements.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4 text-gray-300"></i>
                            <p class="mt-2">Aucun paiement enregistré</p>
                            ${Object.keys(filtresActifs).length > 0 ? 
                                '<p class="text-sm mt-1">Essayez de modifier vos filtres</p>' : ''}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = allPaiements.map(p => {
                const date = new Date(p.date_paiement).toLocaleDateString('fr-FR');
                const heure = new Date(p.date_paiement).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                
                let modeBadge = '';
                if (p.mode_paiement === 'espece') {
                    modeBadge = '<span class="badge-espece px-2 py-1 rounded-full text-xs">Comptant</span>';
                } else if (p.mode_paiement === 'a_terme') {
                    modeBadge = '<span class="badge-a_terme px-2 py-1 rounded-full text-xs">À terme</span>';
                } else {
                    modeBadge = '<span class="badge-partiel px-2 py-1 rounded-full text-xs">Partiel</span>';
                }

                return `
                    <tr class="payment-card status-${p.mode_paiement} hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${date}</div>
                            <div class="text-sm text-gray-500">${heure}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${p.patient_nom_complet || p.patient_nom || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${p.patient_telephone || ''}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${p.type_paiement}</div>
                        </td>
                        <td class="px-6 py-4">
                            ${modeBadge}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-bold text-gray-900">${parseFloat(p.montant).toFixed(2)} DA</div>
                            ${p.mode_paiement === 'a_terme' && p.montant_total ? 
                                `<div class="text-xs text-gray-500">Total: ${parseFloat(p.montant_total).toFixed(2)} DA</div>` : ''}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${p.numero_cr || '-'}</div>
                        </td>
                        <td class="px-6 py-4 text-sm font-medium">
                            <button onclick="viewPaymentDetail(${p.id})" class="text-indigo-600 hover:text-indigo-900 mr-3" title="Voir détail">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="printReceipt(${p.id})" class="text-green-600 hover:text-green-900 mr-3" title="Imprimer reçu">
                                <i class="fas fa-print"></i>
                            </button>
                            <button onclick="deletePayment(${p.id})" class="text-red-600 hover:text-red-900" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function toggleFiltres() {
            document.getElementById('filtresPanel').classList.toggle('open');
        }

        function appliquerFiltres() {
            filtresActifs = {};
            
            const patientId = document.getElementById('filterPatient').value;
            const dateDebut = document.getElementById('filterDateDebut').value;
            const dateFin = document.getElementById('filterDateFin').value;
            const modePaiement = document.getElementById('filterModePaiement').value;
            
            if (patientId) filtresActifs.patient_id = patientId;
            if (dateDebut) filtresActifs.date_debut = dateDebut;
            if (dateFin) filtresActifs.date_fin = dateFin;
            if (modePaiement) filtresActifs.mode_paiement = modePaiement;
            
            currentPage = 1;
            loadPaiements();
            showToast('Filtres appliqués', 'success');
        }

        function reinitialiserFiltres() {
            document.getElementById('filterPatient').value = '';
            document.getElementById('filterDateDebut').value = '';
            document.getElementById('filterDateFin').value = '';
            document.getElementById('filterModePaiement').value = '';
            
            filtresActifs = {};
            currentPage = 1;
            loadPaiements();
            showToast('Filtres réinitialisés', 'success');
        }

        function updatePagination() {
            const paginationDiv = document.getElementById('pagination');
            const start = (currentPage - 1) * perPage + 1;
            const end = Math.min(currentPage * perPage, totalPaiements);
            
            if (totalPaiements > perPage) {
                paginationDiv.classList.remove('hidden');
                document.getElementById('paginationStart').textContent = start;
                document.getElementById('paginationEnd').textContent = end;
                document.getElementById('paginationTotal').textContent = totalPaiements;
                document.getElementById('currentPage').textContent = currentPage;
            } else {
                paginationDiv.classList.add('hidden');
            }
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            const totalPages = Math.ceil(totalPaiements / perPage);
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadPaiements();
            }
        }

        async function loadDettes() {
            try {
                const response = await fetch(`${API_BASE_URL}/paiements/dettes-actives`, {
                    headers: { 'X-User-ID': currentUserId }
                });

                if (response.ok) {
                    const dettes = await response.json();
                    allDettes = dettes;
                    renderDettesList();
                    loadStatistiquesDettes();
                }
            } catch (error) {
                console.error('Erreur chargement dettes:', error);
                showToast('Erreur lors du chargement des dettes', 'error');
            }
        }

        async function loadStatistiquesDettes() {
            try {
                const response = await fetch(`${API_BASE_URL}/paiements/statistiques-dettes`, {
                    headers: { 'X-User-ID': currentUserId }
                });

                if (response.ok) {
                    const stats = await response.json();
                    
                    if (stats.statistiques) {
                        const stat = stats.statistiques;
                        document.getElementById('dettesEnAttente').textContent = stat.nombre_patients_dette || 0;
                        document.getElementById('montantTotalDu').textContent = `${(stat.montant_total_dettes || 0).toFixed(2)} DA`;
                        document.getElementById('patientsConcernes').textContent = stat.nombre_patients_dette || 0;
                    }
                }
            } catch (error) {
                console.error('Erreur chargement statistiques:', error);
            }
        }

        function renderDettesList() {
            const tbody = document.getElementById('listeDettes');
            
            if (allDettes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-check-circle text-4xl mb-4 text-green-300"></i>
                            <p class="mt-2">Aucune dette active</p>
                            <p class="text-sm mt-1">Tous les patients sont à jour dans leurs paiements</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = allDettes.map(patient => {
                const dette = patient.montant_dette || Math.abs(parseFloat(patient.solde || 0));
                const nomComplet = `${patient.nom}${patient.prenom ? ' ' + patient.prenom : ''}`;
                const dernierPaiement = patient.dernier_paiement ? 
                    new Date(patient.dernier_paiement).toLocaleDateString('fr-FR') : 'Aucun';
                
                return `
                    <tr class="hover:bg-red-50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 bg-red-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-red-600"></i>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${nomComplet}</div>
                                    ${patient.age ? `<div class="text-xs text-gray-500">${patient.age} ans</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${patient.telephone || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <i class="fas fa-money-bill-wave text-red-500 mr-2"></i>
                                <div>
                                    <div class="text-lg font-bold text-red-600">${dette.toFixed(2)} DA</div>
                                    ${patient.nombre_paiements ? 
                                        `<div class="text-xs text-gray-500">${patient.nombre_paiements} paiement(s)</div>` : 
                                        ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-500">${dernierPaiement}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex space-x-2">
                                <button onclick="payerDette(${patient.id})" 
                                        class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-4 py-2 rounded-lg transition flex items-center shadow-md hover:shadow-lg">
                                    <i class="fas fa-money-bill-wave mr-2"></i>Régler
                                </button>
                                <button onclick="voirHistoriquePatient(${patient.id})" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                                    <i class="fas fa-history mr-2"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function updateStatistiques() {
            try {
                // Récupérer les paramètres de période
                const periode = document.getElementById('statPeriode').value;
                let dateDebut, dateFin;
                
                const aujourdhui = new Date();
                
                switch(periode) {
                    case 'mois_courant':
                        dateDebut = new Date(aujourdhui.getFullYear(), aujourdhui.getMonth(), 1).toISOString().split('T')[0];
                        dateFin = aujourdhui.toISOString().split('T')[0];
                        break;
                    case 'mois_precedent':
                        const premierJourMoisPrecedent = new Date(aujourdhui.getFullYear(), aujourdhui.getMonth() - 1, 1);
                        const dernierJourMoisPrecedent = new Date(aujourdhui.getFullYear(), aujourdhui.getMonth(), 0);
                        dateDebut = premierJourMoisPrecedent.toISOString().split('T')[0];
                        dateFin = dernierJourMoisPrecedent.toISOString().split('T')[0];
                        break;
                    case 'personnalise':
                        dateDebut = document.getElementById('statDateDebut').value;
                        dateFin = document.getElementById('statDateFin').value;
                        break;
                    default:
                        dateDebut = '';
                        dateFin = '';
                }
                
                // Charger les statistiques
                let url = `${API_BASE_URL}/paiements/statistiques`;
                if (dateDebut) url += `?date_debut=${dateDebut}`;
                if (dateFin) url += `${dateDebut ? '&' : '?'}date_fin=${dateFin}`;
                
                const response = await fetch(url, {
                    headers: { 'X-User-ID': currentUserId }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    renderStatistiques(stats);
                }
            } catch (error) {
                console.error('Erreur chargement statistiques:', error);
            }
        }

        function renderStatistiques(stats) {
            // Mettre à jour les graphiques
            renderChartPaiements(stats.par_mode_paiement);
            renderChartEvolution(stats.evolution_mensuelle);
            
            // Mettre à jour le tableau Top Patients
            const tbody = document.getElementById('topPatients');
            if (stats.top_patients && stats.top_patients.length > 0) {
                tbody.innerHTML = stats.top_patients.map(patient => `
                    <tr class="hover:bg-yellow-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">
                                ${patient.nom}${patient.prenom ? ' ' + patient.prenom : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-bold text-green-600">${parseFloat(patient.total_paye || 0).toFixed(2)} DA</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${patient.nombre_paiements || 0}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-500">-</div>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                            Aucune donnée disponible
                        </td>
                    </tr>
                `;
            }
        }

        function renderChartPaiements(data) {
            const ctx = document.getElementById('chartPaiements').getContext('2d');
            
            // Détruire le graphique existant
            if (window.chartPaiements) {
                window.chartPaiements.destroy();
            }
            
            const labels = data.map(item => {
                switch(item.mode_paiement) {
                    case 'espece': return 'Comptant';
                    case 'a_terme': return 'À terme';
                    case 'paiement_partiel': return 'Partiel';
                    default: return item.mode_paiement;
                }
            });
            
            const montants = data.map(item => parseFloat(item.total || 0));
            const couleurs = ['#10b981', '#f59e0b', '#3b82f6'];
            
            window.chartPaiements = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: montants,
                        backgroundColor: couleurs,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(2)} DA`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderChartEvolution(data) {
            const ctx = document.getElementById('chartEvolution').getContext('2d');
            
            // Détruire le graphique existant
            if (window.chartEvolution) {
                window.chartEvolution.destroy();
            }
            
            const labels = data.map(item => item.mois).reverse();
            const montants = data.map(item => parseFloat(item.total_montant || 0)).reverse();
            
            window.chartEvolution = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Montant total (DA)',
                        data: montants,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' DA';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Montant: ${context.parsed.y.toFixed(2)} DA`;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function genererRapportJournalier() {
            const date = document.getElementById('rapportDate').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/paiements/rapport-journalier?date=${date}`, {
                    headers: { 'X-User-ID': currentUserId }
                });
                
                if (response.ok) {
                    const rapport = await response.json();
                    
                    // Afficher le rapport dans une modal
                    const modalContent = `
                        <div class="space-y-6">
                            <div class="p-4 bg-indigo-50 rounded-lg">
                                <h4 class="text-lg font-semibold text-indigo-800">
                                    <i class="fas fa-calendar-day mr-2"></i>Rapport Journalier
                                </h4>
                                <p class="text-indigo-700">Date: ${date}</p>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-4 bg-green-50 rounded-lg">
                                    <p class="text-sm text-green-600">Total général</p>
                                    <p class="text-2xl font-bold text-green-700">${rapport.total_general.toFixed(2)} DA</p>
                                </div>
                                <div class="p-4 bg-blue-50 rounded-lg">
                                    <p class="text-sm text-blue-600">Nombre de paiements</p>
                                    <p class="text-2xl font-bold text-blue-700">${rapport.nombre_paiements}</p>
                                </div>
                            </div>
                            
                            ${rapport.totaux_par_mode.length > 0 ? `
                                <div class="space-y-2">
                                    <h5 class="font-medium text-gray-700">Détails par mode de paiement:</h5>
                                    ${rapport.totaux_par_mode.map(mode => `
                                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                            <span>${mode.mode_paiement === 'espece' ? 'Comptant' : 
                                                   mode.mode_paiement === 'a_terme' ? 'À terme' : 
                                                   'Partiel'}</span>
                                            <span class="font-bold">${parseFloat(mode.total || 0).toFixed(2)} DA</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <div class="pt-4 border-t border-gray-200 flex justify-end">
                                <button onclick="imprimerRapport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition mr-2">
                                    <i class="fas fa-print mr-2"></i>Imprimer
                                </button>
                                <button onclick="closeModalDetail()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
                                    Fermer
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('modalDetailContent').innerHTML = modalContent;
                    document.getElementById('modalDetail').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erreur génération rapport:', error);
                showToast('Erreur lors de la génération du rapport', 'error');
            }
        }

        async function exporterDonneesCompletes() {
            const format = document.getElementById('exportFormat').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/paiements/export?format=${format}`, {
                    headers: { 'X-User-ID': currentUserId }
                });
                
                if (response.ok) {
                    if (format === 'json') {
                        const data = await response.json();
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `paiements_export_${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                    } else if (format === 'csv') {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `paiements_export_${new Date().toISOString().split('T')[0]}.csv`;
                        a.click();
                    } else if (format === 'excel') {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `paiements_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                        a.click();
                    }
                    
                    showToast('Export terminé avec succès', 'success');
                } else {
                    throw new Error('Erreur lors de l\'export');
                }
            } catch (error) {
                console.error('Erreur export:', error);
                showToast('Erreur lors de l\'export des données', 'error');
            }
        }

        async function genererSynthesePatient() {
            const patientId = document.getElementById('rapportPatient').value;
            
            if (!patientId) {
                showToast('Veuillez sélectionner un patient', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/paiements/synthese-patient/${patientId}`, {
                    headers: { 'X-User-ID': currentUserId }
                });
                
                if (response.ok) {
                    const synthese = await response.json();
                    const patient = synthese.patient;
                    
                    const modalContent = `
                        <div class="space-y-6">
                            <div class="p-4 bg-indigo-50 rounded-lg">
                                <h4 class="text-lg font-semibold text-indigo-800 mb-2">
                                    <i class="fas fa-user-chart mr-2"></i>Synthèse Patient
                                </h4>
                                <p class="text-indigo-700 font-bold">${patient.nom}${patient.prenom ? ' ' + patient.prenom : ''}</p>
                                <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                    <div><span class="font-medium">Âge:</span> ${patient.age || '-'}</div>
                                    <div><span class="font-medium">Sexe:</span> ${patient.sexe || '-'}</div>
                                    <div><span class="font-medium">Téléphone:</span> ${patient.telephone || '-'}</div>
                                    <div><span class="font-medium">Solde:</span> <span class="font-bold ${patient.solde < 0 ? 'text-red-600' : 'text-green-600'}">${parseFloat(patient.solde || 0).toFixed(2)} DA</span></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-4 bg-green-50 rounded-lg">
                                    <p class="text-sm text-green-600">Total payé</p>
                                    <p class="text-2xl font-bold text-green-700">${synthese.statistiques.total_paye.toFixed(2)} DA</p>
                                </div>
                                <div class="p-4 bg-blue-50 rounded-lg">
                                    <p class="text-sm text-blue-600">Nombre de paiements</p>
                                    <p class="text-2xl font-bold text-blue-700">${synthese.statistiques.nombre_total_paiements}</p>
                                </div>
                            </div>
                            
                            ${synthese.details_a_terme && synthese.details_a_terme.length > 0 ? `
                                <div class="space-y-2">
                                    <h5 class="font-medium text-gray-700">Détails des paiements à terme:</h5>
                                    ${synthese.details_a_terme.map(detail => `
                                        <div class="p-3 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-sm">${detail.date}</span>
                                                <span class="text-sm font-bold">${detail.montant_paye.toFixed(2)} / ${detail.montant_total.toFixed(2)} DA</span>
                                            </div>
                                            <div class="text-xs text-gray-600">
                                                Reste à payer: <span class="font-bold">${detail.reste_a_payer.toFixed(2)} DA</span>
                                                ${detail.numero_cr ? `• Reçu: ${detail.numero_cr}` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <div class="pt-4 border-t border-gray-200 flex justify-end">
                                <button onclick="imprimerSynthese()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition mr-2">
                                    <i class="fas fa-print mr-2"></i>Imprimer
                                </button>
                                <button onclick="closeModalDetail()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
                                    Fermer
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('modalDetailContent').innerHTML = modalContent;
                    document.getElementById('modalDetail').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erreur synthèse patient:', error);
                showToast('Erreur lors de la génération de la synthèse', 'error');
            }
        }

        async function voirHistoriquePatient(patientId) {
            try {
                const response = await fetch(`${API_BASE_URL}/paiements?patient_id=${patientId}`, {
                    headers: { 'X-User-ID': currentUserId }
                });

                if (response.ok) {
                    const paiements = await response.json();
                    const patient = allPatients.find(p => p.id == patientId);
                    
                    if (patient) {
                        const modalContent = `
                            <div class="space-y-6">
                                <div class="p-4 bg-indigo-50 rounded-lg">
                                    <h4 class="text-lg font-semibold text-indigo-800 mb-2">
                                        <i class="fas fa-user-clock mr-2"></i>Historique des paiements
                                    </h4>
                                    <p class="text-indigo-700 font-bold">${patient.nom}${patient.prenom ? ' ' + patient.prenom : ''}</p>
                                    <p class="text-sm text-gray-600">Solde actuel: <span class="font-bold ${patient.solde < 0 ? 'text-red-600' : 'text-green-600'}">${parseFloat(patient.solde || 0).toFixed(2)} DA</span></p>
                                </div>
                                
                                <div class="overflow-y-auto max-h-80">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mode</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Montant</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reçu</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            ${paiements.map(p => `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                                                        ${new Date(p.date_paiement).toLocaleDateString('fr-FR')}
                                                    </td>
                                                    <td class="px-4 py-3 whitespace-nowrap">
                                                        <span class="text-sm text-gray-900">${p.type_paiement}</span>
                                                    </td>
                                                    <td class="px-4 py-3 whitespace-nowrap">
                                                        ${p.mode_paiement === 'espece' ? 
                                                            '<span class="badge-espece px-2 py-1 rounded-full text-xs">Comptant</span>' : 
                                                            p.mode_paiement === 'a_terme' ? 
                                                            '<span class="badge-a_terme px-2 py-1 rounded-full text-xs">À terme</span>' : 
                                                            '<span class="badge-partiel px-2 py-1 rounded-full text-xs">Partiel</span>'}
                                                    </td>
                                                    <td class="px-4 py-3 whitespace-nowrap">
                                                        <div class="text-sm font-medium ${p.mode_paiement === 'paiement_partiel' ? 'text-blue-600' : 'text-gray-900'}">
                                                            ${parseFloat(p.montant).toFixed(2)} DA
                                                        </div>
                                                    </td>
                                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                                        ${p.numero_cr || '-'}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="pt-4 border-t border-gray-200">
                                    <div class="flex justify-between">
                                        <div class="text-sm text-gray-600">
                                            Total des paiements: <span class="font-bold text-green-600">
                                                ${paiements.reduce((sum, p) => sum + parseFloat(p.montant || 0), 0).toFixed(2)} DA
                                            </span>
                                        </div>
                                        <button onclick="closeModalDetail()" 
                                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
                                            Fermer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;

                        document.getElementById('modalDetailContent').innerHTML = modalContent;
                        document.getElementById('modalDetail').classList.remove('hidden');
                    } else {
                        showToast('Patient non trouvé', 'warning');
                    }
                }
            } catch (error) {
                console.error('Erreur chargement historique:', error);
                showToast('Erreur lors du chargement de l\'historique', 'error');
            }
        }

        async function viewPaymentDetail(paymentId) {
            try {
                const response = await fetch(`${API_BASE_URL}/paiements/${paymentId}`, {
                    headers: { 'X-User-ID': currentUserId }
                });

                if (response.ok) {
                    const payment = await response.json();
                    
                    const modalContent = `
                        <div class="space-y-6">
                            <div class="grid grid-cols-2 gap-6">
                                <div class="p-4 bg-indigo-50 rounded-lg">
                                    <p class="text-sm text-indigo-600">Patient</p>
                                    <p class="text-lg font-semibold">${payment.patient_nom_complet || payment.patient_nom}</p>
                                </div>
                                <div class="p-4 bg-green-50 rounded-lg">
                                    <p class="text-sm text-green-600">Montant</p>
                                    <p class="text-lg font-semibold">${parseFloat(payment.montant).toFixed(2)} DA</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-6">
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <p class="text-sm text-gray-600">Date</p>
                                    <p class="font-medium">${new Date(payment.date_paiement).toLocaleDateString('fr-FR')}</p>
                                </div>
                                <div class="p-4 bg-purple-50 rounded-lg">
                                    <p class="text-sm text-purple-600">Type</p>
                                    <p class="font-medium">${payment.type_paiement}</p>
                                </div>
                            </div>
                            
                            ${payment.mode_paiement === 'a_terme' && payment.montant_total ? `
                                <div class="p-4 bg-orange-50 rounded-lg">
                                    <p class="text-sm text-orange-600">Paiement à terme</p>
                                    <div class="mt-2 space-y-2">
                                        <div class="flex justify-between">
                                            <span>Montant total:</span>
                                            <span class="font-bold">${parseFloat(payment.montant_total).toFixed(2)} DA</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Montant payé:</span>
                                            <span class="font-bold text-green-600">${parseFloat(payment.montant).toFixed(2)} DA</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Reste à payer:</span>
                                            <span class="font-bold text-red-600">${(parseFloat(payment.montant_total) - parseFloat(payment.montant)).toFixed(2)} DA</span>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${payment.notes ? `
                                <div class="p-4 bg-blue-50 rounded-lg">
                                    <p class="text-sm text-blue-600">Notes</p>
                                    <p class="mt-2 text-gray-700">${payment.notes}</p>
                                </div>
                            ` : ''}
                            
                            <div class="pt-4 border-t border-gray-200 flex justify-end space-x-3">
                                <button onclick="printReceipt(${payment.id})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                                    <i class="fas fa-print mr-2"></i>Imprimer reçu
                                </button>
                                <button onclick="closeModalDetail()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
                                    Fermer
                                </button>
                            </div>
                        </div>
                    `;

                    document.getElementById('modalDetailContent').innerHTML = modalContent;
                    document.getElementById('modalDetail').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erreur chargement détail:', error);
                showToast('Erreur lors du chargement du détail', 'error');
            }
        }

        function closeModalDetail() {
            document.getElementById('modalDetail').classList.add('hidden');
        }

        function payerDette(patientId) {
            const patient = allPatients.find(p => p.id == patientId);
            if (patient) {
                document.getElementById('patientSelect').value = patientId;
                document.querySelector('input[value="paiement_partiel"]').checked = true;
                toggleMontantTotal();
                updatePatientInfo();
                showTab('nouveau');
                
                const dette = Math.abs(parseFloat(patient.solde || 0));
                document.getElementById('montantPaye').value = dette;
                updateRecap();
                
                showToast(`Dette sélectionnée pour ${patient.nom}: ${dette.toFixed(2)} DA`, 'success');
            }
        }

        async function deletePayment(paymentId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce paiement ? Cette action est irréversible.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/paiements/${paymentId}`, {
                    method: 'DELETE',
                    headers: { 'X-User-ID': currentUserId }
                });

                if (response.ok) {
                    showToast('Paiement supprimé avec succès', 'success');
                    loadDashboardData();
                    loadPaiements();
                    loadDettes();
                } else {
                    throw new Error('Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur suppression paiement:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        function printReceipt(paymentId) {
            // Implémentez la génération du reçu ici
            showToast('Fonctionnalité d\'impression en développement', 'warning');
        }

        function exporterExcel() {
            // Implémentez l'export Excel ici
            showToast('Fonctionnalité d\'export Excel en développement', 'warning');
        }

        function imprimerListe() {
            // Implémentez l'impression de la liste ici
            showToast('Fonctionnalité d\'impression en développement', 'warning');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            toast.className = `toast ${type}`;
            icon.className = `fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-check-circle'} mr-2`;
            msg.textContent = message;

            toast.classList.add('show');
            toast.classList.remove('hide');

            setTimeout(() => {
                toast.classList.add('hide');
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
